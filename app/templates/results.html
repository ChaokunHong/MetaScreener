{% extends "base.html" %}

{% block title %}Screening Results - {{ filename }}{% endblock %}

{% block extra_head %}
<style>
    /* .container-fluid in base.html is .container, adjust if full width is strictly needed */
    .container { max-width: 1200px; } /* Consistent with test_results.html */
    .abstract-text { font-size: 0.85rem; max-height: 150px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #eee; margin-top:5px;}
    .ai-reasoning { font-size: 0.8rem; color: #555; white-space: pre-wrap; }
    .table th, .table td { vertical-align: middle; font-size: 0.9rem;}
    .badge-include, .log-decision-INCLUDE { background-color: #28a745; color: white; }
    .badge-exclude, .log-decision-EXCLUDE { background-color: #dc3545; color: white; }
    .badge-maybe, .log-decision-MAYBE { background-color: #ffc107; color: black; } /* Ensure MAYBE is visible */
    .badge-error, .log-decision-ERROR { background-color: #6c757d; color: white; }
    .table-responsive { max-height: calc(100vh - 250px); overflow-y: auto; } /* Consistent with test_results.html */
    .table thead th { position: sticky; top: 0; background-color: #343a40; color: white; z-index: 1;}
</style>
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Screening Results: {{ filename }}</h1>
        <a href="{{ url_for('screening_actions_page') }}" class="btn btn-secondary btn-sm">Back to Screening Actions</a>
    </div>

    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    {% if results %}
        <!-- ADDED: Display filter information -->
        {% if filter_applied and filter_applied != 'all entries' %}
            <p class="mb-1 text-muted font-italic small">Filter applied: {{ filter_applied }}</p>
        {% endif %}
        <!-- END ADDED -->
        <p class="mb-2">Screened {{ results|length }} entries.</p>

        {# --- ADDED: Download Section --- #}
        <div class="mb-3 d-flex align-items-center">
             <label for="downloadFormat" class="mr-2 mb-0">Download format:</label>
             <select id="downloadFormat" class="form-control form-control-sm mr-2" style="width: 150px;">
                 <option value="csv">CSV</option>
                 <option value="xlsx">Excel (.xlsx)</option>
                 <option value="json">JSON</option>
             </select>
             {# Button will trigger download via JS or direct link #}
             <button id="downloadButton" class="btn btn-primary btn-sm">Download Results</button>
             {# Hidden input to store screening_id passed from backend #}
             <input type="hidden" id="screening-id-holder" value="{{ screening_id if screening_id else '' }}">
        </div>
        {# --- End Download Section --- #}

        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>#</th>
                        <th>Title & Authors</th>
                        <th>Abstract</th>
                        <th>AI Decision & Reasoning</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in results %}
                    <tr>
                        <td>{{ result.index if result.index else loop.index }}</td>
                        <td>
                            <strong>{{ result.title }}</strong><br>
                            <small>{{ result.authors }}</small>
                        </td>
                        <td>
                            {% if result.abstract and result.abstract != "Abstract is missing or empty." and result.decision != "NO_ABSTRACT" %}
                                <details>
                                    <summary class="text-primary" style="cursor:pointer; font-size:0.85em;">Show/Hide Abstract</summary>
                                    <div class="abstract-text">{{ result.abstract }}</div>
                                </details>
                            {% else %}
                                <em class="text-muted small">No abstract or not applicable.</em>
                            {% endif %}
                        </td>
                        <td>
                            {% if result.decision == 'INCLUDE' %}<span class="badge badge-include">INCLUDE</span>
                            {% elif result.decision == 'EXCLUDE' %}<span class="badge badge-exclude">EXCLUDE</span>
                            {% elif result.decision == 'MAYBE' %}<span class="badge badge-maybe">MAYBE</span>
                            {% else %}<span class="badge badge-error">{{ result.decision | upper if result.decision else 'ERROR' }}</span>
                            {% endif %}
                            <p class="ai-reasoning mt-1">{{ result.reasoning }}</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-info mt-3">No results to display. The file might have been empty or an error occurred.</div>
    {% endif %}
    <a href="{{ url_for('index') }}" class="btn btn-secondary mt-3">Back to Main Page</a>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const downloadButton = document.getElementById('downloadButton');
    const downloadFormatSelect = document.getElementById('downloadFormat');
    const screeningIdHolder = document.getElementById('screening-id-holder');

    if (downloadButton && downloadFormatSelect && screeningIdHolder) {
        downloadButton.addEventListener('click', function() {
            const format = downloadFormatSelect.value;
            const screeningId = screeningIdHolder.value;

            if (!screeningId) {
                alert('Error: Cannot generate download link (missing screening ID).');
                return;
            }
            if (!format) {
                 alert('Please select a download format.');
                 return;
            }

            // Construct the download URL
            // We need a placeholder in the base URL that JS can replace
            let baseUrl = "{{ url_for('download_results', screening_id='__ID__', format='__FORMAT__') }}";
            let downloadUrl = baseUrl.replace('__ID__', screeningId).replace('__FORMAT__', format);

            // Initiate download by navigating to the URL
            window.location.href = downloadUrl;
        });
    }
});
</script>
{% endblock %}