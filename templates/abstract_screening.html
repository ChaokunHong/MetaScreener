{% extends "base.html" %}

{% block title %}Abstract Screening Actions - AI Literature Screening Assistant{% endblock %}

{% block extra_head %}
<style>
    .input-group-append .btn {
        padding-top: 0.25rem; /* Align clear button better */
        padding-bottom: 0.25rem;
    }
    .clear-input-btn {
        font-size: 0.8em;
        line-height: 1;
        opacity: 0.6;
    }
    .clear-input-btn:hover {
        opacity: 1;
    }
    
    /* 决定结果的颜色样式 */
    .log-decision-INCLUDE {
        color: green;
        font-weight: bold;
    }
    .log-decision-EXCLUDE {
        color: red;
        font-weight: bold;
    }
    .log-decision-MAYBE {
        color: orange;
        font-weight: bold;
    }
    .log-decision-ERROR, .log-decision-API_ERROR, .log-decision-PROCESSING_ERROR, 
    .log-decision-PROMPT_ERROR, .log-decision-TEXT_EXTRACT_ERROR, .log-decision-FILE_PROCESSING_ERROR,
    .log-decision-TIMEOUT_ERROR, .log-decision-ITEM_ERROR, .log-decision-LOOP_ERROR {
        color: #a94442;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
{# --- Test Screening Section --- #}
<div class="section-card">
    <h2>Test Screening (Sampled Abstracts)</h2>
    <p>Upload a .ris file to screen a sample of abstracts with progress updates. Compare AI decisions and view metrics.</p>
    <form id="test_screen_form" enctype="multipart/form-data"> 
        <div class="form-row">
            <div class="form-group col-md-5">
                <label for="test_file">Upload RIS File:</label>
                <input type="file" name="file" id="test_file" class="form-control-file form-control-sm" required accept=".ris">
            </div>
            <div class="form-group col-md-2">
                <label for="sample_size">Sample Size:</label> 
                <input type="number" name="sample_size" id="sample_size" class="form-control form-control-sm" value="10" min="5" max="9999">
            </div>
        </div>
        <!-- NEW FILTER FIELDS for Test Screening -->
        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="test_title_text_filter">Filter by Title (Optional):</label>
                <div class="input-group input-group-sm">
                    <input type="text" id="test_title_text_filter" name="title_text_filter" class="form-control form-control-sm" placeholder="Enter keywords from title">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary clear-input-btn" type="button" onclick="clearInput('test_title_text_filter')">&times;</button>
                    </div>
                </div>
            </div>
            <div class="form-group col-md-6">
                <label for="test_line_range_filter">Filter by Line Numbers (Optional, 1-based):</label>
                <div class="input-group input-group-sm">
                    <input type="text" id="test_line_range_filter" name="line_range_filter" class="form-control form-control-sm" placeholder="e.g., 5-10, 7, 1-20, 50-">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary clear-input-btn" type="button" onclick="clearInput('test_line_range_filter')">&times;</button>
                    </div>
                </div>
            </div>
        </div>
        <small class="form-text text-muted mb-2">Filters are applied *before* sampling. If both title and line numbers are filled, title filter takes precedence.</small>
        <!-- END NEW FILTER FIELDS for Test Screening -->

        <button id="start_test_screen_button" type="button" class="btn btn-info btn-sm">
            <span id="test_spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
            Start Test Screening with Progress
        </button>
    </form>
    {# RESTORED: Detailed HTML for Test progress area #}
    <div id="test_progress_area" class="mt-3" style="display: none;">
        <h4>Test Screening Progress:</h4>
        <div class="progress mb-2">
            <div id="test_progress_bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <p id="test_progress_status" class="mt-1 small text-muted"></p>
        <div id="test_progress_log_container" style="display:none;">
            <strong>Live Log (Test):</strong>
            <div id="test_progress_log" style="max-height: 100px; overflow-y: auto; font-size: 0.8em; background-color: #f0f0f0; padding: 8px; border: 1px solid #ccc; margin-top:8px; border-radius: 4px; white-space: pre-line;"></div>
        </div>
    </div>
     <div id="test_results_link_area" class="mt-3" style="display:none;">
        <a href="#" id="view_test_results_link" class="btn btn-primary">View Test Results & Assess</a>
    </div>
</div>

{# --- Full Dataset (Abstracts) Screening Section --- #}
<div class="section-card">
    <h2>Screen Full Dataset (Abstracts)</h2>
    <p>Upload your .ris file to screen all entries based on abstracts using the current settings. Progress is displayed live.</p>
    <form id="full_screen_form_id" enctype="multipart/form-data">
        <div class="form-group">
            <label for="full_file_progress">Upload RIS File:</label>
            <input type="file" name="file" id="full_file_progress" class="form-control-file form-control-sm" required accept=".ris">
        </div>

        <!-- NEW FILTER FIELDS -->
        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="title_text_filter">Filter by Title (Optional):</label>
                <div class="input-group input-group-sm">
                    <input type="text" id="title_text_filter" name="title_text_filter" class="form-control form-control-sm" placeholder="Enter keywords from title">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary clear-input-btn" type="button" onclick="clearInput('title_text_filter')">&times;</button>
                    </div>
                </div>
            </div>
            <div class="form-group col-md-6">
                <label for="line_range_filter">Filter by Line Numbers (Optional, 1-based):</label>
                <div class="input-group input-group-sm">
                    <input type="text" id="line_range_filter" name="line_range_filter" class="form-control form-control-sm" placeholder="e.g., 5-10, 7, 1-20, 50-">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary clear-input-btn" type="button" onclick="clearInput('line_range_filter')">&times;</button>
                    </div>
                </div>
            </div>
        </div>
        <small class="form-text text-muted mb-2">If both title and line numbers are filled, title filter will take precedence.</small>
        <!-- END NEW FILTER FIELDS -->

        <button type="button" id="start_full_screen_button" class="btn btn-primary btn-sm">
            <span id="full_spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
            Screen Full File with Progress (SSE)
        </button>
    </form>
    {# RESTORED: Detailed HTML for Full progress area #}
     <div id="progress_area" class="mt-3" style="display: none;">
        <h4>Screening Progress:</h4>
        <div class="progress mb-2">
            <div id="progress_bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <p id="progress_status" class="mt-1 small text-muted"></p>
        <div id="progress_log_container" style="display:none;">
            <strong>Live Log (last few items):</strong>
            <div id="progress_log" style="max-height: 150px; overflow-y: auto; font-size: 0.8em; background-color: #f0f0f0; padding: 8px; border: 1px solid #ccc; margin-top:8px; border-radius: 4px; white-space: pre-line;"></div> {# Note: ID is progress_log #}
        </div>
    </div>
     <div id="sse_results_link_area" class="mt-3" style="display:none;">
        <a href="#" id="view_full_results_link" class="btn btn-success">View Full Results from SSE Screening</a> 
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Define MAX log items globally in the script block
const MAX_TEST_LOG_ITEMS = 5;
const MAX_FULL_LOG_ITEMS = 7;
const INIT_TIMEOUT_MS = 15000; // 15 seconds timeout for initialization phase

const RESULTS_HISTORY_KEY = 'metaScreenerResultsHistory';
const MAX_RESULTS_HISTORY_ITEMS = 15; // Max number of history items to keep

// --- Helper Functions (Refined - Get element inside) ---
function addTestLogItem(message) {
    const logEl = document.getElementById('test_progress_log'); 
    if(logEl) {
        // 优化：使用requestAnimationFrame确保DOM更新高效
        requestAnimationFrame(() => {
            const div = document.createElement('div');
            div.innerHTML = message;
            // 只保留指定数量的最新日志
            while (logEl.children.length >= MAX_TEST_LOG_ITEMS) { 
                logEl.removeChild(logEl.firstChild); 
            }
            logEl.appendChild(div);
            // 使用scrollIntoView代替scrollTop，确保滚动更流畅
            div.scrollIntoView({ behavior: 'smooth', block: 'end' });
        });
    } else {
        if (!window.loggedTestLogError) { console.error('!!! testProgressLog element NOT found in addTestLogItem'); window.loggedTestLogError = true; }
    }
}

function addLogItem(message) {
    const logEl = document.getElementById('progress_log'); 
     if(logEl) {
        // 优化：使用requestAnimationFrame确保DOM更新高效
        requestAnimationFrame(() => {
            const div = document.createElement('div');
            div.innerHTML = message;
            // 只保留指定数量的最新日志
            while (logEl.children.length >= MAX_FULL_LOG_ITEMS) { 
                logEl.removeChild(logEl.firstChild); 
            }
            logEl.appendChild(div);
            // 使用scrollIntoView代替scrollTop，确保滚动更流畅
            div.scrollIntoView({ behavior: 'smooth', block: 'end' });
        });
    } else {
        if (!window.loggedFullLogError) { console.error('!!! progressLog element NOT found in addLogItem'); window.loggedFullLogError = true; }
    }
}

// --- Finalize Button Functions --- 
function finalizeTestButton() { 
    const btn = document.getElementById('start_test_screen_button'); 
    if(btn) btn.disabled = false; 
    const spin = document.getElementById('test_spinner'); 
    if(spin) spin.style.display = 'none'; 
}

function finalizeFullButton() {
    const btn = document.getElementById('start_full_screen_button'); 
    if(btn) btn.disabled = false; 
    const spin = document.getElementById('full_spinner'); 
    if(spin) spin.style.display = 'none';
}

function finalizeButtons() { 
    finalizeFullButton();
    // finalizeTestButton(); // Maybe call this too if test button might also be disabled?
}

function clearInput(inputId) {
    const inputElement = document.getElementById(inputId);
    if (inputElement) {
        inputElement.value = '';
    }
}

function saveScreeningResultToHistory(screeningType, screeningId, fileName, totalItems, risContentForFilename) {
    if (!screeningId) {
        console.error("Screening ID is missing, cannot save to history.");
        return;
    }

    let history = JSON.parse(localStorage.getItem(RESULTS_HISTORY_KEY) || '[]');

    // Attempt to get a more reliable filename if 'fileName' is not directly available
    let actualFileName = fileName;
    if (!actualFileName && risContentForFilename) {
        // Basic extraction, assuming filename might be in a comment or specific field
        // This is a heuristic and might need refinement based on actual RIS format
        const match = risContentForFilename.match(/FN - (.*)/) || risContentForFilename.match(/DB - (.*)/) ;
        if (match && match[1]) {
            actualFileName = match[1].trim() + ".ris"; // Assuming .ris if extracted from content
        } else {
            actualFileName = "Unknown File";
        }
    } else if (!actualFileName) {
        actualFileName = "Unknown File";
    }


    const now = new Date();
    const timestamp = now.toISOString();
    const historyEntryName = `${screeningType} - ${actualFileName} (${totalItems} items) - ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;

    const newEntry = {
        id: screeningId,
        name: historyEntryName,
        type: screeningType,
        fileName: actualFileName,
        totalItems: totalItems,
        timestamp: timestamp,
        screeningId: screeningId // Redundant but keeps structure similar to criteria history if needed
    };

    // Add new entry to the beginning
    history.unshift(newEntry);

    // Limit history size
    if (history.length > MAX_RESULTS_HISTORY_ITEMS) {
        history = history.slice(0, MAX_RESULTS_HISTORY_ITEMS);
    }

    localStorage.setItem(RESULTS_HISTORY_KEY, JSON.stringify(history));
    console.log("Saved screening result to history:", newEntry);
}

document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM loaded. Finding trigger elements...");
    const startTestScreenButton = document.getElementById('start_test_screen_button');
    const startFullScreenButton = document.getElementById('start_full_screen_button');
    console.log("Buttons found:", { startTestScreenButton, startFullScreenButton });
    window.loggedTestLogError = false; // Reset log error flags on load
    window.loggedFullLogError = false;

    // --- Test Screening SSE Logic --- 
    if (startTestScreenButton) {
        startTestScreenButton.addEventListener('click', function() {
            console.log("Test Screen Button CLICKED!");
            const testFileInput = document.getElementById('test_file');
            const sampleSizeInput = document.getElementById('sample_size');
            const testTitleFilterInput = document.getElementById('test_title_text_filter');
            const testLineRangeInput = document.getElementById('test_line_range_filter');

            if (!testFileInput.files || testFileInput.files.length === 0) { alert('Please select a file for test screening.'); return; }
            const sampleSize = sampleSizeInput.value || 10;
            console.log(`Test Screening initiated. Sample size: ${sampleSize}`);

            // Reset UI
            const testProgressArea = document.getElementById('test_progress_area');
            const testProgressBar = document.getElementById('test_progress_bar');
            const testProgressStatus = document.getElementById('test_progress_status');
            const testProgressLogContainer = document.getElementById('test_progress_log_container');
            const testResultsLinkArea = document.getElementById('test_results_link_area');
            const testSpinner = document.getElementById('test_spinner');
            
            if(testProgressArea) testProgressArea.style.display = 'block';
            if(testProgressLogContainer) testProgressLogContainer.style.display = 'block';
            if(testSpinner) testSpinner.style.display = 'inline-block';
            
            // Clear logs
            const initialLogEl = document.getElementById('test_progress_log'); 
            if(initialLogEl) initialLogEl.innerHTML = '';
            
            if(testProgressBar) { 
                testProgressBar.style.width = '0%'; 
                testProgressBar.textContent = '0%'; 
                testProgressBar.classList.remove('bg-success', 'bg-danger'); 
                testProgressBar.classList.add('bg-info'); 
            }
            
            if(testProgressStatus) {
                testProgressStatus.textContent = 'Initializing test screening...';
                testProgressStatus.dataset.status = 'initializing';
            }
            
            if(testResultsLinkArea) testResultsLinkArea.style.display = 'none';
            startTestScreenButton.disabled = true;
            window.loggedTestLogError = false;

            // Simplified initialization timer
            let initTimer = null;
            let dots = '';
            
            initTimer = setInterval(() => {
                if (testProgressStatus && testProgressStatus.dataset.status === 'initializing') {
                    dots = dots.length >= 3 ? '' : dots + '.';
                    testProgressStatus.textContent = `Initializing test screening${dots}`;
                    
                    // Avoid frequent log updates
                    if (Math.floor(Math.random() * 5) === 0) { // Only 20% chance to add log
                        addTestLogItem(`[${new Date().toLocaleTimeString()}] File upload and processing in progress, please wait...`);
                    }
                } else {
                    clearInterval(initTimer);
                    initTimer = null;
                }
            }, 500);

            const formData = new FormData(); 
            formData.append('file', testFileInput.files[0]); 
            formData.append('sample_size', sampleSize);
            
            if (testTitleFilterInput && testTitleFilterInput.value) {
                formData.append('title_text_filter', testTitleFilterInput.value.trim());
            }
            if (testLineRangeInput && testLineRangeInput.value) {
                formData.append('line_range_filter', testLineRangeInput.value.trim());
            }

            const xhrTest = new XMLHttpRequest(); 
            console.log("Initiating Test XHR Request...");
            xhrTest.open("POST", "{{ url_for('stream_test_screen_file') }}", true);
            let lastTestCharIndex = 0;

            xhrTest.onprogress = function() {
                const newText = xhrTest.responseText.substring(lastTestCharIndex);
                lastTestCharIndex = xhrTest.responseText.length;
                if (!newText) return; // If no new content, return directly
                
                // 优化：使用requestAnimationFrame确保UI更新高效
                requestAnimationFrame(() => {
                    const messages = newText.split('\n\n');
                    for (const message of messages) {
                        if (message.startsWith("data: ")) {
                            try {
                                const jsonData = JSON.parse(message.substring(6));
                                
                                // Get needed DOM elements
                                const currentTestBar = document.getElementById('test_progress_bar');
                                const currentTestStatus = document.getElementById('test_progress_status');
                                const currentTestLinkArea = document.getElementById('test_results_link_area');
                                const currentTestLink = document.getElementById('view_test_results_link');

                                // Process event types
                                switch (jsonData.type) {
                                    case 'init':
                                        // Initialization event
                                        if(currentTestStatus) {
                                            currentTestStatus.textContent = jsonData.message || 'Processing upload, please wait...';
                                        }
                                        break;
                                    
                                    case 'start':
                                        // Clear initialization timer
                                        if (initTimer) {
                                            clearInterval(initTimer);
                                            initTimer = null;
                                        }
                                        
                                        if(currentTestStatus) {
                                            currentTestStatus.dataset.status = 'processing';
                                            currentTestStatus.textContent = 'Starting test screening...';
                                        }
                                        
                                        if(currentTestBar) { 
                                            currentTestBar.style.width = '0%'; 
                                            currentTestBar.textContent = '0%'; 
                                        }
                                        
                                        addTestLogItem(`[${new Date().toLocaleTimeString()}] Starting to screen ${jsonData.total} sampled entries.`);
                                        console.log(`Test screening started: ${jsonData.total} entries...`);
                                        break;
                                    
                                    case 'progress':
                                        if(currentTestBar) {
                                            const percentComplete = jsonData.percentage || Math.floor((jsonData.count / jsonData.total) * 100);
                                            currentTestBar.style.width = `${percentComplete}%`;
                                            currentTestBar.textContent = `${percentComplete}%`;
                                        }
                                        
                                        if(currentTestStatus) {
                                            currentTestStatus.textContent = `Screening ${jsonData.count} / ${jsonData.total}. Current: ${jsonData.current_item_title}`;
                                        }
                                        
                                        if (jsonData.decision) {
                                            let decisionClass = "";
                                            if(jsonData.decision === "INCLUDE") decisionClass = "include";
                                            else if(jsonData.decision === "EXCLUDE") decisionClass = "exclude";
                                            else if(jsonData.decision === "MAYBE") decisionClass = "maybe";
                                            else decisionClass = "error";
                                            
                                            // 序列号、标题、决定结果(带颜色)的统一格式
                                            const logMessage = `[${jsonData.count}] ${jsonData.current_item_title} - <span class="log-decision-${jsonData.decision}">${jsonData.decision}</span>`;
                                            addTestLogItem(logMessage);
                                        }
                                        break;
                                    
                                    case 'status':
                                        // 添加状态更新处理
                                        if(currentTestStatus && jsonData.message) {
                                            currentTestStatus.textContent = jsonData.message;
                                        }
                                        break;
                                    
                                    case 'complete':
                                        if(currentTestBar) { 
                                            currentTestBar.classList.add('bg-success'); 
                                            currentTestBar.textContent = "Complete"; 
                                        }
                                        
                                        if(currentTestStatus) {
                                            currentTestStatus.textContent = jsonData.message || 'Test screening complete.';
                                        }
                                        
                                        addTestLogItem(`[${new Date().toLocaleTimeString()}] ${jsonData.message || 'Test screening complete.'}`);
                                        
                                        if (jsonData.session_id && currentTestLink && currentTestLinkArea) {
                                            let baseUrl = "{{ url_for('show_test_results', session_id='__SESSION_ID__') }}";
                                            currentTestLink.href = baseUrl.replace('__SESSION_ID__', jsonData.session_id);
                                            currentTestLinkArea.style.display = 'block';
                                        }
                                        
                                        try { xhrTest.abort(); } catch (e) { console.warn("Error aborting test XHR:", e); }
                                        finalizeTestButton();
                                        saveScreeningResultToHistory('Test Abstract Screening', jsonData.session_id, jsonData.filename, jsonData.total, jsonData.ris_content);
                                        break;
                                    
                                    case 'error':
                                        // Clear initialization timer
                                        if (initTimer) {
                                            clearInterval(initTimer);
                                            initTimer = null;
                                        }
                                        
                                        if(currentTestBar) { 
                                            currentTestBar.classList.add('bg-danger'); 
                                            currentTestBar.textContent = "Error"; 
                                        }
                                        
                                        if(currentTestStatus) {
                                            currentTestStatus.textContent = `Error: ${jsonData.message}`;
                                        }
                                        
                                        let testErrorMessage = `[${new Date().toLocaleTimeString()}] Error: ${jsonData.message}`;
                                        if (jsonData.needs_config) {
                                            const configUrl = "{{ url_for('llm_config_page') }}";
                                            testErrorMessage += ` <a href="${configUrl}" target="_blank">Please configure API Key.</a>`;
                                        }
                                        
                                        addTestLogItem(testErrorMessage);
                                        try { xhrTest.abort(); } catch (e) { console.warn("Error aborting test XHR:", e); }
                                        finalizeTestButton();
                                        break;
                                }
                                
                            } catch (e) { 
                                console.error("Test SSE parse error:", e, "Original message:", message); 
                                finalizeTestButton();
                            } 
                        }
                    }
                });
            }; 
            
            xhrTest.onloadend = function() { 
                // Clear initialization timer
                if (initTimer) {
                    clearInterval(initTimer);
                    initTimer = null;
                }
                
                const currentTestLinkArea = document.getElementById('test_results_link_area');
                const currentTestLink = document.getElementById('view_test_results_link');
                
                if (xhrTest.responseText && xhrTest.responseText.includes('"session_id"') && 
                    currentTestLinkArea && currentTestLinkArea.style.display === 'none') {
                    try {
                        const match = xhrTest.responseText.match(/"session_id":"([^"]+)"/);
                        if (match && match[1] && currentTestLink) {
                            let baseUrl = "{{ url_for('show_test_results', session_id='__SESSION_ID__') }}";
                            currentTestLink.href = baseUrl.replace('__SESSION_ID__', match[1]);
                            currentTestLinkArea.style.display = 'block';
                        }
                    } catch (e) {
                        console.error("Error setting up test results link in onloadend:", e);
                    }
                }
                
                finalizeTestButton(); 
            }; 
            
            xhrTest.onerror = function() { 
                // Clear initialization timer
                if (initTimer) {
                    clearInterval(initTimer);
                    initTimer = null;
                }
                
                addTestLogItem(`[${new Date().toLocaleTimeString()}] Network error occurred during test screening.`);
                finalizeTestButton(); 
            }; 
            
            xhrTest.send(formData);
        }); 
    }

    // --- Full Screening SSE Logic ---
    if (startFullScreenButton) {
        startFullScreenButton.addEventListener('click', function() {
             console.log(">>> Full Screen Button CLICKED!");
             const fileInput = document.getElementById('full_file_progress');
             if (!fileInput || !fileInput.files || fileInput.files.length === 0) { alert('Please select file...'); return; }
             console.log("Full screening initiated.");
             
             // Reset UI
             const progressArea = document.getElementById('progress_area');
             const progressLogContainer = document.getElementById('progress_log_container');
             const progressBar = document.getElementById('progress_bar');
             const progressStatus = document.getElementById('progress_status');
             const sseResultsLinkArea = document.getElementById('sse_results_link_area');
             
             if(progressArea) progressArea.style.display = 'block';
             if(progressLogContainer) progressLogContainer.style.display = 'block';
             
             // Clear logs
             const initialFullLogEl = document.getElementById('progress_log'); 
             if(initialFullLogEl) initialFullLogEl.innerHTML = '';

             if(progressBar) {
                 progressBar.style.width = '0%'; 
                 progressBar.textContent = '0%'; 
                 progressBar.classList.remove('bg-success','bg-danger');
             }
             
             if(progressStatus) {
                 progressStatus.textContent = 'Initializing...';
                 progressStatus.dataset.status = 'initializing';
             }
             
             if(sseResultsLinkArea) sseResultsLinkArea.style.display = 'none';
             startFullScreenButton.disabled = true;
             const fullSpinner = document.getElementById('full_spinner');
             if(fullSpinner) fullSpinner.style.display = 'inline-block';
             window.loggedFullLogError = false; 
             
             // Simplified initialization timer
             let initTimer = null;
             let dots = '';
             
             initTimer = setInterval(() => {
                 if (progressStatus && progressStatus.dataset.status === 'initializing') {
                     dots = dots.length >= 3 ? '' : dots + '.';
                     progressStatus.textContent = `Initializing${dots}`;
                     
                     // Avoid frequent log updates
                     if (Math.floor(Math.random() * 5) === 0) { // Only 20% chance to add log
                         addLogItem(`[${new Date().toLocaleTimeString()}] File upload and processing in progress, please wait...`);
                     }
                 } else {
                     clearInterval(initTimer);
                     initTimer = null;
                 }
             }, 500);
             
             const formData = new FormData(); 
             formData.append('file', fileInput.files[0]);
             const titleFilterInput = document.getElementById('title_text_filter');
             const lineRangeInput = document.getElementById('line_range_filter');
             
             if (titleFilterInput && titleFilterInput.value) {
                 formData.append('title_text_filter', titleFilterInput.value.trim());
             }
             
             if (lineRangeInput && lineRangeInput.value) {
                 formData.append('line_range_filter', lineRangeInput.value.trim());
             }

             const xhr = new XMLHttpRequest(); 
             console.log("Initiating Full XHR Request...");
             xhr.open("POST", "{{ url_for('stream_screen_file') }}", true);
             let lastCharIndex = 0;
             
             xhr.onprogress = function() {
                 const newText = xhr.responseText.substring(lastCharIndex);
                 lastCharIndex = xhr.responseText.length;
                 if (!newText) return; // If no new content, return directly
                 
                 // 优化：使用requestAnimationFrame确保UI更新高效
                 requestAnimationFrame(() => {
                     const messages = newText.split('\n\n');
                     for (const message of messages) {
                         if (message.startsWith("data: ")) {
                             try {
                                 const jsonData = JSON.parse(message.substring(6));
                                 
                                 // Get needed DOM elements
                                 const currentFullBar = document.getElementById('progress_bar');
                                 const currentFullStatus = document.getElementById('progress_status');
                                 const currentFullLinkArea = document.getElementById('sse_results_link_area');
                                 const currentFullLink = document.getElementById('view_full_results_link');
                                 
                                 // Process event types
                                 switch (jsonData.type) {
                                     case 'init':
                                         // Initialization event
                                         if(currentFullStatus) {
                                             currentFullStatus.textContent = jsonData.message || 'Processing upload, please wait...';
                                         }
                                         break;
                                     
                                     case 'start':
                                         // Clear initialization timer
                                         if (initTimer) {
                                             clearInterval(initTimer);
                                             initTimer = null;
                                         }
                                         
                                         if(currentFullStatus) {
                                             currentFullStatus.dataset.status = 'processing';
                                             currentFullStatus.textContent = 'Starting full screening...';
                                         }
                                         
                                         if(currentFullBar) { 
                                             currentFullBar.style.width = '0%'; 
                                             currentFullBar.textContent = '0%'; 
                                         }
                                         
                                         addLogItem(`[${new Date().toLocaleTimeString()}] Starting to screen ${jsonData.total} items.`);
                                         break;
                                     
                                     case 'progress':
                                         if(currentFullBar) {
                                             const percentComplete = jsonData.percentage || Math.floor((jsonData.count / jsonData.total) * 100);
                                             currentFullBar.style.width = `${percentComplete}%`;
                                             currentFullBar.textContent = `${percentComplete}%`;
                                         }
                                         
                                         if(currentFullStatus) {
                                             currentFullStatus.textContent = `Screening ${jsonData.count} / ${jsonData.total}. Current: ${jsonData.current_item_title}`;
                                         }
                                         
                                         // Only add log items if decision is known (skip preparatory events)
                                         if (jsonData.decision) {
                                             let decisionClass = "";
                                             if(jsonData.decision === "INCLUDE") decisionClass = "include";
                                             else if(jsonData.decision === "EXCLUDE") decisionClass = "exclude";
                                             else if(jsonData.decision === "MAYBE") decisionClass = "maybe";
                                             else decisionClass = "error";
                                             
                                             // 序列号、标题、决定结果(带颜色)的统一格式
                                             const logMessage = `[${jsonData.count}] ${jsonData.current_item_title} - <span class="log-decision-${jsonData.decision}">${jsonData.decision}</span>`;
                                             addLogItem(logMessage);
                                         }
                                         break;
                                     
                                     case 'status':
                                         // 添加状态更新处理
                                         if(currentFullStatus && jsonData.message) {
                                             currentFullStatus.textContent = jsonData.message;
                                         }
                                         break;
                                     
                                     case 'complete':
                                         if(currentFullBar) { 
                                             currentFullBar.classList.add('bg-success'); 
                                             currentFullBar.textContent = "Complete"; 
                                         }
                                         
                                         if(currentFullStatus) {
                                             currentFullStatus.textContent = jsonData.message || 'Full screening complete.';
                                         }
                                         
                                         addLogItem(`[${new Date().toLocaleTimeString()}] ${jsonData.message || 'Full screening complete.'}`);
                                         
                                         if (jsonData.screening_id && currentFullLink && currentFullLinkArea) {
                                             let baseUrl = "{{ url_for('show_screening_results', screening_id='__SCREENING_ID__') }}";
                                             currentFullLink.href = baseUrl.replace('__SCREENING_ID__', jsonData.screening_id);
                                             currentFullLinkArea.style.display = 'block';
                                         }
                                         
                                         try { xhr.abort(); } catch (e) { console.warn("Error aborting full screening XHR:", e); }
                                         finalizeButtons();
                                         saveScreeningResultToHistory('Full Abstract Screening', jsonData.screening_id, jsonData.filename, jsonData.total, jsonData.ris_content);
                                         break;
                                     
                                     case 'error':
                                         // Clear initialization timer
                                         if (initTimer) {
                                             clearInterval(initTimer);
                                             initTimer = null;
                                         }
                                         
                                         if(currentFullBar) { 
                                             currentFullBar.classList.add('bg-danger'); 
                                             currentFullBar.textContent = "Error"; 
                                         }
                                         
                                         if(currentFullStatus) {
                                             currentFullStatus.textContent = `Error: ${jsonData.message}`;
                                         }
                                         
                                         let errorMessage = `[${new Date().toLocaleTimeString()}] Error: ${jsonData.message}`;
                                         if (jsonData.needs_config) {
                                             const configUrl = "{{ url_for('llm_config_page') }}";
                                             errorMessage += ` <a href="${configUrl}" target="_blank">Please configure API Key.</a>`;
                                         }
                                         
                                         addLogItem(errorMessage);
                                         try { xhr.abort(); } catch (e) { console.warn("Error aborting full screening XHR:", e); }
                                         finalizeButtons();
                                         break;
                                 }
                                 
                            } catch (e) { 
                                console.error("Full screening SSE parse error:", e, "Original message:", message); 
                                finalizeButtons(); 
                            }
                        }
                     }
                 });
             };
            
             xhr.onloadend = function() { 
                 // Clear initialization timer
                 if (initTimer) {
                     clearInterval(initTimer);
                     initTimer = null;
                 }
                 
                 const currentFullLinkArea = document.getElementById('sse_results_link_area');
                 const currentFullLink = document.getElementById('view_full_results_link');
                 
                 if (xhr.responseText && xhr.responseText.includes('"screening_id"') && 
                     currentFullLinkArea && currentFullLinkArea.style.display === 'none') {
                     try {
                         const match = xhr.responseText.match(/"screening_id":"([^"]+)"/);
                         if (match && match[1] && currentFullLink) {
                             let baseUrl = "{{ url_for('show_screening_results', screening_id='__SCREENING_ID__') }}";
                             currentFullLink.href = baseUrl.replace('__SCREENING_ID__', match[1]);
                             currentFullLinkArea.style.display = 'block';
                         }
                     } catch (e) {
                         console.error("Error setting up full screening results link in onloadend:", e);
                     }
                 }
                 
                 finalizeButtons(); 
             };
            
             xhr.onerror = function() { 
                 // Clear initialization timer
                 if (initTimer) {
                     clearInterval(initTimer);
                     initTimer = null;
                 }
                 
                 addLogItem(`[${new Date().toLocaleTimeString()}] Network error occurred during screening.`);
                 finalizeButtons(); 
             };
             
             xhr.send(formData);
        }); 
    }

}); 
</script>
{% endblock %}