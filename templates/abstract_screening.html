{% extends "base.html" %}

{% block title %}Abstract Screening Actions - AI Literature Screening Assistant{% endblock %}

{% block extra_head %}
<style>
    .input-group-append .btn {
        padding-top: 0.25rem; /* Align clear button better */
        padding-bottom: 0.25rem;
    }
    .clear-input-btn {
        font-size: 0.8em;
        line-height: 1;
        opacity: 0.6;
    }
    .clear-input-btn:hover {
        opacity: 1;
    }
    .history-panel {
        margin-top: 10px;
        padding: 8px 12px;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .history-item {
        padding: 8px;
        margin-bottom: 4px;
        border-bottom: 1px solid #eee;
    }
    .history-item:last-child {
        border-bottom: none;
    }
    .history-item a {
        font-weight: bold;
        text-decoration: underline;
    }
    .history-timestamp {
        font-size: 0.8em;
        color: #666;
        margin-left: 8px;
    }
    .history-title {
        margin-bottom: 8px;
        font-weight: bold;
    }
    .no-history {
        font-style: italic;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
{# --- Add screening history panel --- #}
<div id="screening_history" class="card mb-3">
    <div class="card-header">
        <a class="btn btn-link text-dark p-0" data-toggle="collapse" href="#historyCollapse" role="button">
            <i class="fas fa-history"></i> Recent Screening Sessions <small>(click to expand)</small>
        </a>
    </div>
    <div class="collapse show" id="historyCollapse">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="history-section">
                        <div class="history-title">Full Screening History</div>
                        <div id="full_screening_history_list">
                            <div class="no-history">No recent full screening sessions</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="history-section">
                        <div class="history-title">Test Screening History</div>
                        <div id="test_screening_history_list">
                            <div class="no-history">No recent test screening sessions</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-2">
                <button id="clear_history_btn" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-trash"></i> Clear All History
                </button>
            </div>
        </div>
    </div>
</div>

{# --- Test Screening Section --- #}
<div class="section-card">
    <h2>Test Screening (Sampled Abstracts)</h2>
    <p>Upload a .ris file to screen a sample of abstracts with progress updates. Compare AI decisions and view metrics.</p>
    <form id="test_screen_form" enctype="multipart/form-data"> 
        <div class="form-row">
            <div class="form-group col-md-5">
                <label for="test_file">Upload RIS File:</label>
                <input type="file" name="file" id="test_file" class="form-control-file form-control-sm" required accept=".ris">
            </div>
            <div class="form-group col-md-2">
                <label for="sample_size">Sample Size:</label> 
                <input type="number" name="sample_size" id="sample_size" class="form-control form-control-sm" value="10" min="5" max="9999">
            </div>
        </div>
        <!-- NEW FILTER FIELDS for Test Screening -->
        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="test_title_text_filter">Filter by Title (Optional):</label>
                <div class="input-group input-group-sm">
                    <input type="text" id="test_title_text_filter" name="title_text_filter" class="form-control form-control-sm" placeholder="Enter keywords from title">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary clear-input-btn" type="button" onclick="clearInput('test_title_text_filter')">&times;</button>
                    </div>
                </div>
            </div>
            <div class="form-group col-md-6">
                <label for="test_line_range_filter">Filter by Line Numbers (Optional, 1-based):</label>
                <div class="input-group input-group-sm">
                    <input type="text" id="test_line_range_filter" name="line_range_filter" class="form-control form-control-sm" placeholder="e.g., 5-10, 7, 1-20, 50-">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary clear-input-btn" type="button" onclick="clearInput('test_line_range_filter')">&times;</button>
                    </div>
                </div>
            </div>
        </div>
        <small class="form-text text-muted mb-2">Filters are applied *before* sampling. If both title and line numbers are filled, title filter takes precedence.</small>
        <!-- END NEW FILTER FIELDS for Test Screening -->

        <button id="start_test_screen_button" type="button" class="btn btn-info btn-sm">
            <span id="test_spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
            Start Test Screening with Progress
        </button>
    </form>
    {# RESTORED: Detailed HTML for Test progress area #}
    <div id="test_progress_area" class="mt-3" style="display: none;">
        <h4>Test Screening Progress:</h4>
        <div class="progress mb-2">
            <div id="test_progress_bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <p id="test_progress_status" class="mt-1 small text-muted"></p>
        <div id="test_progress_log_container" style="display:none;">
            <strong>Live Log (Test):</strong>
            <div id="test_progress_log" style="max-height: 100px; overflow-y: auto; font-size: 0.8em; background-color: #f0f0f0; padding: 8px; border: 1px solid #ccc; margin-top:8px; border-radius: 4px; white-space: pre-line;"></div>
        </div>
    </div>
     <div id="test_results_link_area" class="mt-3" style="display:none;">
        <a href="#" id="view_test_results_link" class="btn btn-primary">View Test Results & Assess</a>
    </div>
</div>

{# --- Full Dataset (Abstracts) Screening Section --- #}
<div class="section-card">
    <h2>Screen Full Dataset (Abstracts)</h2>
    <p>Upload your .ris file to screen all entries based on abstracts using the current settings. Progress is displayed live.</p>
    <form id="full_screen_form_id" enctype="multipart/form-data">
        <div class="form-group">
            <label for="full_file_progress">Upload RIS File:</label>
            <input type="file" name="file" id="full_file_progress" class="form-control-file form-control-sm" required accept=".ris">
        </div>

        <!-- NEW FILTER FIELDS -->
        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="title_text_filter">Filter by Title (Optional):</label>
                <div class="input-group input-group-sm">
                    <input type="text" id="title_text_filter" name="title_text_filter" class="form-control form-control-sm" placeholder="Enter keywords from title">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary clear-input-btn" type="button" onclick="clearInput('title_text_filter')">&times;</button>
                    </div>
                </div>
            </div>
            <div class="form-group col-md-6">
                <label for="line_range_filter">Filter by Line Numbers (Optional, 1-based):</label>
                <div class="input-group input-group-sm">
                    <input type="text" id="line_range_filter" name="line_range_filter" class="form-control form-control-sm" placeholder="e.g., 5-10, 7, 1-20, 50-">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary clear-input-btn" type="button" onclick="clearInput('line_range_filter')">&times;</button>
                    </div>
                </div>
            </div>
        </div>
        <small class="form-text text-muted mb-2">If both title and line numbers are filled, title filter will take precedence.</small>
        <!-- END NEW FILTER FIELDS -->

        <button type="button" id="start_full_screen_button" class="btn btn-primary btn-sm">Screen Full File with Progress (SSE)</button>
    </form>
    {# RESTORED: Detailed HTML for Full progress area #}
     <div id="progress_area" class="mt-3" style="display: none;">
        <h4>Screening Progress:</h4>
        <div class="progress mb-2">
            <div id="progress_bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <p id="progress_status" class="mt-1 small text-muted"></p>
        <div id="progress_log_container" style="display:none;">
            <strong>Live Log (last few items):</strong>
            <div id="progress_log" style="max-height: 150px; overflow-y: auto; font-size: 0.8em; background-color: #f0f0f0; padding: 8px; border: 1px solid #ccc; margin-top:8px; border-radius: 4px; white-space: pre-line;"></div> {# Note: ID is progress_log #}
        </div>
    </div>
     <div id="sse_results_link_area" class="mt-3" style="display:none;">
        <a href="#" id="view_full_results_link" class="btn btn-success">View Full Results from SSE Screening</a> 
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Define MAX log items globally in the script block
const MAX_TEST_LOG_ITEMS = 5;
const MAX_FULL_LOG_ITEMS = 7;

// --- Helper Functions (Refined - Get element inside) ---
function addTestLogItem(message) {
    const logEl = document.getElementById('test_progress_log'); 
    if(logEl) {
        const div = document.createElement('div');
        div.innerHTML = message;
        while (logEl.children.length >= MAX_TEST_LOG_ITEMS) { logEl.removeChild(logEl.firstChild); }
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    } else {
        if (!window.loggedTestLogError) { console.error('!!! testProgressLog element NOT found in addTestLogItem'); window.loggedTestLogError = true; }
    }
}

function addLogItem(message) {
    const logEl = document.getElementById('progress_log'); 
     if(logEl) {
        const div = document.createElement('div');
        div.innerHTML = message;
        while (logEl.children.length >= MAX_FULL_LOG_ITEMS) { logEl.removeChild(logEl.firstChild); } // Use correct MAX constant
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    } else {
        if (!window.loggedFullLogError) { console.error('!!! progressLog element NOT found in addLogItem'); window.loggedFullLogError = true; }
    }
}

// --- Finalize Button Functions --- 
function finalizeTestButton() { 
    const btn = document.getElementById('start_test_screen_button'); 
    if(btn) btn.disabled = false; 
    const spin = document.getElementById('test_spinner'); 
    if(spin) spin.style.display = 'none'; 
}

function finalizeButtons() { 
    const btnF = document.getElementById('start_full_screen_button'); 
    if(btnF) btnF.disabled=false; 
    // finalizeTestButton(); // Maybe call this too if test button might also be disabled?
}

function clearInput(inputId) {
    const inputElement = document.getElementById(inputId);
    if (inputElement) {
        inputElement.value = '';
    }
}

// History management functions
const FULL_SCREEN_HISTORY_KEY = 'screen_history_full';
const TEST_SCREEN_HISTORY_KEY = 'screen_history_test';
const MAX_HISTORY_ITEMS = 10;

// Add to history and store complete results
function addToHistory(type, id, filename, resultsData = null) {
    const historyKey = type === 'full' ? FULL_SCREEN_HISTORY_KEY : TEST_SCREEN_HISTORY_KEY;
    let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
    
    // Check if this ID already exists
    const existingIndex = history.findIndex(item => item.id === id);
    if (existingIndex !== -1) {
        // Update timestamp and move to top
        history.splice(existingIndex, 1);
    }
    
    // Add new entry at the beginning
    history.unshift({
        id: id,
        filename: filename || 'Unnamed screening',
        timestamp: new Date().toISOString()
    });
    
    // Keep only the most recent MAX_HISTORY_ITEMS
    if (history.length > MAX_HISTORY_ITEMS) {
        history = history.slice(0, MAX_HISTORY_ITEMS);
    }
    
    localStorage.setItem(historyKey, JSON.stringify(history));
    
    // Store complete results data if provided
    if (resultsData) {
        const resultsKey = type === 'full' ? 'full_screening_results_' + id : 'test_screening_results_' + id;
        localStorage.setItem(resultsKey, JSON.stringify(resultsData));
        console.log(`Stored complete results data for ${type} screening ${id}`);
    }
    
    // Update UI
    refreshHistoryDisplay();
}

// Load and display history
function refreshHistoryDisplay() {
    // Full screening history
    const fullHistoryList = document.getElementById('full_screening_history_list');
    const fullHistory = JSON.parse(localStorage.getItem(FULL_SCREEN_HISTORY_KEY) || '[]');
    
    if (fullHistoryList) {
        if (fullHistory.length === 0) {
            fullHistoryList.innerHTML = '<div class="no-history">No recent full screening sessions</div>';
        } else {
            fullHistoryList.innerHTML = '';
            fullHistory.forEach(item => {
                const timestamp = new Date(item.timestamp);
                const formattedDate = timestamp.toLocaleDateString() + ' ' + timestamp.toLocaleTimeString();
                const baseUrl = "{{ url_for('show_screening_results', screening_id='__SCREENING_ID__') }}";
                const url = baseUrl.replace('__SCREENING_ID__', item.id);
                
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <a href="${url}" class="history-link">${item.filename}</a>
                    <span class="history-timestamp">${formattedDate}</span>
                `;
                fullHistoryList.appendChild(historyItem);
            });
        }
    }
    
    // Test screening history
    const testHistoryList = document.getElementById('test_screening_history_list');
    const testHistory = JSON.parse(localStorage.getItem(TEST_SCREEN_HISTORY_KEY) || '[]');
    
    if (testHistoryList) {
        if (testHistory.length === 0) {
            testHistoryList.innerHTML = '<div class="no-history">No recent test screening sessions</div>';
        } else {
            testHistoryList.innerHTML = '';
            testHistory.forEach(item => {
                const timestamp = new Date(item.timestamp);
                const formattedDate = timestamp.toLocaleDateString() + ' ' + timestamp.toLocaleTimeString();
                const baseUrl = "{{ url_for('show_test_results', session_id='__SESSION_ID__') }}";
                const url = baseUrl.replace('__SESSION_ID__', item.id);
                
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <a href="${url}" class="history-link">${item.filename}</a>
                    <span class="history-timestamp">${formattedDate}</span>
                `;
                testHistoryList.appendChild(historyItem);
            });
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM loaded. Finding trigger elements...");
    const startTestScreenButton = document.getElementById('start_test_screen_button');
    const startFullScreenButton = document.getElementById('start_full_screen_button');
    console.log("Buttons found:", { startTestScreenButton, startFullScreenButton });
    window.loggedTestLogError = false; // Reset log error flags on load
    window.loggedFullLogError = false;
    
    // Load and display screening history
    refreshHistoryDisplay();
    
    // Setup clear history button
    const clearHistoryBtn = document.getElementById('clear_history_btn');
    if (clearHistoryBtn) {
        clearHistoryBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all screening history?')) {
                localStorage.removeItem(FULL_SCREEN_HISTORY_KEY);
                localStorage.removeItem(TEST_SCREEN_HISTORY_KEY);
                refreshHistoryDisplay();
            }
        });
    }

    // --- Test Screening SSE Logic --- 
    if (startTestScreenButton) {
        startTestScreenButton.addEventListener('click', function() {
            console.log("Test Screen Button CLICKED!");
            const testFileInput = document.getElementById('test_file');
            const sampleSizeInput = document.getElementById('sample_size');
            // --- NEW: Get filter inputs for Test Screening ---
            const testTitleFilterInput = document.getElementById('test_title_text_filter');
            const testLineRangeInput = document.getElementById('test_line_range_filter');
            // --- END NEW ---

            if (!testFileInput.files || testFileInput.files.length === 0) { alert('Please select a file for test screening.'); return; }
            const sampleSize = sampleSizeInput.value || 10;
            console.log(`Test Screening initiated. Sample size: ${sampleSize}`);

            // Reset UI (Get elements here for reset)
            const testProgressArea = document.getElementById('test_progress_area');
            const testProgressBar = document.getElementById('test_progress_bar');
            const testProgressStatus = document.getElementById('test_progress_status');
            const testProgressLogContainer = document.getElementById('test_progress_log_container');
            const testResultsLinkArea = document.getElementById('test_results_link_area');
            if(testProgressArea) testProgressArea.style.display = 'block';
            if(testProgressLogContainer) testProgressLogContainer.style.display = 'block';
            // Reset log content using helper
            addTestLogItem(""); // Clears by potentially removing old items if list was full
            const initialLogEl = document.getElementById('test_progress_log'); if(initialLogEl) initialLogEl.innerHTML = ''; // Explicit clear
            
            if(testProgressBar) { testProgressBar.style.width = '0%'; testProgressBar.textContent = '0%'; testProgressBar.classList.remove('bg-success', 'bg-danger'); testProgressBar.classList.add('bg-info'); }
            if(testProgressStatus) testProgressStatus.textContent = 'Initializing test screening...';
            if(testResultsLinkArea) testResultsLinkArea.style.display = 'none';
            startTestScreenButton.disabled = true;
            window.loggedTestLogError = false; // Reset log flag for this run

            const formData = new FormData(); 
            formData.append('file', testFileInput.files[0]); 
            formData.append('sample_size', sampleSize);
            // --- NEW: Append filter data to FormData for Test Screening ---
            if (testTitleFilterInput && testTitleFilterInput.value) {
                formData.append('title_text_filter', testTitleFilterInput.value.trim());
            }
            if (testLineRangeInput && testLineRangeInput.value) {
                formData.append('line_range_filter', testLineRangeInput.value.trim());
            }
            // --- END NEW ---

            const xhrTest = new XMLHttpRequest(); 
            console.log("Initiating Test XHR Request...");
            xhrTest.open("POST", "{{ url_for('stream_test_screen_file') }}", true);
            
            let testSseBuffer = ""; // Buffer for Test Screening SSE
            let lastProcessedResponseLengthTest = 0; // Tracks how much of responseText has been processed

            xhrTest.onprogress = function() {
                const newChunk = xhrTest.responseText.substring(lastProcessedResponseLengthTest);
                lastProcessedResponseLengthTest = xhrTest.responseText.length;
                testSseBuffer += newChunk;

                let eolIndex;
                while ((eolIndex = testSseBuffer.indexOf('\\n\\n')) >= 0) {
                    const messageToProcess = testSseBuffer.substring(0, eolIndex);
                    testSseBuffer = testSseBuffer.substring(eolIndex + 2);

                    if (messageToProcess.startsWith("data: ")) {
                        const jsonDataString = messageToProcess.substring(6);
                        try {
                            const jsonData = JSON.parse(jsonDataString);
                            // Get elements JUST BEFORE use
                            const currentTestBar = document.getElementById('test_progress_bar');
                            const currentTestStatus = document.getElementById('test_progress_status');
                            const currentTestArea = document.getElementById('test_progress_area');
                            const currentTestLogContainer = document.getElementById('test_progress_log_container');
                            const currentTestLinkArea = document.getElementById('test_results_link_area');
                            const currentTestLink = document.getElementById('view_test_results_link');

                            if (jsonData.type === 'start') {
                                if(currentTestStatus) currentTestStatus.textContent = `Starting... Total: ${jsonData.total}`;
                                if(currentTestArea) currentTestArea.style.display = 'block'; 
                                if(currentTestLogContainer) currentTestLogContainer.style.display = 'block';
                                // --- MODIFIED: Display filter info from SSE for Test Screening ---
                                let testStartMessage = `[${new Date().toLocaleTimeString()}] Started test screening. Max sample: ${sampleSizeInput.value}, Actual to screen: ${jsonData.total}`;
                                if (jsonData.filter_info && jsonData.filter_info !== 'all entries') {
                                    testStartMessage += ` (Filter: ${jsonData.filter_info})`;
                                }
                                addTestLogItem(testStartMessage);
                                // --- END MODIFIED ---
                            } else if (jsonData.type === 'progress') {
                                if (currentTestBar) {
                                    try { currentTestBar.style.width = jsonData.percentage + '%'; currentTestBar.textContent = jsonData.percentage + '%'; }
                                     catch (e) { console.error("ERROR updating test progress bar:", e); }
                                } else { if (!window.loggedTestBarError) { console.error('!!! Could not find test_progress_bar in onprogress'); window.loggedTestBarError = true;} }
                                
                                if (currentTestStatus) {
                                    try { currentTestStatus.textContent = `Processing ${jsonData.count}/${jsonData.total}: ${jsonData.current_item_title ? jsonData.current_item_title.substring(0,40) : 'Item'}...`; }
                                     catch (e) { console.error("ERROR updating test progress status:", e); }
                                } else { if (!window.loggedTestStatusError) { console.error('!!! Could not find test_progress_status in onprogress'); window.loggedTestStatusError = true; } }
                                
                                let decisionClass = jsonData.decision ? 'log-decision-' + jsonData.decision.toUpperCase().replace('API_','').replace('HTTP_ERROR_','ERROR_') : '';
                                addTestLogItem(`[${new Date().toLocaleTimeString()}] Item ${jsonData.count}: ${jsonData.current_item_title ? jsonData.current_item_title.substring(0,30) : 'Item'}... <span class="log-item-decision ${decisionClass}">${jsonData.decision || ''}</span>`);
                            } else if (jsonData.type === 'complete') {
                                if(currentTestBar){ currentTestBar.classList.add('bg-success'); currentTestBar.textContent = "Complete"; }
                                if(currentTestStatus) currentTestStatus.textContent = jsonData.message;
                                addTestLogItem(`[${new Date().toLocaleTimeString()}] ${jsonData.message}`);
                                if (jsonData.session_id && currentTestLink && currentTestLinkArea) {
                                    let baseUrl = "{{ url_for('show_test_results', session_id='__SESSION_ID__') }}";
                                    currentTestLink.href = baseUrl.replace('__SESSION_ID__', jsonData.session_id);
                                    currentTestLinkArea.style.display = 'block';
                                    // Add to test screening history with complete results
                                    addToHistory('test', jsonData.session_id, testFileInput.files[0].name || 'Test screening', jsonData.client_results);
                                } else { 
                                    console.warn('Could not set test results link.'); 
                                    addTestLogItem(`<span style="color:red">Warning: Could not set test results link. Please refresh the page or check console.</span>`);
                                    // Still add to history even if UI elements not found
                                    if (jsonData.session_id) {
                                        addToHistory('test', jsonData.session_id, testFileInput.files[0].name || 'Test screening', jsonData.client_results);
                                    }
                                }
                                xhrTest.abort();
                                finalizeTestButton();
                            } else if (jsonData.type === 'error') {
                                if(currentTestBar){ /* ... */ }
                                if(currentTestStatus) currentTestStatus.textContent = `Error: ${jsonData.message}`;
                                // --- MODIFIED: Display config link if API key missing for Test --- 
                                let testErrorMessage = `[${new Date().toLocaleTimeString()}] Error: ${jsonData.message}`;
                                if (jsonData.needs_config) {
                                    const configUrl = "{{ url_for('llm_config_page') }}";
                                    testErrorMessage += ` <a href="${configUrl}" target="_blank">Please configure API Key.</a>`;
                                }
                                addTestLogItem(testErrorMessage);
                                // --- END MODIFIED ---
                                xhrTest.abort();
                                finalizeTestButton();
                            }
                        } catch (e) { 
                            console.error("Test SSE Parse Error:", e, "Problematic JSON string:", jsonDataString); 
                            addTestLogItem(`<span style="color:red">Error parsing server update (Test). See console.</span>`);
                        } 
                    } else if (messageToProcess.trim() !== "") {
                        console.warn("Test SSE: Received non-data line:", messageToProcess);
                    }
                }
            }; 
            xhrTest.onloadend = function() { console.log("xhrTest.onloadend"); finalizeTestButton(); }; 
            xhrTest.onerror = function() { console.error("xhrTest.onerror"); finalizeTestButton(); }; 
            xhrTest.send(formData);
        }); 
    }

    // --- Full Screening SSE Logic (Apply same pattern) ---
    if (startFullScreenButton) {
        console.log("Adding listener to Full Screen Button."); 
        startFullScreenButton.addEventListener('click', function() {
             console.log(">>> Full Screen Button CLICKED!");
             const fileInput = document.getElementById('full_file_progress');
             if (!fileInput || !fileInput.files || fileInput.files.length === 0) { alert('Select file...'); return; }
             console.log("Full Screening initiated.");
             
             // Reset UI 
             const progressArea = document.getElementById('progress_area');
             const progressLogContainer = document.getElementById('progress_log_container');
             const progressLog = document.getElementById('progress_log');
             const progressBar = document.getElementById('progress_bar');
             const progressStatus = document.getElementById('progress_status');
             const sseResultsLinkArea = document.getElementById('sse_results_link_area');
             if(progressArea) progressArea.style.display = 'block';
             if(progressLogContainer) progressLogContainer.style.display = 'block';
             addLogItem(""); 
             const initialFullLogEl = document.getElementById('progress_log'); if(initialFullLogEl) initialFullLogEl.innerHTML = '';

             if(progressBar) {progressBar.style.width = '0%'; progressBar.textContent = '0%'; progressBar.classList.remove('bg-success','bg-danger');}
             if(progressStatus) progressStatus.textContent = 'Initializing...';
             if(sseResultsLinkArea) sseResultsLinkArea.style.display = 'none';
             startFullScreenButton.disabled = true;
             window.loggedFullLogError = false; 
             
             const formData = new FormData(); 
             formData.append('file', fileInput.files[0]);
             const titleFilterInput = document.getElementById('title_text_filter');
             const lineRangeInput = document.getElementById('line_range_filter');
             if (titleFilterInput && titleFilterInput.value) {
                 formData.append('title_text_filter', titleFilterInput.value.trim());
             }
             if (lineRangeInput && lineRangeInput.value) {
                 formData.append('line_range_filter', lineRangeInput.value.trim());
             }

             const xhr = new XMLHttpRequest(); 
             console.log("Initiating Full XHR Request...");
             xhr.open("POST", "{{ url_for('stream_screen_file') }}", true);

             let fullSseBuffer = ""; // Buffer for Full Screening SSE
             let lastProcessedResponseLengthFull = 0; // Tracks how much of responseText has been processed
             
             xhr.onprogress = function() {
                 const newChunk = xhr.responseText.substring(lastProcessedResponseLengthFull);
                 lastProcessedResponseLengthFull = xhr.responseText.length;
                 fullSseBuffer += newChunk;

                 let eolIndex;
                 while ((eolIndex = fullSseBuffer.indexOf('\\n\\n')) >= 0) {
                    const messageToProcess = fullSseBuffer.substring(0, eolIndex);
                    fullSseBuffer = fullSseBuffer.substring(eolIndex + 2);

                    if (messageToProcess.startsWith("data: ")) {
                        const jsonDataString = messageToProcess.substring(6);
                        try {
                            const jsonData = JSON.parse(jsonDataString);
                            const currentFullBar = document.getElementById('progress_bar');
                            const currentFullStatus = document.getElementById('progress_status');
                            const currentFullArea = document.getElementById('progress_area');
                            const currentFullLogContainer = document.getElementById('progress_log_container');
                            const currentFullLinkArea = document.getElementById('sse_results_link_area');
                            const currentFullLink = document.getElementById('view_full_results_link');

                            if (jsonData.type === 'start') {
                                if(currentFullStatus) currentFullStatus.textContent = `Screening ${jsonData.total} items...`;
                                if(currentFullArea) currentFullArea.style.display = 'block';
                                if(currentFullLogContainer) currentFullLogContainer.style.display = 'block';
                                let startMessage = `[${new Date().toLocaleTimeString()}] Started. Total to screen: ${jsonData.total}`;
                                if (jsonData.filter_info && jsonData.filter_info !== 'all entries') {
                                    startMessage += ` (Filter: ${jsonData.filter_info})`;
                                }
                                addLogItem(startMessage);
                            } else if (jsonData.type === 'progress') {
                                if (currentFullBar) { 
                                    try { currentFullBar.style.width = jsonData.percentage + '%'; currentFullBar.textContent = jsonData.percentage + '%'; } 
                                    catch(e) { console.error("Error updating full progress bar:", e); }
                                } else { if (!window.loggedFullBarError) { console.error('!!! Could not find progress_bar in onprogress'); window.loggedFullBarError = true; } }
                                if (currentFullStatus) { 
                                      try { currentFullStatus.textContent = `Processing ${jsonData.count}/${jsonData.total}: ${jsonData.current_item_title ? jsonData.current_item_title.substring(0,40) : 'Item'}...`; } 
                                      catch (e) { console.error("Error updating full progress status:", e); }
                                 } else { if (!window.loggedFullStatusError) { console.error('!!! Could not find progress_status in onprogress'); window.loggedFullStatusError = true; } }
                                 
                                let decisionClass = jsonData.decision ? 'log-decision-' + jsonData.decision.toUpperCase().replace('API_','').replace('HTTP_ERROR_','ERROR_') : '';
                                addLogItem(`[${new Date().toLocaleTimeString()}] Item ${jsonData.count}: ${jsonData.current_item_title ? jsonData.current_item_title.substring(0,30) : 'Item'}... <span class="log-item-decision ${decisionClass}">${jsonData.decision || ''}</span>`);
                            } else if (jsonData.type === 'complete') {
                                if(currentFullBar){ currentFullBar.classList.add('bg-success'); currentFullBar.textContent = "Complete"; }
                                if(currentFullStatus) currentFullStatus.textContent = jsonData.message;
                                addLogItem(`[${new Date().toLocaleTimeString()}] ${jsonData.message}`);
                                if (jsonData.screening_id && currentFullLink && currentFullLinkArea) {
                                    let baseUrl = "{{ url_for('show_screening_results', screening_id='__SCREENING_ID__') }}";
                                    currentFullLink.href = baseUrl.replace('__SCREENING_ID__', jsonData.screening_id);
                                    currentFullLinkArea.style.display = 'block';
                                    // Add to full screening history with complete results
                                    addToHistory('full', jsonData.screening_id, fileInput.files[0].name || 'Full screening', jsonData.client_results);
                                } else { 
                                    console.warn('Could not set full results link. Screening ID: ' + jsonData.screening_id); 
                                    addLogItem(`<span style="color:red">Warning: Could not set results link. Please refresh the page or check console.</span>`);
                                    // Still add to history ONLY IF screening_id is valid
                                    if (jsonData.screening_id) {
                                        addToHistory('full', jsonData.screening_id, fileInput.files[0].name || 'Full screening', jsonData.client_results);
                                    } else {
                                        console.error('Full screening completed but screening_id was missing. History not saved for this entry.');
                                        addLogItem(`<span style="color:red">Error: Screening ID missing, history entry not saved.</span>`);
                                    }
                                }
                                xhr.abort(); 
                                finalizeButtons();
                            } else if (jsonData.type === 'error') {
                                if(currentFullBar){ currentFullBar.classList.add('bg-danger'); currentFullBar.textContent = "Error";}
                                if(currentFullStatus) currentFullStatus.textContent = `Error: ${jsonData.message}`;
                                let errorMessage = `[${new Date().toLocaleTimeString()}] Error: ${jsonData.message}`;
                                if (jsonData.needs_config) {
                                    const configUrl = "{{ url_for('llm_config_page') }}";
                                    errorMessage += ` <a href="${configUrl}" target="_blank">Please configure API Key.</a>`;
                                }
                                addLogItem(errorMessage);
                                xhr.abort();
                                finalizeButtons();
                            }
                        } catch (e) { 
                            console.error("Full SSE Parse Error:", e, "Problematic JSON string:", jsonDataString); 
                            addLogItem(`<span style="color:red">Error parsing server update (Full). See console.</span>`);
                        } 
                    } else if (messageToProcess.trim() !== "") {
                        console.warn("Full SSE: Received non-data line:", messageToProcess);
                    }
                 }
             };
             xhr.onloadend = function() { finalizeButtons(); }; 
             xhr.onerror = function() { finalizeButtons(); }; 
             xhr.send(formData);
        }); 
    } 

}); 
</script>
{% endblock %}