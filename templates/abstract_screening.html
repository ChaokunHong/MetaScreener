{% extends "base.html" %}

{% block title %}Abstract Screening - AI Literature Screening Assistant{% endblock %}

{% block extra_head %}
<style>
    .input-group-append .btn {
        padding-top: 0.25rem; /* Align clear button better */
        padding-bottom: 0.25rem;
    }
    .clear-input-btn {
        font-size: 0.8em;
        line-height: 1;
        opacity: 0.6;
    }
    .clear-input-btn:hover {
        opacity: 1;
    }
    /* Hidden dummy elements for index.global.js */
    .js-dummy-container {
        display: none;
        visibility: hidden;
        position: absolute;
        left: -9999px;
        top: -9999px;
    }
    
    /* Decision color styles */
    .log-item-decision {
        font-weight: bold;
    }
    .log-decision-INCLUDE {
        color: green;
    }
    .log-decision-EXCLUDE {
        color: red;
    }
    .log-decision-MAYBE {
        color: orange;
    }
    .log-decision-ERROR {
        color: darkred;
    }
    .missing-field {
        color: orange;
        font-style: italic;
    }

    /* Stepper-like UI */
    .step-card {
        margin-bottom: 1.5rem;
        border: 1px solid #dee2e6;
        border-radius: .25rem;
    }
    .step-card .card-header {
        background-color: #f8f9fa;
        padding: 0.75rem 1.25rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .step-card .card-header h5 {
        margin-bottom: 0;
        font-weight: 600;
    }
    .step-card .card-body {
        padding: 1.25rem;
    }
    .step-indicator {
        font-size: 1.5rem;
        color: var(--primary-color);
        margin-right: 0.5rem;
    }
    .filter-options-toggle {
        font-size: 0.9rem;
    }
</style>
<script>
// Enhanced error handling for cloud environments
(function() {
    // Log environment information for debugging
    console.log("Environment info:", {
        url: window.location.href,
        hostname: window.location.hostname,
        userAgent: navigator.userAgent,
        timestamp: new Date().toISOString()
    });
    
    // Global error catcher - now with more comprehensive handling
    window.addEventListener('error', function(event) {
        console.log("Caught global error:", event);
        
        // Handle the specific appendChild error from index.global.js
        if (event.error && event.error.message && 
            (event.error.message.includes("appendChild") || 
             event.error.message.includes("null") || 
             event.error.message.includes("undefined"))) {
            
            console.warn("Caught and suppressed DOM error:", event.error.message);
            
            // Create a special recovery function
            window._recoverFromDomError = function() {
                try {
                    console.log("Attempting DOM recovery...");
                    
                    // Check for any processing in progress and ensure buttons are enabled
                    if (document.getElementById('start_full_screen_button')) {
                        document.getElementById('start_full_screen_button').disabled = false;
                    }
                    
                    if (document.getElementById('start_test_screen_button')) {
                        document.getElementById('start_test_screen_button').disabled = false;
                    }
                    
                    // Check if we need to update any progress indicators
                    const progressArea = document.getElementById('progress_area');
                    if (progressArea && progressArea.style.display !== 'none') {
                        // There was an active screening
                        const progressStatus = document.getElementById('progress_status');
                        if (progressStatus) {
                            progressStatus.textContent = "Processing is continuing in the background. Check results page later.";
                        }
                    }
                } catch (e) {
                    console.error("Recovery attempt failed:", e);
                }
            };
            
            // Schedule recovery
            setTimeout(window._recoverFromDomError, 500);
            
            // Prevent error propagation
            event.preventDefault();
            event.stopPropagation();
            return true;
        }
    }, true);
    
    // Override some troublesome DOM methods to prevent errors
    const originalCreateElement = document.createElement;
    document.createElement = function(tagName) {
        try {
            return originalCreateElement.call(document, tagName);
        } catch (e) {
            console.warn("Protected createElement failed:", e);
            // Return a dummy div as fallback
            try {
                return originalCreateElement.call(document, 'div');
            } catch (innerE) {
                console.error("Even fallback createElement failed!");
                // Last resort - create an object that mimics an element
                return {
                    appendChild: function() { return null; },
                    style: {},
                    classList: { add: function(){}, remove: function(){} },
                    // Add other necessary properties/methods if FullCalendar or other libs need them
                    getElementsByTagName: function() { return []; },
                    hasAttribute: function() { return false; },
                    getAttribute: function() { return null; },
                    setAttribute: function() {}, 
                    removeAttribute: function() {}
                };
            }
        }
    };
})();
</script>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-3">
        <div class="col-12">
            <h1>Abstract Screening</h1>
            <p class="lead">Screen your literature abstracts efficiently. You can start with a test screening or proceed to screen the full dataset.</p>
            <p>Ensure your <a href="{{ url_for('llm_config_page') }}">LLM is configured</a> and <a href="{{ url_for('screening_criteria_page') }}">screening criteria are set</a> before starting.</p>
        </div>
    </div>

    <div id="abstractScreeningAccordion">
        <!-- Step 1: Test Screening Section -->
        <div class="step-card card">
            <div class="card-header" id="headingTestScreening" data-toggle="collapse" data-target="#collapseTestScreening" aria-expanded="true" aria-controls="collapseTestScreening">
                <h5><span class="step-indicator"><i class="bi bi-eyedropper"></i></span>1. Test Screening (Sampled Abstracts)</h5>
                <button class="btn btn-link filter-options-toggle" type="button">
                    <i class="bi bi-chevron-down"></i>
                </button>
            </div>

            <div id="collapseTestScreening" class="collapse show" aria-labelledby="headingTestScreening" data-parent="#abstractScreeningAccordion">
                <div class="card-body">
                    <p>Upload a .ris file to screen a sample of abstracts. This helps you test your criteria and AI performance with a smaller batch.</p>
                    <form id="test_screen_form" enctype="multipart/form-data">
                        <div class="form-row align-items-end">
                            <div class="form-group col-md-6">
                                <label for="test_file">Upload RIS File:</label>
                                <input type="file" name="file" id="test_file" class="form-control-file form-control-sm" required accept=".ris">
                                <small class="form-text text-muted">Select the .ris file containing abstracts for test screening.</small>
                            </div>
                            <div class="form-group col-md-3">
                                <label for="sample_size">Sample Size:</label>
                                <input type="number" name="sample_size" id="sample_size" class="form-control form-control-sm" value="10" min="5" max="9999">
                                <small class="form-text text-muted">Number of abstracts to sample from the file.</small>
                            </div>
                            <div class="form-group col-md-3">
                                <button id="start_test_screen_button" type="button" class="btn btn-info btn-block">
                                    <span id="test_spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                                    <i class="bi bi-play-circle"></i> Start Test Screening
                                </button>
                            </div>
                        </div>

                        <div class="mt-3">
                            <a class="filter-options-toggle" data-toggle="collapse" href="#testFilterOptions" role="button" aria-expanded="false" aria-controls="testFilterOptions">
                                Advanced Filters (Optional) <i class="bi bi-chevron-down small"></i>
                            </a>
                        </div>

                        <div class="collapse mt-2" id="testFilterOptions">
                            <div class="card card-body bg-light p-3">
                                <div class="form-row">
                                    <div class="form-group col-md-6 mb-0">
                                        <label for="test_title_text_filter">Filter by Title:</label>
                                        <div class="input-group input-group-sm">
                                            <input type="text" id="test_title_text_filter" name="title_text_filter" class="form-control form-control-sm" placeholder="Enter keywords from title">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary clear-input-btn" type="button" onclick="clearInput('test_title_text_filter')">&times;</button>
                                            </div>
                                        </div>
                                        <small class="form-text text-muted">Filters are applied *before* sampling. Title filter takes precedence if both are filled.</small>
                                    </div>
                                    <div class="form-group col-md-6 mb-0">
                                        <label for="test_line_range_filter">Filter by Line Numbers (1-based):</label>
                                        <div class="input-group input-group-sm">
                                            <input type="text" id="test_line_range_filter" name="line_range_filter" class="form-control form-control-sm" placeholder="e.g., 5-10, 7, 1-20, 50-">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary clear-input-btn" type="button" onclick="clearInput('test_line_range_filter')">&times;</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                    <div id="test_progress_area" class="mt-3" style="display: none;">
                        <h5>Test Screening Progress:</h5>
                        <div class="progress mb-2">
                            <div id="test_progress_bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <p id="test_progress_status" class="mt-1 small text-muted"></p>
                        <div class="mt-2">
                             <a class="filter-options-toggle" data-toggle="collapse" href="#testLogContainer" role="button" aria-expanded="false" aria-controls="testLogContainer">
                                Show Live Log <i class="bi bi-chevron-down small"></i>
                            </a>
                        </div>
                        <div id="testLogContainer" class="collapse mt-2">
                            <div id="test_progress_log_container" style="display:none;">
                                <div id="test_progress_log" style="max-height: 150px; overflow-y: auto; font-size: 0.8em; background-color: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: .25rem; white-space: pre-line;"></div>
                            </div>
                        </div>
                    </div>
                    <div id="test_results_link_area" class="mt-3" style="display:none;">
                        <a href="#" id="view_test_results_link" class="btn btn-primary"><i class="bi bi-clipboard-check"></i> View Test Results & Assess</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Full Dataset Screening Section -->
        <div class="step-card card">
            <div class="card-header" id="headingFullScreening" data-toggle="collapse" data-target="#collapseFullScreening" aria-expanded="false" aria-controls="collapseFullScreening">
                <h5><span class="step-indicator"><i class="bi bi-card-checklist"></i></span>2. Screen Full Dataset (All Abstracts)</h5>
                 <button class="btn btn-link filter-options-toggle" type="button">
                    <i class="bi bi-chevron-down"></i>
                </button>
            </div>
            <div id="collapseFullScreening" class="collapse" aria-labelledby="headingFullScreening" data-parent="#abstractScreeningAccordion">
                <div class="card-body">
                    <p>Upload your .ris file to screen all entries based on abstracts using the current settings. Progress will be displayed live.</p>
                    <form id="full_screen_form_id" enctype="multipart/form-data">
                        <div class="form-row align-items-end">
                            <div class="form-group col-md-9">
                                <label for="full_file_progress">Upload RIS File:</label>
                                <input type="file" name="file" id="full_file_progress" class="form-control-file form-control-sm" required accept=".ris">
                                <small class="form-text text-muted">Select the .ris file containing all abstracts for full screening.</small>
                            </div>
                            <div class="form-group col-md-3">
                                <button type="button" id="start_full_screen_button" class="btn btn-primary btn-block"><i class="bi bi-play-fill"></i> Screen Full File</button>
                            </div>
                        </div>

                        <div class="mt-3">
                            <a class="filter-options-toggle" data-toggle="collapse" href="#fullFilterOptions" role="button" aria-expanded="false" aria-controls="fullFilterOptions">
                                Advanced Filters (Optional) <i class="bi bi-chevron-down small"></i>
                            </a>
                        </div>

                        <div class="collapse mt-2" id="fullFilterOptions">
                            <div class="card card-body bg-light p-3">
                                <div class="form-row">
                                    <div class="form-group col-md-6 mb-0">
                                        <label for="title_text_filter">Filter by Title:</label>
                                        <div class="input-group input-group-sm">
                                            <input type="text" id="title_text_filter" name="title_text_filter" class="form-control form-control-sm" placeholder="Enter keywords from title">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary clear-input-btn" type="button" onclick="clearInput('title_text_filter')">&times;</button>
                                            </div>
                                        </div>
                                        <small class="form-text text-muted">Title filter takes precedence if both are filled.</small>
                                    </div>
                                    <div class="form-group col-md-6 mb-0">
                                        <label for="line_range_filter">Filter by Line Numbers (1-based):</label>
                                        <div class="input-group input-group-sm">
                                            <input type="text" id="line_range_filter" name="line_range_filter" class="form-control form-control-sm" placeholder="e.g., 5-10, 7, 1-20, 50-">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary clear-input-btn" type="button" onclick="clearInput('line_range_filter')">&times;</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                    <div id="progress_area" class="mt-3" style="display: none;">
                        <h4>Screening Progress:</h4>
                        <div class="progress mb-2">
                            <div id="progress_bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <p id="progress_status" class="mt-1 small text-muted"></p>
                        <div class="mt-2">
                            <a class="filter-options-toggle" data-toggle="collapse" href="#fullLogContainer" role="button" aria-expanded="false" aria-controls="fullLogContainer">
                                Show Live Log <i class="bi bi-chevron-down small"></i>
                            </a>
                        </div>
                         <div id="fullLogContainer" class="collapse mt-2">
                            <div id="progress_log_container" style="display:none;">
                                <div id="progress_log" style="max-height: 150px; overflow-y: auto; font-size: 0.8em; background-color: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: .25rem; white-space: pre-line;"></div>
                            </div>
                        </div>
                    </div>
                    <div id="sse_results_link_area" class="mt-3" style="display:none;">
                        <a href="#" id="view_full_results_link" class="btn btn-success"><i class="bi bi-check2-circle"></i> View Full Screening Results</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="js-dummy-container">
    <!-- Dummy elements for index.global.js -->
    <div id="fc-dom-1"></div> 
    <div id="fc-dom-2"></div> 
</div>

{% endblock %}

{% block extra_js %}
<script>
// Define MAX log items globally in the script block
const MAX_TEST_LOG_ITEMS = 5;
const MAX_FULL_LOG_ITEMS = 7;

// Add optimization function for handling large volume of literature
function optimizeForLargeVolume() {
    console.log("Activating performance optimizations for large volume processing");
    
    // Reduce DOM update frequency to avoid lag
    window._optimizationCounter = 0;
    window._skipDomUpdate = function() {
        // Update DOM every 10 items (for large volumes)
        window._optimizationCounter++;
        // Return true if DOM update should be skipped - but NEVER skip items with decisions
        return window._optimizationCounter % 10 !== 0;
    };
    
    // Clean up unnecessary DOM elements to save memory
    window._cleanupDom = function() {
        // If log items exceed half of the limit, clean up early
        try {
            const logEl = safeGetElement('progress_log');
            if(logEl.children && logEl.children.length > MAX_FULL_LOG_ITEMS/2) {
                while(logEl.children.length > MAX_FULL_LOG_ITEMS/2) {
                    logEl.removeChild(logEl.firstChild);
                }
            }
            
            const testLogEl = safeGetElement('test_progress_log');
            if(testLogEl.children && testLogEl.children.length > MAX_TEST_LOG_ITEMS/2) {
                while(testLogEl.children.length > MAX_TEST_LOG_ITEMS/2) {
                    testLogEl.removeChild(testLogEl.firstChild);
                }
            }
        } catch (e) {
            console.warn("Error during cleanup:", e);
        }
    };
    
    // Clean up every 30 seconds
    window._cleanupInterval = setInterval(window._cleanupDom, 30000);
    
    return true;
}

// --- Helper Functions (Refined - Get element inside) ---
function addTestLogItem(message) {
    // For large volumes, skip some DOM updates to improve performance
    // But NEVER skip items with decisions or errors
    if(window._skipDomUpdate && window._skipDomUpdate() && 
       !message.includes("Error") && 
       !message.includes("EXCLUDE") && 
       !message.includes("INCLUDE") && 
       !message.includes("MAYBE") && 
       !message.includes("缺少摘要") && 
       !message.includes("missing")) {
        return;
    }
    
    try {
        const logEl = safeGetElement('test_progress_log'); 
        if(message) {  // Ensure message is not empty
            const div = document.createElement('div');
            div.innerHTML = message;
            while (logEl.children && logEl.children.length >= MAX_TEST_LOG_ITEMS) { 
                logEl.removeChild(logEl.firstChild); 
            }
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }
    } catch (e) {
        console.warn("Error adding test log item:", e);
    }
}

function addLogItem(message) {
    // For large volumes, skip some DOM updates to improve performance
    // But NEVER skip items with decisions or errors
    if(window._skipDomUpdate && window._skipDomUpdate() && 
       !message.includes("Error") && 
       !message.includes("EXCLUDE") && 
       !message.includes("INCLUDE") && 
       !message.includes("MAYBE") && 
       !message.includes("缺少摘要") && 
       !message.includes("missing")) {
        return;
    }
    
    try {
        const logEl = safeGetElement('progress_log');
        if(message) {  // Ensure message is not empty
            const div = document.createElement('div');
            div.innerHTML = message;
            while (logEl.children && logEl.children.length >= MAX_FULL_LOG_ITEMS) {
                logEl.removeChild(logEl.firstChild);
            }
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }
    } catch (e) {
        console.warn("Error adding log item:", e);
    }
}

// --- Finalize Button Functions --- 
function finalizeTestButton() { 
    try {
        const btn = safeGetElement('start_test_screen_button');
        btn.disabled = false;
        const spin = safeGetElement('test_spinner');
        spin.style.display = 'none';
    } catch (e) {
        console.warn("Error finalizing test button:", e);
    }
}

function finalizeButtons() { 
    try {
        const btnF = safeGetElement('start_full_screen_button');
        btnF.disabled = false;
        // Ensure spinner is hidden if one was added to full screen button
        const fullSpinner = safeGetElement('full_spinner'); // Assuming an ID like 'full_spinner' if you add one
        if (fullSpinner) fullSpinner.style.display = 'none';
    } catch (e) {
        console.warn("Error finalizing buttons:", e);
    }
}

function clearInput(inputId) {
    try {
        const inputElement = safeGetElement(inputId);
        inputElement.value = '';
    } catch (e) {
        console.warn("Error clearing input:", e);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM loaded. Finding trigger elements...");
    
    // Check for any previous screening session that might have been interrupted
    try {
        const lastComplete = sessionStorage.getItem('lastScreeningComplete');
        const lastScreeningId = sessionStorage.getItem('lastScreeningId');
        const lastScreeningTime = sessionStorage.getItem('lastScreeningTime');
        const lastState = sessionStorage.getItem('lastScreeningState');
        
        // If we have a completed screening but user hasn't viewed results yet
        if (lastComplete === 'true' && lastScreeningId) {
            console.log("Found previous completed screening:", lastScreeningId);
            
            // Show a notification that results are available
            const notification = document.createElement('div');
            notification.className = 'alert alert-success';
            notification.innerHTML = `
                <strong>Previous screening completed!</strong> 
                Your last screening completed at ${new Date(lastScreeningTime).toLocaleString()}. 
                <a href="{{ url_for('show_screening_results', screening_id='__ID__') }}" class="alert-link">
                    Click here to view results
                </a>.
            `.replace('__ID__', lastScreeningId);
            
            // Insert at top of page
            const firstCard = document.querySelector('.section-card');
            if (firstCard && firstCard.parentNode) {
                firstCard.parentNode.insertBefore(notification, firstCard);
            }
        }
        // If we have an interrupted screening
        else if (lastState) {
            const state = JSON.parse(lastState);
            console.log("Found interrupted screening state:", state);
            
            // Show a notification
            const notification = document.createElement('div');
            notification.className = 'alert alert-warning';
            notification.innerHTML = `
                <strong>Previous screening interrupted!</strong> 
                Your last screening was processing item ${state.count} of ${state.total} 
                when the connection was interrupted. The screening may have continued in the background.
                Please check the results page for recently completed screenings.
            `;
            
            // Insert at top of page
            const firstCard = document.querySelector('.section-card');
            if (firstCard && firstCard.parentNode) {
                firstCard.parentNode.insertBefore(notification, firstCard);
            }
        }
    } catch (e) {
        console.error("Error checking previous screening state:", e);
    }
    
    // Safe function to get DOM elements that never returns null
    function safeGetElement(id) {
        try {
            const el = document.getElementById(id);
            if (!el) {
                console.warn(`Element with ID "${id}" not found, returning safe dummy`);
                const dummy = document.createElement('div'); // Still create a div first
                dummy.id = id + '-dummy';
                dummy.style.display = 'none';
                
                // Define properties and methods for the dummy object
                dummy.appendChild = function(child) { /* console.log('Dummy appendChild called'); */ return child; };
                dummy.removeChild = function(child) { /* console.log('Dummy removeChild called'); */ return child; };
                dummy.innerHTML = ''; // Initialize innerHTML
                dummy.style = { width: '0%' }; // Ensure style object exists
                dummy.classList = { 
                    add: function(){ /* console.log('Dummy classList.add called'); */ }, 
                    remove: function(){ /* console.log('Dummy classList.remove called'); */ },
                    contains: function(){ return false; }
                };
                dummy.scrollTop = 0;
                dummy.scrollHeight = 0;
                dummy.children = { length: 0, item: function() { return null; }, namedItem: function() { return null; } }; // Make children more like a real HTMLCollection

                // Safely append to body only if body exists
                if (document.body) {
                    try {
                        document.body.appendChild(dummy);
                    } catch(e) { 
                        console.error(`Failed to append dummy element ${dummy.id} to document.body:`, e);
                    }
                } else {
                    console.warn(`document.body not available when creating dummy for ID "${id}". Dummy will not be in DOM.`);
                }
                return dummy;
            }
            return el;
        } catch(e) {
            console.error(`Critical error in safeGetElement for ID "${id}":`, e);
            // Fallback to an even more basic dummy if createElement itself fails or other critical error
            return {
                id: id + '-critical-dummy',
                appendChild: function() { /* console.log('Critical dummy appendChild'); */ return null; },
                removeChild: function() { /* console.log('Critical dummy removeChild'); */ return null; },
                style: {},
                classList: { add: function(){}, remove: function(){} },
                innerHTML: '',
                children: { length: 0, item: function() { return null; }, namedItem: function() { return null; } },
                scrollTop: 0,
                scrollHeight: 0
            };
        }
    }
    
    // Store reference to safe function for use in callbacks
    window.safeGetElement = safeGetElement;
    
    // Get button elements safely
    const startTestScreenButton = safeGetElement('start_test_screen_button');
    const startFullScreenButton = safeGetElement('start_full_screen_button');
    console.log("Buttons found:", { startTestScreenButton, startFullScreenButton });
    window.loggedTestLogError = false; // Reset log error flags on load
    window.loggedFullLogError = false;

    // --- Test Screening SSE Logic --- 
    if (startTestScreenButton) {
        startTestScreenButton.addEventListener('click', function() {
            console.log("Test Screen Button CLICKED!");
            const testFileInput = document.getElementById('test_file');
            const sampleSizeInput = document.getElementById('sample_size');
            // --- NEW: Get filter inputs for Test Screening ---
            const testTitleFilterInput = document.getElementById('test_title_text_filter');
            const testLineRangeInput = document.getElementById('test_line_range_filter');
            // --- END NEW ---

            if (!testFileInput.files || testFileInput.files.length === 0) { alert('Please select a file for test screening.'); return; }
            const sampleSize = sampleSizeInput.value || 10;
            console.log(`Test Screening initiated. Sample size: ${sampleSize}`);
            
            // Check sample size and optimize if it's large
            if(sampleSize > 50) { // Samples larger than 50 are considered large
                console.log("Large sample detected, activating performance optimization mode");
                optimizeForLargeVolume();
            }

            // Reset UI (Get elements here for reset)
            const testProgressArea = document.getElementById('test_progress_area');
            const testProgressBar = document.getElementById('test_progress_bar');
            const testProgressStatus = document.getElementById('test_progress_status');
            const testProgressLogContainer = document.getElementById('test_progress_log_container');
            const testResultsLinkArea = document.getElementById('test_results_link_area');
            if(testProgressArea) testProgressArea.style.display = 'block';
            if(testProgressLogContainer) testProgressLogContainer.style.display = 'block';
            // Reset log content using helper
            addTestLogItem(""); // Clears by potentially removing old items if list was full
            const initialLogEl = document.getElementById('test_progress_log'); if(initialLogEl) initialLogEl.innerHTML = ''; // Explicit clear
            
            if(testProgressBar) { testProgressBar.style.width = '0%'; testProgressBar.textContent = '0%'; testProgressBar.classList.remove('bg-success', 'bg-danger'); testProgressBar.classList.add('bg-info'); }
            if(testProgressStatus) testProgressStatus.textContent = 'Initializing test screening...';
            if(testResultsLinkArea) testResultsLinkArea.style.display = 'none';
            startTestScreenButton.disabled = true;
            window.loggedTestLogError = false; // Reset log flag for this run

            const formData = new FormData(); 
            formData.append('file', testFileInput.files[0]); 
            formData.append('sample_size', sampleSize);
            // --- NEW: Append filter data to FormData for Test Screening ---
            if (testTitleFilterInput && testTitleFilterInput.value) {
                formData.append('title_text_filter', testTitleFilterInput.value.trim());
            }
            if (testLineRangeInput && testLineRangeInput.value) {
                formData.append('line_range_filter', testLineRangeInput.value.trim());
            }
            // --- END NEW ---

            const xhrTest = new XMLHttpRequest(); 
            console.log("Initiating Test XHR Request...");
            xhrTest.open("POST", "{{ url_for('stream_test_screen_file') }}", true);
            // Add timeout setting
            xhrTest.timeout = 1800000; // 30 minutes timeout
            let lastTestCharIndex = 0;

            // Use try-catch around all DOM operations in XHR callback
            xhrTest.onprogress = function() {
                try {
                    const newText = xhrTest.responseText.substring(lastTestCharIndex);
                    lastTestCharIndex = xhrTest.responseText.length;
                    
                    // Check for empty or invalid response 
                    if (!newText || newText.trim() === '') {
                        return; // Skip processing empty updates
                    }
                    
                    // Set a flag to track if any message was processed
                    let processedAnyMessage = false;
                    
                    // Process the response directly
                    const messages = newText.split('\n\n');
                    messages.forEach(message => {
                        if (message.startsWith("data: ")) {
                            try {
                                let jsonString = message.substring(6).trim();
                                // Fix any JSON issues
                                if (jsonString.includes('"\n') || jsonString.includes('"\r')) {
                                    jsonString = jsonString.replace(/"\r|\n/g, '"');
                                }
                                
                                // Validate JSON before parsing
                                if (!jsonString || jsonString === '' || 
                                    !jsonString.includes('{') || !jsonString.includes('}')) {
                                    console.warn("Skipping invalid JSON:", jsonString);
                                    return;
                                }
                                
                                const jsonData = JSON.parse(jsonString);
                                processedAnyMessage = true;
                                
                                // Process based on message type
                                if (jsonData.type === 'start') {
                                    safeGetElement('test_progress_log').innerHTML = '';
                                    safeGetElement('test_progress_status').textContent = `Starting... Total: ${jsonData.total}`;
                                    safeGetElement('test_progress_area').style.display = 'block';
                                    safeGetElement('test_progress_log_container').style.display = 'block';
                                    // Add initial log
                                    let startMsg = `[${new Date().toLocaleTimeString()}] Started test screening. Total: ${jsonData.total}`;
                                    if (jsonData.filter_info && jsonData.filter_info !== 'all entries') {
                                        startMsg += ` (Filter: ${jsonData.filter_info})`;
                                    }
                                    safeGetElement('test_progress_log').innerHTML += startMsg + '<br>';
                                    
                                } else if (jsonData.type === 'progress') {
                                    // Update progress bar
                                    safelyUpdateProgress(safeGetElement('test_progress_bar'), jsonData.percentage);
                                    // Update status
                                    safeGetElement('test_progress_status').textContent = 
                                        `Processing ${jsonData.count}/${jsonData.total}: ${jsonData.current_item_title ? jsonData.current_item_title.substring(0,40) : 'Item'}...`;
                                    
                                    // Add log entry
                                    let decisionClass = jsonData.decision ? 'log-decision-' + jsonData.decision.toUpperCase().replace('API_','').replace('HTTP_ERROR_','ERROR_') : '';
                                    const logEntry = `[${new Date().toLocaleTimeString()}] Item ${jsonData.count}: ${jsonData.current_item_title ? jsonData.current_item_title.substring(0,30) : 'Item'}... <span class="log-item-decision ${decisionClass}">${jsonData.decision || ''}</span>`;
                                    
                                    // Add info about missing abstract if applicable
                                    if (jsonData.has_missing_abstract) {
                                        safeGetElement('test_progress_log').innerHTML += logEntry + ' <span class="missing-field">[缺少摘要]</span><br>';
                                    } else if (jsonData.has_missing_fields) {
                                        safeGetElement('test_progress_log').innerHTML += logEntry + ' <span class="missing-field">[缺少字段]</span><br>';
                                    } else {
                                        safeGetElement('test_progress_log').innerHTML += logEntry + '<br>';
                                    }
                                    
                                } else if (jsonData.type === 'complete') {
                                    // Update status
                                    safeGetElement('test_progress_status').textContent = jsonData.message;
                                    safeGetElement('test_progress_log').innerHTML += `[${new Date().toLocaleTimeString()}] ${jsonData.message}<br>`;
                                    
                                    // Set up link if available
                                    if (jsonData.session_id) {
                                        let baseUrl = "{{ url_for('show_test_results', session_id='__SESSION_ID__') }}";
                                        safeGetElement('view_test_results_link').href = baseUrl.replace('__SESSION_ID__', jsonData.session_id);
                                        safeGetElement('test_results_link_area').style.display = 'block';
                                    }
                                    
                                    xhrTest.abort();
                                    finalizeTestButton();
                                    
                                } else if (jsonData.type === 'error') {
                                    // Display error
                                    safeGetElement('test_progress_status').textContent = `Error: ${jsonData.message}`;
                                    let errorMsg = `[${new Date().toLocaleTimeString()}] Error: ${jsonData.message}`;
                                    if (jsonData.needs_config) {
                                        const configUrl = "{{ url_for('llm_config_page') }}";
                                        errorMsg += ` <a href="${configUrl}" target="_blank">Please configure API Key.</a>`;
                                    }
                                    safeGetElement('test_progress_log').innerHTML += errorMsg + '<br>';
                                    
                                    xhrTest.abort();
                                    finalizeTestButton();
                                }
                            } catch (e) {
                                console.error("Test JSON parse error:", e);
                                safeGetElement('test_progress_status').textContent = `Error parsing response: ${e.message}`;
                            }
                        }
                    });
                } catch (e) {
                    console.error("Test XHR processing error:", e);
                    safeGetElement('test_progress_status').textContent = "Error processing response";
                    finalizeTestButton();
                }
            };
            
            // Add timeout handler
            xhrTest.ontimeout = function() {
                console.error("Test XHR request timeout");
                safeGetElement('test_progress_status').textContent = "Request timeout, try processing fewer documents";
            };
            
            xhrTest.onloadend = function() { 
                console.log("Test XHR request finished"); 
                finalizeTestButton(); 
            }; 
            
            xhrTest.onerror = function() { 
                console.error("Test XHR request error"); 
                safeGetElement('test_progress_status').textContent = "Request error, please refresh page and try again";
            };
            
            xhrTest.send(formData);
        }); 
    }

    // --- Full Screening SSE Logic (Apply same pattern) ---
    if (startFullScreenButton) {
        console.log("Adding listener to Full Screen Button."); 
        startFullScreenButton.addEventListener('click', function() {
             console.log(">>> Full Screen Button CLICKED!");
             const fileInput = document.getElementById('full_file_progress');
             if (!fileInput || !fileInput.files || fileInput.files.length === 0) { alert('Select file...'); return; }
             console.log("Full Screening initiated.");
             
             // Check file size, optimize if large
             const fileSize = fileInput.files[0].size;
             if(fileSize > 500000) { // Files larger than 500KB are considered large
                 console.log("Large file detected, activating performance optimization mode");
                 optimizeForLargeVolume();
             }
             
             // Reset UI 
             const progressArea = document.getElementById('progress_area');
             const progressLogContainer = document.getElementById('progress_log_container');
             const progressLog = document.getElementById('progress_log');
             const progressBar = document.getElementById('progress_bar');
             const progressStatus = document.getElementById('progress_status');
             const sseResultsLinkArea = document.getElementById('sse_results_link_area');
             if(progressArea) progressArea.style.display = 'block';
             if(progressLogContainer) progressLogContainer.style.display = 'block';
             addLogItem(""); 
             const initialFullLogEl = document.getElementById('progress_log'); if(initialFullLogEl) initialFullLogEl.innerHTML = '';

             if(progressBar) {progressBar.style.width = '0%'; progressBar.textContent = '0%'; progressBar.classList.remove('bg-success','bg-danger');}
             if(progressStatus) progressStatus.textContent = 'Initializing...';
             if(sseResultsLinkArea) sseResultsLinkArea.style.display = 'none';
             startFullScreenButton.disabled = true;
             window.loggedFullLogError = false; 
             
             const formData = new FormData(); 
             formData.append('file', fileInput.files[0]);
             const titleFilterInput = document.getElementById('title_text_filter');
             const lineRangeInput = document.getElementById('line_range_filter');
             if (titleFilterInput && titleFilterInput.value) {
                 formData.append('title_text_filter', titleFilterInput.value.trim());
             }
             if (lineRangeInput && lineRangeInput.value) {
                 formData.append('line_range_filter', lineRangeInput.value.trim());
             }

             const xhr = new XMLHttpRequest(); 
             console.log("Initiating Full XHR Request...");
             xhr.open("POST", "{{ url_for('stream_screen_file') }}", true);
             // Add timeout setting
             xhr.timeout = 7200000; // 2 hours timeout
             let lastCharIndex = 0;
             
             // Use try-catch around all DOM operations in XHR callback
             xhr.onprogress = function() {
                 try {
                     const newText = xhr.responseText.substring(lastCharIndex);
                     lastCharIndex = xhr.responseText.length;
                     
                     // Check for empty or invalid response 
                     if (!newText || newText.trim() === '') {
                         return; // Skip processing empty updates
                     }
                     
                     // Set a flag to track if any message was processed
                     let processedAnyMessage = false;
                     
                     // Process the response directly
                     const messages = newText.split('\n\n');
                     messages.forEach(message => {
                         if (message.startsWith("data: ")) {
                             try {
                                 let jsonString = message.substring(6).trim();
                                 // Fix any JSON issues
                                 if (jsonString.includes('"\n') || jsonString.includes('"\r')) {
                                     jsonString = jsonString.replace(/"\r|\n/g, '"');
                                 }
                                 
                                 // Validate JSON before parsing
                                 if (!jsonString || jsonString === '' || 
                                     !jsonString.includes('{') || !jsonString.includes('}')) {
                                     console.warn("Skipping invalid JSON:", jsonString);
                                     return;
                                 }
                                 
                                 const jsonData = JSON.parse(jsonString);
                                 processedAnyMessage = true;
                                 
                                 // Store last processed data for recovery
                                 window._lastProcessedData = {
                                     type: jsonData.type,
                                     count: jsonData.count,
                                     total: jsonData.total,
                                     timestamp: new Date().getTime()
                                 };
                                 
                                 // Process based on message type
                                 if (jsonData.type === 'start') {
                                     safeGetElement('progress_log').innerHTML = '';
                                     safeGetElement('progress_status').textContent = `Screening ${jsonData.total} items...`;
                                     safeGetElement('progress_area').style.display = 'block';
                                     safeGetElement('progress_log_container').style.display = 'block';
                                     // Add initial log
                                     let startMsg = `[${new Date().toLocaleTimeString()}] Started screening. Total: ${jsonData.total}`;
                                     if (jsonData.filter_info && jsonData.filter_info !== 'all entries') {
                                         startMsg += ` (Filter: ${jsonData.filter_info})`;
                                     }
                                     safeGetElement('progress_log').innerHTML += startMsg + '<br>';
                                     
                                 } else if (jsonData.type === 'progress') {
                                     // Update progress bar
                                     safelyUpdateProgress(safeGetElement('progress_bar'), jsonData.percentage);
                                     // Update status
                                     safeGetElement('progress_status').textContent = 
                                         `Processing ${jsonData.count}/${jsonData.total}: ${jsonData.current_item_title ? jsonData.current_item_title.substring(0,40) : 'Item'}...`;
                                     
                                     // Skip some updates for large datasets to improve performance
                                     if (window._optimizationCounter && window._skipDomUpdate && window._skipDomUpdate() &&
                                         !jsonData.decision && // Never skip items with decisions
                                         !jsonData.has_missing_abstract && // Never skip items with missing abstracts
                                         !jsonData.has_missing_fields) { // Never skip items with missing fields
                                         return;
                                     }
                                     
                                     // Add log entry
                                     let decisionClass = jsonData.decision ? 'log-decision-' + jsonData.decision.toUpperCase().replace('API_','').replace('HTTP_ERROR_','ERROR_') : '';
                                     const logEntry = `[${new Date().toLocaleTimeString()}] Item ${jsonData.count}: ${jsonData.current_item_title ? jsonData.current_item_title.substring(0,30) : 'Item'}... <span class="log-item-decision ${decisionClass}">${jsonData.decision || ''}</span>`;
                                     
                                     // Add info about missing abstract if applicable
                                     if (jsonData.has_missing_abstract) {
                                         safeGetElement('progress_log').innerHTML += logEntry + ' <span class="missing-field">[缺少摘要]</span><br>';
                                     } else if (jsonData.has_missing_fields) {
                                         safeGetElement('progress_log').innerHTML += logEntry + ' <span class="missing-field">[缺少字段]</span><br>';
                                     } else {
                                         safeGetElement('progress_log').innerHTML += logEntry + '<br>';
                                     }
                                     
                                 } else if (jsonData.type === 'complete') {
                                     // Update status
                                     safeGetElement('progress_bar').classList.add('bg-success');
                                     safeGetElement('progress_bar').textContent = 'Complete';
                                     safeGetElement('progress_status').textContent = jsonData.message;
                                     safeGetElement('progress_log').innerHTML += `[${new Date().toLocaleTimeString()}] ${jsonData.message}<br>`;
                                     
                                     // Store success info in sessionStorage for recovery
                                     try {
                                         sessionStorage.setItem('lastScreeningComplete', 'true');
                                         sessionStorage.setItem('lastScreeningId', jsonData.screening_id || '');
                                         sessionStorage.setItem('lastScreeningTime', new Date().toISOString());
                                     } catch (e) {
                                         console.warn("Could not save to sessionStorage:", e);
                                     }
                                     
                                     // Set up link if available
                                     if (jsonData.screening_id) {
                                         let baseUrl = "{{ url_for('show_screening_results', screening_id='__SCREENING_ID__') }}";
                                         safeGetElement('view_full_results_link').href = baseUrl.replace('__SCREENING_ID__', jsonData.screening_id);
                                         safeGetElement('sse_results_link_area').style.display = 'block';
                                     }
                                     
                                     xhr.abort();
                                     finalizeButtons();
                                     
                                 } else if (jsonData.type === 'error') {
                                     // Display error
                                     safeGetElement('progress_bar').classList.add('bg-danger');
                                     safeGetElement('progress_bar').textContent = 'Error';
                                     safeGetElement('progress_status').textContent = `Error: ${jsonData.message}`;
                                     let errorMsg = `[${new Date().toLocaleTimeString()}] Error: ${jsonData.message}`;
                                     if (jsonData.needs_config) {
                                         const configUrl = "{{ url_for('llm_config_page') }}";
                                         errorMsg += ` <a href="${configUrl}" target="_blank">Please configure API Key.</a>`;
                                     }
                                     safeGetElement('progress_log').innerHTML += errorMsg + '<br>';
                                     
                                     xhr.abort();
                                     finalizeButtons();
                                 }
                             } catch (e) {
                                 console.error("Full JSON parse error:", e);
                                 safeGetElement('progress_status').textContent = `Error parsing response: ${e.message}`;
                             }
                         }
                     });
                 } catch (e) {
                     console.error("Full XHR processing error:", e);
                     safeGetElement('progress_status').textContent = "Error processing response";
                     finalizeButtons();
                 }
             };
             
             // Add timeout handler with much longer timeout for cloud environment
             xhr.timeout = 7200000; // 2 hours timeout
             xhr.ontimeout = function() {
                 console.error("XHR request timeout");
                 safeGetElement('progress_status').textContent = "Request timeout, processing may be continuing in the background";
                 
                 // Store last state in sessionStorage
                 try {
                     if (window._lastProcessedData) {
                         sessionStorage.setItem('lastScreeningState', JSON.stringify(window._lastProcessedData));
                     }
                 } catch (e) {
                     console.warn("Could not save state to sessionStorage:", e);
                 }
                 
                 // Set up recovery message
                 const recoveryMsg = `[${new Date().toLocaleTimeString()}] Connection timeout - processing may continue in the background. Refresh page and check results later.`;
                 safeGetElement('progress_log').innerHTML += `<span style="color:darkorange;font-weight:bold;">${recoveryMsg}</span><br>`;
                 
                 finalizeButtons();
             };
             
             xhr.onloadend = function() { 
                 console.log("XHR request finished");
                 
                 // Check if we actually got a complete response
                 if (!sessionStorage.getItem('lastScreeningComplete')) {
                     console.log("Request finished but no completion message received");
                     const timeoutMsg = `[${new Date().toLocaleTimeString()}] Request finished but no completion message received. Processing may continue in the background. Check results later.`;
                     safeGetElement('progress_log').innerHTML += `<span style="color:darkorange;font-weight:bold;">${timeoutMsg}</span><br>`;
                 }
                 
                 finalizeButtons(); 
             };
             
             // Add a watchdog to detect stalled connections
             window._progressWatchdog = setTimeout(function() {
                 console.log("Watchdog checking connection status...");
                 
                 // Check if we haven't received updates in the last 2 minutes
                 const now = new Date().getTime();
                 const lastUpdate = window._lastProcessedData ? window._lastProcessedData.timestamp : 0;
                 
                 if (now - lastUpdate > 120000) { // 2 minutes
                     console.warn("Connection appears stalled - last update was more than 2 minutes ago");
                     
                     // Is XHR still active?
                     if (xhr.readyState !== 4) {
                         console.log("XHR still active but no updates - suggesting to check results later");
                         safeGetElement('progress_status').textContent = "Connection is slow - processing continues in background";
                         
                         const stalledMsg = `[${new Date().toLocaleTimeString()}] Connection is slow - processing continues in the background. Check results page later.`;
                         safeGetElement('progress_log').innerHTML += `<span style="color:darkorange;font-weight:bold;">${stalledMsg}</span><br>`;
                     }
                 }
                 
                 // Reschedule the watchdog
                 window._progressWatchdog = setTimeout(arguments.callee, 60000); // Check every minute
             }, 120000); // First check after 2 minutes
             
             xhr.send(formData);
        }); 
    } 

    // Clean up timers and other resources when page unloads
    window.addEventListener('beforeunload', function() {
        if(window._cleanupInterval) {
            clearInterval(window._cleanupInterval);
        }
        
        // Clean up watchdog timer
        if(window._progressWatchdog) {
            clearTimeout(window._progressWatchdog);
        }
        
        // Disconnect observers
        // No longer needed with direct log management
        /*
        ['progress_log', 'test_progress_log'].forEach(id => {
            const observer = window[`_observer_${id}`];
            if (observer && observer.disconnect) {
                observer.disconnect();
            }
        });
        */
        
        // Clean up other possible resources
        if(window.xhr) {
            try { window.xhr.abort(); } catch(e) { console.warn('Error aborting xhr', e); }
        }
        if(window.xhrTest) {
            try { window.xhrTest.abort(); } catch(e) { console.warn('Error aborting xhrTest', e); }
        }
    });

    // Initialize accordion behavior
    $('#abstractScreeningAccordion .collapse').on('show.bs.collapse', function () {
        $(this).parent().find('.bi-chevron-down').removeClass('bi-chevron-down').addClass('bi-chevron-up');
    }).on('hide.bs.collapse', function () {
        $(this).parent().find('.bi-chevron-up').removeClass('bi-chevron-up').addClass('bi-chevron-down');
    });

}); 

// Add a separate wrapper function to ensure we're not trying to modify DOM too quickly
function safelyUpdateProgress(barElement, percentage, updateText = true) {
    // Throttle DOM updates to prevent conflicts with external libraries
    try {
        if (barElement) {
            barElement.style.width = percentage + '%';
            if (updateText) {
                barElement.textContent = percentage + '%';
            }
        }
    } catch (e) {
        console.error("Error updating progress bar:", e);
    }
}
</script>
{% endblock %}