{% extends "base.html" %}

{% block title %}LLM Configuration - AI Literature Screening Assistant{% endblock %}

{% block extra_head %}
<style>
    .api-key-status-badge {
        padding: 0.15em 0.3em;
        border-radius: 3px;
        font-size: 0.65em;
        font-weight: 600;
        margin-left: 3px;
        transition: all 0.2s ease;
    }
    .status-set-in-session { background-color: #059669; color: white; }
    .status-env-default { background-color: #0891b2; color: white; }
    .status-not-set { background-color: #dc3545; color: white; }
    .clear-key-btn {
        margin-left: 6px;
        font-size: 0.75em;
        padding: 0.15rem 0.3rem;
        border-radius: 3px;
        transition: all 0.2s ease;
    }
    .clear-key-btn:hover {
        background-color: #ef4444;
        color: white;
    }
    /* Styles for AJAX messages and animations */
    .form-message {
        padding: 10px;
        margin-top: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        opacity: 0;
        max-height: 0;
        overflow: hidden;
        transition: opacity 0.4s ease-in-out, max-height 0.4s ease-in-out, padding 0.4s ease-in-out, margin 0.4s ease-in-out;
        box-sizing: border-box;
        box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        font-size: 0.85rem;
    }
    .form-message.show {
        opacity: 1;
        max-height: 80px;
        padding: 10px;
        margin-top: 10px;
        margin-bottom: 10px;
    }
    .form-message.success {
        background-color: #ecfdf5;
        color: #047857;
        border-left: 3px solid #059669;
    }
    .form-message.error {
        background-color: #fef2f2;
        color: #b91c1c;
        border-left: 3px solid #dc2626;
    }
    
    /* Enhanced card styling */
    .section-card {
        box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 1px 2px rgba(0,0,0,0.04);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border-radius: 6px;
        padding: 1rem;
    }
    .section-card:hover {
        box-shadow: 0 2px 4px rgba(0,0,0,0.03), 0 1px 3px rgba(0,0,0,0.04);
    }
    
    /* Form control enhancements */
    .form-control {
        box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        transition: all 0.2s ease;
        font-size: 0.8rem;
        padding: 0.25rem 0.4rem;
        height: calc(1.5em + 0.6rem + 2px);
    }
    .form-control:focus {
        box-shadow: 0 0 0 2px rgba(123, 44, 191, 0.1);
        transform: translateY(-1px);
    }
    
    /* Input group styling */
    .input-group-append button {
        border-top-right-radius: 4px !important;
        border-bottom-right-radius: 4px !important;
        transition: all 0.2s ease;
        font-size: 0.85rem;
        padding: 0.3rem 0.6rem;
    }
    .input-group-append button:hover {
        transform: translateY(-1px);
    }
    
    /* API key input group enhancement */
    .api-key-input-group {
        transition: all 0.2s ease;
        padding: 8px;
        border-radius: 4px;
        margin-top: 6px;
        margin-bottom: 6px;
        background-color: #f9fafb;
        border: 1px solid rgba(0,0,0,0.02);
    }
    .api-key-input-group:hover {
        background-color: #f5f7fa;
    }
    
    /* Modern tooltip icon */
    .tooltip-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        background-color: #e0e7ff;
        color: #4f46e5;
        border-radius: 50%;
        font-size: 10px;
        margin-left: 4px;
        cursor: help;
    }
    
    /* API key info styling */
    .api-key-info {
        background-color: #f0f9ff;
        color: #0369a1;
        padding: 8px 10px;
        border-radius: 4px;
        margin-bottom: 12px;
        font-size: 0.8em;
        border-left: 2px solid #0ea5e9;
        box-shadow: 0 1px 2px rgba(0,0,0,0.02);
    }
    
    /* Page Exit Animation Enhancement */
    .page-transition-exit {
        opacity: 1;
        transition: opacity 0.6s cubic-bezier(0.19, 1, 0.22, 1), transform 0.6s cubic-bezier(0.19, 1, 0.22, 1);
    }
    .page-transition-exit-active {
        opacity: 0;
        transform: translateY(-5px);
    }
    
    /* Enhanced Transition message styles */
    .transition-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.95);
        background: rgba(15, 23, 42, 0.85);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        z-index: 1000;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.215, 0.61, 0.355, 1);
        font-size: 14px;
        font-weight: 500;
        letter-spacing: 0.2px;
        text-align: center;
        min-width: 240px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .transition-message.show {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
    
    /* Modern Pulse Dot Animation */
    .loading-spinner {
        display: inline-flex;
        align-items: center;
        margin-left: 10px;
        height: 16px;
        vertical-align: middle;
    }
    .loading-spinner .dot {
        display: inline-block;
        width: 5px;
        height: 5px;
        margin: 0 2px;
        border-radius: 50%;
        background-color: #ffffff;
        animation: pulse 1.4s infinite ease-in-out;
    }
    .loading-spinner .dot:nth-child(1) {
        animation-delay: -0.32s;
    }
    .loading-spinner .dot:nth-child(2) {
        animation-delay: -0.16s;
    }
    @keyframes pulse {
        0%, 80%, 100% { 
            transform: scale(0.6);
            opacity: 0.6;
        }
        40% { 
            transform: scale(1);
            opacity: 1;
        }
    }
    
    /* Submit button enhancement */
    .submit-btn {
        padding: 0.3rem 0.7rem;
        background: linear-gradient(135deg, #7B2CBF 0%, #9B5DE5 100%);
        border: none;
        box-shadow: 0 1px 3px rgba(123, 44, 191, 0.08);
        transition: all 0.2s ease;
        margin-top: 6px;
        font-size: 0.8rem;
        font-weight: 500;
        border-radius: 4px;
    }
    .submit-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(123, 44, 191, 0.12);
        background: linear-gradient(135deg, #8a3ad0 0%, #a56ce8 100%);
    }
    .submit-btn:active {
        transform: translateY(1px);
        box-shadow: 0 1px 3px rgba(123, 44, 191, 0.1);
    }
    
    /* Reduce text sizes */
    h2 {
        font-size: 1.3rem;
        margin-bottom: 0.75rem;
    }
    h3 {
        font-size: 1.1rem;
        margin-bottom: 0.75rem;
    }
    p, .text-muted {
        font-size: 0.85rem;
    }
    small {
        font-size: 0.75rem;
    }
    label {
        font-size: 0.85rem;
        margin-bottom: 0.25rem;
    }
    .form-text {
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="section-card" id="main-content">
    <h2 class="mb-3">
        <i class="fas fa-cog mr-1" style="color: var(--primary-color); font-size: 0.9em;"></i>
        LLM Configuration
    </h2>
    <p class="api-key-info">
        <i class="fas fa-key mr-1"></i> Select LLM and provide/manage API keys below. API keys are stored only in your browser session for the current visit.
    </p>
    <!-- Message area for AJAX responses -->
    <div id="llmConfigMessage" class="form-message"></div>

    <form id="llm_config_form" method="POST" action="{{ url_for('configure_llm') }}">
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="llm_provider"><i class="fas fa-server mr-1"></i> LLM Provider:</label>
                    <select name="llm_provider" id="llm_provider" class="form-control form-control-sm">
                        {% for provider_name, provider_data in llm_providers_info.items() %}
                            <option value="{{ provider_name }}" {% if provider_name == current_llm_provider %}selected{% endif %}>
                                {{ provider_name.replace('_', ' ') }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="llm_model_id"><i class="fas fa-robot mr-1"></i> Model:</label>
                    <select name="llm_model_id" id="llm_model_id" class="form-control form-control-sm"></select>
                </div>
            </div>
        </div>
        
        {% for provider_name_key, provider_data_val in llm_providers_info.items() %}
        <div class="form-group api-key-input-group" id="{{ provider_name_key.lower() }}_api_key_group" style="display: none;">
            <label for="{{ provider_name_key.lower() }}_api_key">
                <i class="fas fa-lock mr-1"></i> {{ provider_name_key.replace('_', ' ') }} API Key:
            </label>
            <div class="input-group input-group-sm">
                <input type="password" name="{{ provider_name_key.lower() }}_api_key" id="{{ provider_name_key.lower() }}_api_key" 
                       class="form-control form-control-sm" placeholder="Enter API Key here">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary btn-sm" type="button" 
                            onclick="toggleApiKeyVisibility('{{ provider_name_key.lower() }}_api_key')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-primary btn-sm ml-1" type="button" 
                            onclick="testApiKey('{{ provider_name_key }}', '{{ provider_name_key.lower() }}_api_key')">
                        <i class="fas fa-vial mr-1"></i> Test
                    </button>
                </div>
            </div>
            <div class="mt-1">
                <small class="form-text text-muted d-inline">Status: </small>
                <span id="{{ provider_name_key.lower() }}_api_key_status_badge" class="api-key-status-badge">
                    <!-- Status text will be populated by JS -->
                </span>
                <button type="submit" name="clear_api_key" value="{{ provider_name_key }}" 
                        id="clear_{{ provider_name_key.lower() }}_api_key_btn" 
                        class="btn btn-outline-danger btn-sm clear-key-btn" 
                        style="display: none;" 
                        title="Clear API Key from session for {{ provider_name_key.replace('_', ' ') }}">
                    <i class="fas fa-trash-alt mr-1"></i> Clear
                </button>
                <span id="{{ provider_name_key.lower() }}_tooltip_icon" class="tooltip-icon" style="display:none;" 
                      title="This key is set via environment variables. Keys set in session take precedence.">
                    <i class="fas fa-info"></i>
                </span>
            </div>
            <small class="form-text text-muted mt-1">
                {% if provider_data_val.api_key_info_url %}
                    <i class="fas fa-external-link-alt mr-1"></i> Get your {{ provider_name_key.replace('_', ' ') }} API key from <a href="{{ provider_data_val.api_key_info_url }}" target="_blank" rel="noopener noreferrer">their platform</a>.
                {% elif provider_name_key == 'DeepSeek' %}
                    <i class="fas fa-external-link-alt mr-1"></i> Get your DeepSeek API key from the <a href="https://platform.deepseek.com/" target="_blank" rel="noopener noreferrer">DeepSeek Platform</a>.
                {% elif provider_name_key == 'OpenAI_ChatGPT' %}
                    <i class="fas fa-external-link-alt mr-1"></i> Get your OpenAI API key from <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener noreferrer">OpenAI API Keys</a>.
                {% elif provider_name_key == 'Google_Gemini' %}
                    <i class="fas fa-external-link-alt mr-1"></i> Get your Gemini API key from <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Google AI Studio</a>.
                {% elif provider_name_key == 'Anthropic_Claude' %}
                    <i class="fas fa-external-link-alt mr-1"></i> Get your Anthropic API key from <a href="https://console.anthropic.com/settings/keys" target="_blank" rel="noopener noreferrer">Anthropic Console</a>.
                {% else %}
                    <i class="fas fa-info-circle mr-1"></i> API key required. Please refer to the provider's documentation.
                {% endif %}
            </small>
        </div>
        {% endfor %}
        <button type="submit" name="save_llm_config" value="true" class="btn btn-primary btn-sm submit-btn">
            <i class="fas fa-save mr-1"></i> Save LLM Config & API Key
        </button>
    </form>
</div>

<!-- Enhanced transition message that shows during page transition -->
<div id="transitionMessage" class="transition-message">
    <div><i class="fas fa-check-circle mr-1" style="font-size: 16px;"></i> Configuration successful!</div>
    <div style="margin-top: 8px; display: flex; align-items: center; justify-content: center;">
        Redirecting to Screening Criteria
        <div class="loading-spinner">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Get the JSON string from Jinja2, ensuring it's treated as a JS string
    const llmProvidersDataJSON = '{{ llm_providers_info | tojson | safe }}'; 
    const apiKeyStatusesJSON = '{{ api_key_status | tojson | safe }}';

    // Parse the JSON strings into JavaScript objects
    const llmProvidersData = JSON.parse(llmProvidersDataJSON);
    const apiKeyStatuses = JSON.parse(apiKeyStatusesJSON);

    const currentProviderFromServer = "{{ current_llm_provider | default('', true) }}";
    const currentModelIdFromServer = "{{ current_llm_model_id | default('', true) }}";

    function updateModelOptions(selectedProvider, selectedModelId) {
        const modelSelect = document.getElementById('llm_model_id');
        modelSelect.innerHTML = ''; 
        if (llmProvidersData[selectedProvider] && llmProvidersData[selectedProvider].models) {
            llmProvidersData[selectedProvider].models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.display_name + " (" + (model.type || 'N/A') + ")"; 
                if (model.id === selectedModelId) {
                    option.selected = true;
                }
                modelSelect.appendChild(option);
            });
            if (modelSelect.selectedIndex === -1 && modelSelect.options.length > 0) {
                modelSelect.options[0].selected = true;
            }
        }
    }

    function updateApiKeyDisplay(selectedProvider) {
        document.querySelectorAll('.api-key-input-group').forEach(group => {
            group.style.display = 'none';
        });
        const currentGroup = document.getElementById(selectedProvider.toLowerCase() + '_api_key_group');
        if (currentGroup) {
            currentGroup.style.display = 'block';
            const statusBadge = document.getElementById(selectedProvider.toLowerCase() + '_api_key_status_badge');
            const clearButton = document.getElementById('clear_' + selectedProvider.toLowerCase() + '_api_key_btn');
            const tooltipIcon = document.getElementById(selectedProvider.toLowerCase() + '_tooltip_icon');

            const status = apiKeyStatuses[selectedProvider] || 'Not set';
            if (statusBadge) {
                statusBadge.textContent = status;
                statusBadge.className = 'api-key-status-badge'; 
                if (status === 'Set in session') {
                    statusBadge.classList.add('status-set-in-session');
                    if (clearButton) clearButton.style.display = 'inline-block';
                    if (tooltipIcon) tooltipIcon.style.display = 'none';
                } else if (status === 'Using environment default') {
                    statusBadge.classList.add('status-env-default');
                    if (clearButton) clearButton.style.display = 'none'; 
                    if (tooltipIcon) tooltipIcon.style.display = 'inline-block';
                } else { 
                    statusBadge.classList.add('status-not-set');
                    if (clearButton) clearButton.style.display = 'none';
                    if (tooltipIcon) tooltipIcon.style.display = 'none';
                }
            }
        }
    }

    function toggleApiKeyVisibility(inputId) {
        const input = document.getElementById(inputId);
        const button = input.parentElement.querySelector('button');
        if (input.type === "password") {
            input.type = "text";
            button.innerHTML = '<i class="fas fa-eye-slash"></i>';
        } else {
            input.type = "password";
            button.innerHTML = '<i class="fas fa-eye"></i>';
        }
    }

    function testApiKey(provider, apiKeyInputId) {
        const apiKeyInput = document.getElementById(apiKeyInputId);
        const apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';
        const messageDiv = document.getElementById('llmConfigMessage');
        
        if (!apiKey) {
            messageDiv.textContent = 'Please enter an API key before testing.';
            messageDiv.className = 'form-message error show';
            return;
        }
        
        // Show testing message
        messageDiv.textContent = `Testing ${provider.replace('_', ' ')} API key...`;
        messageDiv.className = 'form-message show';
        
        // Get the test button and disable it during test
        const testButton = apiKeyInput.parentElement.querySelector('button[onclick^="testApiKey"]');
        const originalButtonText = testButton.innerHTML;
        testButton.disabled = true;
        testButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        // Create form data for API request
        const formData = new FormData();
        formData.append('test_api_key', 'true');
        formData.append('provider', provider);
        formData.append(`${provider.toLowerCase()}_api_key`, apiKey);
        
        // Send request to test the API key
        fetch('{{ url_for("test_api_key") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            testButton.disabled = false;
            testButton.innerHTML = originalButtonText;
            
            if (data.status === 'success') {
                messageDiv.innerHTML = `<i class="fas fa-check-circle mr-1"></i> ${data.message || 'API key validated successfully!'}`;
                messageDiv.className = 'form-message success show';
            } else {
                messageDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> ${data.message || 'API key validation failed. Please check your key.'}`;
                messageDiv.className = 'form-message error show';
            }
        })
        .catch(error => {
            console.error('Error testing API key:', error);
            testButton.disabled = false;
            testButton.innerHTML = originalButtonText;
            
            messageDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i> A network error occurred while testing the API key. Please try again.';
            messageDiv.className = 'form-message error show';
        });
    }

    // Enhanced smooth page transition when redirecting
    function smoothRedirect(url, delay = 600) {
        // Show transition message - no need to set text content as it's already in the HTML
        const transitionMsg = document.getElementById('transitionMessage');
        transitionMsg.classList.add('show');
        
        // Start the exit animation
        const mainContent = document.getElementById('main-content');
        mainContent.classList.add('page-transition-exit');
        
        // Wait a short moment for animation to start
        setTimeout(() => {
            mainContent.classList.add('page-transition-exit-active');
            
            // Wait for animation to complete before redirecting
            setTimeout(() => {
                window.location.href = url;
            }, delay);
        }, 50);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const providerSelect = document.getElementById('llm_provider');
        const configForm = document.getElementById('llm_config_form');
        const messageDiv = document.getElementById('llmConfigMessage'); // Get the message div

        if (currentProviderFromServer && llmProvidersData[currentProviderFromServer]) {
            updateModelOptions(currentProviderFromServer, currentModelIdFromServer);
            updateApiKeyDisplay(currentProviderFromServer);
        } else if (providerSelect.options.length > 0) {
            const firstProvider = providerSelect.options[0].value;
            updateModelOptions(firstProvider, null);
            updateApiKeyDisplay(firstProvider);
        }

        providerSelect.addEventListener('change', function() {
            updateModelOptions(this.value, null);
            updateApiKeyDisplay(this.value);
            document.querySelectorAll('.api-key-input-group input[type="password"], .api-key-input-group input[type="text"]').forEach(inputField => {
                if (!inputField.closest('.api-key-input-group').id.startsWith(this.value.toLowerCase())) {
                    inputField.value = '';
                }
            });
        });
        
        if (configForm) {
            configForm.addEventListener('submit', function(event) {
                const clickedButton = event.submitter;

                // If "Clear Key" was clicked, allow default form submission
                if (clickedButton && clickedButton.name === 'clear_api_key') {
                    // No event.preventDefault(), allow traditional submit
                    return;
                }

                event.preventDefault(); // Prevent default submission for LLM config saving

                const formData = new FormData(this);
                const saveButton = configForm.querySelector('button[name="save_llm_config"]');
                const originalButtonText = saveButton.innerHTML;
                saveButton.disabled = true;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                // Clear previous messages
                messageDiv.textContent = '';
                messageDiv.className = 'form-message'; // Reset classes
                
                fetch('{{ url_for("configure_llm") }}', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    // Try to parse JSON regardless of response.ok, as backend might send JSON for errors
                    return response.json().then(data => ({ok: response.ok, status: response.status, data}));
                })
                .then(result => {
                    const data = result.data;
                    
                    if (result.ok && data.status === 'success') {
                        // Validate that the user has provided an API key for the selected provider
                        const selectedProvider = document.getElementById('llm_provider').value;
                        const apiKeyInput = document.getElementById(`${selectedProvider.toLowerCase()}_api_key`);
                        const currentStatus = apiKeyStatuses[selectedProvider] || 'Not set';
                        
                        // If no key is set or provided, warn the user
                        if (currentStatus === 'Not set' && (!apiKeyInput || !apiKeyInput.value.trim())) {
                            messageDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i> Warning: No API key set for ${selectedProvider.replace('_', ' ')}. You may encounter errors when using the application.`;
                            messageDiv.className = 'form-message error show';
                            saveButton.disabled = false;
                            saveButton.innerHTML = originalButtonText;
                            
                            // Ask if user wants to continue without a key
                            if (confirm(`No API key is set for ${selectedProvider.replace('_', ' ')}. Would you like to set up an API key before continuing?`)) {
                                return; // Stop and let the user input a key
                            }
                        }
                        
                        // Proceed with redirect
                        if (data.redirect_url) {
                            smoothRedirect(data.redirect_url);
                        } else {
                            // Fallback if no redirect URL (shouldn't happen)
                            messageDiv.innerHTML = `<i class="fas fa-check-circle mr-1"></i> ${data.message || 'Configuration saved successfully.'}`;
                            messageDiv.className = 'form-message success show';
                            saveButton.disabled = false;
                            saveButton.innerHTML = originalButtonText;
                        }
                    } else {
                        // Handle errors
                        messageDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> ${data.message || 'An unexpected error occurred.'}`;
                        messageDiv.className = 'form-message error show';
                        saveButton.disabled = false;
                        saveButton.innerHTML = originalButtonText;
                    }
                })
                .catch(error => {
                    console.error('Error submitting LLM config:', error);
                    messageDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i> A network error occurred. Please try again.';
                    messageDiv.className = 'form-message error show';
                    saveButton.disabled = false;
                    saveButton.innerHTML = originalButtonText;
                });
            });
        }
    });
</script>
{% endblock %} 