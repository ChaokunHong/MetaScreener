{% extends "base.html" %}

{% block title %}LLM Configuration - AI Literature Screening Assistant{% endblock %}

{% block extra_head %}
<style>
    .api-key-status-badge {
        padding: 0.2em 0.5em;
        border-radius: 0.2rem;
        font-size: 0.8em;
        margin-left: 5px;
    }
    .status-set-in-session { background-color: #28a745; color: white; }
    .status-env-default { background-color: #17a2b8; color: white; }
    .status-not-set { background-color: #dc3545; color: white; }
    .clear-key-btn {
        margin-left: 10px;
        font-size: 0.8em;
        padding: 0.1rem 0.3rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="section-card">
    <h2>LLM Configuration</h2>
    <p class="api-key-info">
        Select LLM and provide/manage API keys below. API keys are stored only in your browser session for the current visit.
    </p>
    <form id="llm_config_form" method="POST" action="{{ url_for('configure_llm') }}">
        <div class="row">
            <div class="col-md-6"><div class="form-group">
                <label for="llm_provider">LLM Provider:</label>
                <select name="llm_provider" id="llm_provider" class="form-control form-control-sm">
                    {% for provider_name, provider_data in llm_providers_info.items() %}
                        <option value="{{ provider_name }}" {% if provider_name == current_llm_provider %}selected{% endif %}>
                            {{ provider_name.replace('_', ' ') }}
                        </option>
                    {% endfor %}
                </select>
            </div></div>
            <div class="col-md-6"><div class="form-group">
                <label for="llm_model_id">Model:</label>
                <select name="llm_model_id" id="llm_model_id" class="form-control form-control-sm"></select>
            </div></div>
        </div>
        {% for provider_name_key, provider_data_val in llm_providers_info.items() %}
        <div class="form-group api-key-input-group" id="{{ provider_name_key.lower() }}_api_key_group" style="display: none;">
            <label for="{{ provider_name_key.lower() }}_api_key">{{ provider_name_key.replace('_', ' ') }} API Key:</label>
            <div class="input-group input-group-sm">
                <input type="password" name="{{ provider_name_key.lower() }}_api_key" id="{{ provider_name_key.lower() }}_api_key" class="form-control form-control-sm" placeholder="Enter API Key here">
                 <div class="input-group-append">
                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="toggleApiKeyVisibility('{{ provider_name_key.lower() }}_api_key')">Show</button>
                </div>
            </div>
            <div class="mt-1">
                <small class="form-text text-muted d-inline">Status: </small>
                <span id="{{ provider_name_key.lower() }}_api_key_status_badge" class="api-key-status-badge">
                    <!-- Status text will be populated by JS -->
                </span>
                <button type="submit" name="clear_api_key" value="{{ provider_name_key }}" 
                        id="clear_{{ provider_name_key.lower() }}_api_key_btn" 
                        class="btn btn-outline-danger btn-sm clear-key-btn" 
                        style="display: none;" 
                        title="Clear API Key from session for {{ provider_name_key.replace('_', ' ') }}">
                    Clear Key
                </button>
                <span id="{{ provider_name_key.lower() }}_tooltip_icon" class="text-info" style="cursor:pointer; display:none;" title="This key is set via environment variables. Keys set in session take precedence.">&#9432;</span>
            </div>
            <small class="form-text text-muted mt-1">
                {% if provider_data_val.api_key_info_url %}
                    Get your {{ provider_name_key.replace('_', ' ') }} API key from <a href="{{ provider_data_val.api_key_info_url }}" target="_blank" rel="noopener noreferrer">their platform</a>.
                {% elif provider_name_key == 'DeepSeek' %}
                    Get your DeepSeek API key from the <a href="https://platform.deepseek.com/" target="_blank" rel="noopener noreferrer">DeepSeek Platform</a>.
                {% elif provider_name_key == 'OpenAI_ChatGPT' %}
                    Get your OpenAI API key from <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener noreferrer">OpenAI API Keys</a>.
                {% elif provider_name_key == 'Google_Gemini' %}
                    Get your Gemini API key from <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Google AI Studio</a>.
                {% elif provider_name_key == 'Anthropic_Claude' %}
                    Get your Anthropic API key from <a href="https://console.anthropic.com/settings/keys" target="_blank" rel="noopener noreferrer">Anthropic Console</a>.
                {% else %}
                    API key required. Please refer to the provider's documentation.
                {% endif %}
            </small>
        </div>
        {% endfor %}
        <button type="submit" name="save_llm_config" value="true" class="btn btn-primary btn-sm">Save LLM Config & API Key</button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Get the JSON string from Jinja2, ensuring it's treated as a JS string
    const llmProvidersDataJSON = '{{ llm_providers_info | tojson | safe }}'; 
    const apiKeyStatusesJSON = '{{ api_key_status | tojson | safe }}';

    // Parse the JSON strings into JavaScript objects
    const llmProvidersData = JSON.parse(llmProvidersDataJSON);
    const apiKeyStatuses = JSON.parse(apiKeyStatusesJSON);

    const currentProviderFromServer = "{{ current_llm_provider | default('', true) }}";
    const currentModelIdFromServer = "{{ current_llm_model_id | default('', true) }}";

    function updateModelOptions(selectedProvider, selectedModelId) {
        const modelSelect = document.getElementById('llm_model_id');
        modelSelect.innerHTML = ''; 
        if (llmProvidersData[selectedProvider] && llmProvidersData[selectedProvider].models) {
            llmProvidersData[selectedProvider].models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.display_name + " (" + (model.type || 'N/A') + ")"; 
                if (model.id === selectedModelId) {
                    option.selected = true;
                }
                modelSelect.appendChild(option);
            });
            if (modelSelect.selectedIndex === -1 && modelSelect.options.length > 0) {
                modelSelect.options[0].selected = true;
            }
        }
    }

    function updateApiKeyDisplay(selectedProvider) {
        document.querySelectorAll('.api-key-input-group').forEach(group => {
            group.style.display = 'none';
        });
        const currentGroup = document.getElementById(selectedProvider.toLowerCase() + '_api_key_group');
        if (currentGroup) {
            currentGroup.style.display = 'block';
            const statusBadge = document.getElementById(selectedProvider.toLowerCase() + '_api_key_status_badge');
            const clearButton = document.getElementById('clear_' + selectedProvider.toLowerCase() + '_api_key_btn');
            const tooltipIcon = document.getElementById(selectedProvider.toLowerCase() + '_tooltip_icon');

            const status = apiKeyStatuses[selectedProvider] || 'Not set';
            if (statusBadge) {
                statusBadge.textContent = status;
                statusBadge.className = 'api-key-status-badge'; 
                if (status === 'Set in session') {
                    statusBadge.classList.add('status-set-in-session');
                    if (clearButton) clearButton.style.display = 'inline-block';
                    if (tooltipIcon) tooltipIcon.style.display = 'none';
                } else if (status === 'Using environment default') {
                    statusBadge.classList.add('status-env-default');
                    if (clearButton) clearButton.style.display = 'none'; 
                    if (tooltipIcon) tooltipIcon.style.display = 'inline-block';
                } else { 
                    statusBadge.classList.add('status-not-set');
                    if (clearButton) clearButton.style.display = 'none';
                    if (tooltipIcon) tooltipIcon.style.display = 'none';
                }
            }
        }
    }

    function toggleApiKeyVisibility(inputId) {
        const input = document.getElementById(inputId);
        const button = input.parentElement.querySelector('button');
        if (input.type === "password") {
            input.type = "text";
            button.textContent = "Hide";
        } else {
            input.type = "password";
            button.textContent = "Show";
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const providerSelect = document.getElementById('llm_provider');
        const configForm = document.getElementById('llm_config_form');

        if (currentProviderFromServer && llmProvidersData[currentProviderFromServer]) {
            updateModelOptions(currentProviderFromServer, currentModelIdFromServer);
            updateApiKeyDisplay(currentProviderFromServer);
        } else if (providerSelect.options.length > 0) {
            const firstProvider = providerSelect.options[0].value;
            updateModelOptions(firstProvider, null);
            updateApiKeyDisplay(firstProvider);
        }

        providerSelect.addEventListener('change', function() {
            updateModelOptions(this.value, null);
            updateApiKeyDisplay(this.value);
            document.querySelectorAll('.api-key-input-group input[type="password"], .api-key-input-group input[type="text"]').forEach(inputField => {
                if (!inputField.closest('.api-key-input-group').id.startsWith(this.value.toLowerCase())) {
                    inputField.value = '';
                }
            });
        });
        
        if (configForm) {
            configForm.addEventListener('submit', function(event) {
                const clickedButton = event.submitter;
                if (clickedButton && clickedButton.name === 'clear_api_key') {
                    return; 
                }

                const selectedProvider = providerSelect.value;
                if (!selectedProvider) { 
                    alert('Please select an LLM Provider.'); 
                    event.preventDefault(); 
                    return; 
                }
                const apiKeyInputId = selectedProvider.toLowerCase() + '_api_key';
                const apiKeyInput = document.getElementById(apiKeyInputId);
                
                const currentStatus = apiKeyStatuses[selectedProvider] || 'Not set';
                if (currentStatus === 'Not set' && apiKeyInput && apiKeyInput.value.trim() === '') {
                    alert("API Key for " + selectedProvider.replace('_',' ') + " is required if not already set. Please enter the key or obtain one from the provider.");
                    event.preventDefault(); 
                    apiKeyInput.focus(); 
                } 
            });
        }
        
        // Re-attach onclick for any dynamically created elements if needed, or ensure direct binding like above.
        // The existing `onclick="toggleApiKeyVisibility(...)"` in the HTML should work directly.
    });
</script>
{% endblock %} 