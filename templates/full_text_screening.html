{% extends "base.html" %}

{% block title %}Full-Text Screening - AI Literature Screening Assistant{% endblock %}

{% block extra_head %}
<style>
    /* Add some specific styles for the file list */
    #batch_selected_files_list .list-group-item {
        font-size: 0.85em; /* Smaller font for file list items */
        padding: 0.5rem 0.75rem; /* Adjust padding */
    }
    #batch_selected_files_list .remove-file-btn {
        font-size: 1.1em; /* Make remove button slightly larger */
        line-height: 1;
        padding: 0.1rem 0.3rem;
    }
</style>
{% endblock %}

{% block content %}
{# --- Full-Text Screening Section (Single PDF) --- #}
<div class="section-card">
    <h2>Screen Full Text (Single PDF)</h2>
    <p>Upload a single PDF document to screen its full text against the current criteria.</p>
    <div class="alert alert-warning small">
        <strong>Warning:</strong> Screening full text can be slow, costly (uses many API tokens), and may exceed LLM context limits, potentially leading to errors or incomplete analysis. Use judiciously.
    </div>
    <form method="POST" action="{{ url_for('screen_pdf_decision') }}" enctype="multipart/form-data" id="pdf_screen_form">
        <div class="form-group">
            <label for="pdf_file">Upload PDF File:</label>
            <input type="file" name="pdf_file" id="pdf_file" class="form-control-file form-control-sm" required accept=".pdf">
        </div>
         <button id="start_pdf_screen_button" type="submit" class="btn btn-warning btn-sm">
            <span id="pdf_spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
            Screen PDF Full Text
        </button>
    </form>
</div>

{# --- NEW: Batch Full-Text PDF Screening Section --- #}
<div class="section-card">
    <h2>Batch Screen Full Text (Multiple PDFs)</h2>
    <p>Upload multiple PDF documents to screen their full text. You can filter which PDFs to process by filename or their order in the uploaded list.</p>
    <div class="alert alert-info small">
        <strong>Note:</strong> This is a batch operation. Ensure your API key and criteria are correctly set. Progress will be shown live. No individual PDF previews during this batch process.
    </div>
    <form id="batch_pdf_screen_form" enctype="multipart/form-data">
        <div class="form-group">
            <label for="batch_pdf_files_input_control">Upload PDF Files (select multiple):</label>
            <input type="file" name="batch_pdf_files_input_control" id="batch_pdf_files_input_control" class="form-control-file form-control-sm" required accept=".pdf" multiple>
        </div>

        <div id="batch_selected_files_preview_area" class="mb-2" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <strong>Selected files (<span id="batch_selected_files_count">0</span>):</strong>
                <button type="button" id="batch_clear_all_files_button" class="btn btn-outline-secondary btn-sm">Clear All</button>
            </div>
            <ul id="batch_selected_files_list" class="list-group list-group-flush border rounded" style="max-height: 180px; overflow-y: auto;">
                <!-- Selected files will be listed here -->
            </ul>
        </div>

        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="batch_pdf_title_filter">Filter by Filename (Optional):</label>
                <input type="text" id="batch_pdf_title_filter" name="batch_pdf_title_filter" class="form-control form-control-sm" placeholder="Enter keywords from filename">
            </div>
            <div class="form-group col-md-6">
                <label for="batch_pdf_order_filter">Filter by Upload Order (Optional, 1-based):</label>
                <input type="text" id="batch_pdf_order_filter" name="batch_pdf_order_filter" class="form-control form-control-sm" placeholder="e.g., 1-5, 7, 10-">
            </div>
        </div>
        <small class="form-text text-muted mb-2">If both filename and order filters are filled, filename filter will take precedence.</small>

        <button id="start_batch_pdf_screen_button" type="button" class="btn btn-danger btn-sm">
            <span id="batch_pdf_spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
            Start Batch PDF Screening
        </button>
    </form>

    <div id="batch_pdf_progress_area" class="mt-3" style="display: none;">
        <h4>Batch PDF Screening Progress:</h4>
        <div class="progress mb-2">
            <div id="batch_pdf_progress_bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <p id="batch_pdf_progress_status" class="mt-1 small text-muted"></p>
        <div id="batch_pdf_progress_log_container" style="display:none;">
            <strong>Live Log (Batch PDF):</strong>
            <div id="batch_pdf_progress_log" style="max-height: 150px; overflow-y: auto; font-size: 0.8em; background-color: #f0f0f0; padding: 8px; border: 1px solid #ccc; margin-top:8px; border-radius: 4px; white-space: pre-line;"></div>
        </div>
    </div>
    <div id="batch_pdf_results_link_area" class="mt-3" style="display:none;">
        <a href="#" id="view_batch_pdf_results_link" class="btn btn-success">View Batch PDF Screening Results</a> 
    </div>
</div>
{# --- END NEW Batch Section --- #}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- PDF Screening Spinner Logic (Single PDF) --- 
    const pdfScreenForm = document.getElementById('pdf_screen_form');
    const pdfScreenButton = document.getElementById('start_pdf_screen_button');
    const pdfSpinner = document.getElementById('pdf_spinner');
    if (pdfScreenForm && pdfScreenButton && pdfSpinner) {
        pdfScreenForm.addEventListener('submit', function() {
            const pdfFileInput = document.getElementById('pdf_file');
            if (pdfFileInput && pdfFileInput.files.length > 0) {
                pdfSpinner.style.display = 'inline-block';
                pdfScreenButton.disabled = true;
            }
        });
    }

    // --- Batch PDF Screening Logic --- 
    const batchPdfFilesInputControl = document.getElementById('batch_pdf_files_input_control');
    const selectedFilesPreviewArea = document.getElementById('batch_selected_files_preview_area');
    const selectedFilesList = document.getElementById('batch_selected_files_list');
    const selectedFilesCountSpan = document.getElementById('batch_selected_files_count');
    const clearAllFilesButton = document.getElementById('batch_clear_all_files_button');
    const startBatchPdfScreenButton = document.getElementById('start_batch_pdf_screen_button');
    
    let currentBatchFiles = [];

    function updateSelectedFilesUI() {
        selectedFilesList.innerHTML = ''; // Clear previous list
        if (currentBatchFiles.length > 0) {
            selectedFilesPreviewArea.style.display = 'block';
            currentBatchFiles.forEach((file, index) => {
                const listItem = document.createElement('li');
                listItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                listItem.textContent = file.name;
                
                const removeButton = document.createElement('button');
                removeButton.classList.add('btn', 'btn-outline-danger', 'btn-sm', 'remove-file-btn');
                removeButton.innerHTML = '&times;';
                removeButton.type = 'button';
                removeButton.title = 'Remove file';

                removeButton.addEventListener('click', function() {
                    currentBatchFiles.splice(index, 1); // Remove file from array by index
                    updateSelectedFilesUI(); // Re-render the list
                });
                
                listItem.appendChild(removeButton);
                selectedFilesList.appendChild(listItem);
            });
        } else {
            selectedFilesPreviewArea.style.display = 'none';
        }
        selectedFilesCountSpan.textContent = currentBatchFiles.length;
        // Reset the actual file input so if user re-selects, 'change' event fires correctly.
        // This is important if user clears all and then wants to select the same set of files again.
        batchPdfFilesInputControl.value = ""; 
    }

    if (batchPdfFilesInputControl) {
        batchPdfFilesInputControl.addEventListener('change', function(event) {
            currentBatchFiles = Array.from(event.target.files); 
            updateSelectedFilesUI();
        });
    }

    if (clearAllFilesButton) {
        clearAllFilesButton.addEventListener('click', function() {
            currentBatchFiles = [];
            updateSelectedFilesUI();
        });
    }

    if (startBatchPdfScreenButton) {
        startBatchPdfScreenButton.addEventListener('click', function() {
            const batchTitleFilterInput = document.getElementById('batch_pdf_title_filter');
            const batchOrderFilterInput = document.getElementById('batch_pdf_order_filter');

            if (currentBatchFiles.length === 0) { // Check our managed list
                alert('Please select one or more PDF files for batch screening.');
                return;
            }

            // UI Reset and Setup for Batch PDF Progress
            const batchProgressArea = document.getElementById('batch_pdf_progress_area');
            const batchProgressBar = document.getElementById('batch_pdf_progress_bar');
            const batchProgressStatus = document.getElementById('batch_pdf_progress_status');
            const batchLogContainer = document.getElementById('batch_pdf_progress_log_container');
            const batchLog = document.getElementById('batch_pdf_progress_log');
            const batchResultsLinkArea = document.getElementById('batch_pdf_results_link_area');

            if(batchProgressArea) batchProgressArea.style.display = 'block';
            if(batchLogContainer) batchLogContainer.style.display = 'block';
            if(batchLog) batchLog.innerHTML = ''; // Clear previous log
            if(batchProgressBar) { batchProgressBar.style.width = '0%'; batchProgressBar.textContent = '0%'; batchProgressBar.classList.remove('bg-success', 'bg-danger'); batchProgressBar.classList.add('bg-info'); }
            if(batchProgressStatus) batchProgressStatus.textContent = 'Initializing batch PDF screening...';
            if(batchResultsLinkArea) batchResultsLinkArea.style.display = 'none';
            startBatchPdfScreenButton.disabled = true;
            const batchSpinner = document.getElementById('batch_pdf_spinner');
            if(batchSpinner) batchSpinner.style.display = 'inline-block';

            const formData = new FormData();
            // Append files from our managed currentBatchFiles array
            currentBatchFiles.forEach(file => {
                formData.append('batch_pdf_files', file); 
            });

            if (batchTitleFilterInput.value) {
                formData.append('batch_pdf_title_filter', batchTitleFilterInput.value.trim());
            }
            if (batchOrderFilterInput.value) {
                formData.append('batch_pdf_order_filter', batchOrderFilterInput.value.trim());
            }

            const xhrBatchPdf = new XMLHttpRequest();
            xhrBatchPdf.open("POST", "{{ url_for('batch_screen_pdfs_stream_placeholder') }}", true); 
            let lastBatchCharIndex = 0;

            xhrBatchPdf.onprogress = function() {
                const newText = xhrBatchPdf.responseText.substring(lastBatchCharIndex);
                lastBatchCharIndex = xhrBatchPdf.responseText.length;
                const messages = newText.split('\n\n');
                messages.forEach(message => {
                    if (message.startsWith("data: ")) {
                        try {
                            const jsonData = JSON.parse(message.substring(6));
                            if (jsonData.type === 'start') {
                                if(batchProgressStatus) batchProgressStatus.textContent = `Starting... Total files to process: ${jsonData.total_to_process} out of ${jsonData.total_uploaded} uploaded.`;
                                if(batchLog) batchLog.innerHTML += `<div>[${new Date().toLocaleTimeString()}] Batch Started. Files to process: ${jsonData.total_to_process}. Filter: ${jsonData.filter_info || 'none'}</div>`;
                            } else if (jsonData.type === 'progress') {
                                if (batchProgressBar) {
                                    batchProgressBar.style.width = jsonData.percentage + '%';
                                    batchProgressBar.textContent = jsonData.percentage + '%';
                                }
                                if (batchProgressStatus) {
                                    batchProgressStatus.textContent = `Processing ${jsonData.current_file_name} (${jsonData.count}/${jsonData.total_to_process})...`;
                                }
                                if(batchLog) batchLog.innerHTML += `<div>[${new Date().toLocaleTimeString()}] File ${jsonData.count}/${jsonData.total_to_process}: ${jsonData.current_file_name} - ${jsonData.decision || 'Processing...'}</div>`;
                                if(batchLog) batchLog.scrollTop = batchLog.scrollHeight; 
                            } else if (jsonData.type === 'complete') {
                                if(batchProgressBar) {batchProgressBar.classList.remove('bg-info'); batchProgressBar.classList.add('bg-success'); batchProgressBar.textContent = "Complete";}
                                if(batchProgressStatus) batchProgressStatus.textContent = jsonData.message;
                                if(batchLog) batchLog.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${jsonData.message}</div>`;
                                if (jsonData.batch_session_id && batchResultsLinkArea) {
                                    let baseUrl = "{{ url_for('show_batch_pdf_results_placeholder', batch_session_id='__BATCH_ID__') }}";
                                    document.getElementById('view_batch_pdf_results_link').href = baseUrl.replace('__BATCH_ID__', jsonData.batch_session_id);
                                    batchResultsLinkArea.style.display = 'block';
                                }
                                xhrBatchPdf.abort();
                            } else if (jsonData.type === 'error') {
                                if(batchProgressBar) {batchProgressBar.classList.remove('bg-info'); batchProgressBar.classList.add('bg-danger'); batchProgressBar.textContent = "Error";}
                                if(batchProgressStatus) batchProgressStatus.textContent = `Error: ${jsonData.message}`;
                                if(batchLog) batchLog.innerHTML += `<div class="text-danger">[${new Date().toLocaleTimeString()}] Error: ${jsonData.message}</div>`;
                                if (jsonData.needs_config) {
                                    const configUrl = "{{ url_for('llm_config_page') }}";
                                    if(batchLog) batchLog.innerHTML += `<div>Please <a href="${configUrl}" target="_blank">configure API Key</a>.</div>`;
                                }
                                xhrBatchPdf.abort();
                            }
                        } catch (e) { 
                            console.error("Batch PDF SSE Parse Error:", e, message); 
                            if(batchLog) batchLog.innerHTML += `<div class="text-danger">[${new Date().toLocaleTimeString()}] Error parsing server message.</div>`;
                        } 
                    }
                });
            };
            xhrBatchPdf.onloadend = function() { 
                startBatchPdfScreenButton.disabled = false; 
                if(batchSpinner) batchSpinner.style.display = 'none'; 
            }; 
            xhrBatchPdf.onerror = function() { 
                startBatchPdfScreenButton.disabled = false; 
                if(batchSpinner) batchSpinner.style.display = 'none'; 
                if(batchLog) batchLog.innerHTML += `<div class="text-danger">[${new Date().toLocaleTimeString()}] Connection error during batch screening.</div>`;
            }; 
            xhrBatchPdf.send(formData);
        });
    }
});
</script>
{% endblock %} 