{% extends "base.html" %}

{% block title %}Test Screening Results & Assessment - AI Literature Screening Assistant{% endblock %}

{% block extra_head %}
<style>
    /* .container-fluid in base.html is .container, adjust if full width is strictly needed */
    /* body { padding-top: 20px; padding-bottom: 20px; } */ /* From base.html */
    .container { max-width: 1200px; } /* Override base.html container width for this page if needed */
    .abstract-text { font-size: 0.85rem; max-height: 150px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #eee; margin-top:5px;}
    .ai-reasoning { font-size: 0.8rem; color: #555; white-space: pre-wrap; }
    .table th, .table td { vertical-align: middle; font-size: 0.9rem;}
    .decision-group label { margin-right: 10px; font-weight: normal; cursor:pointer;}
    .decision-group .form-check-input {cursor:pointer;}
    .badge-include { background-color: #28a745; color: white; }
    .badge-exclude { background-color: #dc3545; color: white; }
    .badge-maybe { background-color: #ffc107; color: black; }
    .badge-error { background-color: #6c757d; color: white; } /* For unparsed/error AI decisions */
    .table thead th { position: sticky; top: 0px; background-color: #343a40; color:white; z-index: 1;} /* Adjusted top for fixed navbar */
    .from-local-storage-notice {
        background-color: #f8d7da;
        color: #721c24;
        padding: 10px 15px;
        margin-bottom: 15px;
        border-radius: 4px;
        border: 1px solid #f5c6cb;
    }
    .storage-warning-icon {
        font-size: 1.2em;
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Test Screening Sample Assessment</h1>
        {# Consider making this button point to screening_actions_page #}
        <div><a href="{{ url_for('screening_actions_page') }}" class="btn btn-secondary btn-sm">Back to Screening Actions</a></div> 
    </div>

    {% if from_local_storage %}
    <div class="from-local-storage-notice">
        <i class="fas fa-exclamation-triangle storage-warning-icon"></i>
        Viewing results from browser local storage. Server session data is not available.
        {% if not session_id %}
        <div class="mt-2 small">
            <strong>Note:</strong> Some assessment features might be limited as this is restored from local storage.
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if test_items %}
        <!-- ADDED: Display filter information for Test Results -->
        {% if filter_applied and filter_applied != 'all entries' %}
            <p class="mb-1 text-muted font-italic small">Filter applied before sampling: {{ filter_applied }}</p>
        {% endif %}
        <!-- END ADDED -->
        <p>Review AI's decisions for <strong>{{ test_items|length }}</strong> sampled item(s) and provide your assessment. Then click "Calculate Metrics & Compare".</p>

        <form action="{{ url_for('calculate_metrics_route') }}" method="post" id="assessment-form">
            {% if session_id %}
            <input type="hidden" name="test_session_id" value="{{ session_id }}">
            {% else %}
            <!-- Hidden field to pass test items data through the form when from local storage -->
            <input type="hidden" name="local_test_items" id="local-test-items-data" value="">
            {% endif %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="width: 25%;">Title</th>
                            <th style="width: 35%;">Abstract</th>
                            <th style="width: 15%;">AI Decision</th>
                            <th style="width: 20%;">Your Decision</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in test_items %}
                        <tr>
                            <td class="text-center">{{ loop.index }}</td>
                            <td>
                                <strong>{{ item.title }}</strong><br>
                                <small class="text-muted">{{ item.authors }}</small>
                            </td>
                            <td>
                                <div class="abstract-text">{{ item.abstract }}</div>
                                <div class="mt-2">
                                    <a class="btn btn-sm btn-outline-secondary" data-toggle="collapse" href="#reasoning-{{ item.id }}" role="button" aria-expanded="false">
                                        AI Reasoning <i class="fas fa-chevron-down"></i>
                                    </a>
                                    <div class="collapse mt-2" id="reasoning-{{ item.id }}">
                                        <div class="ai-reasoning">{{ item.ai_reasoning }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="badge badge-{{ item.ai_decision.lower() if item.ai_decision in ['INCLUDE', 'EXCLUDE', 'MAYBE'] else 'error' }}">
                                    {{ item.ai_decision }}
                                </span>
                            </td>
                            <td>
                                <div class="decision-group">
                                    {% if item.ai_decision not in ['API_ERROR', 'ITEM_ERROR', 'CONFIG_ERROR'] %}
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="decision-{{ item.id }}" id="include-{{ item.id }}" value="INCLUDE">
                                        <label class="form-check-label" for="include-{{ item.id }}">Include</label>
                                    </div><br>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="decision-{{ item.id }}" id="maybe-{{ item.id }}" value="MAYBE">
                                        <label class="form-check-label" for="maybe-{{ item.id }}">Maybe</label>
                                    </div><br>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="decision-{{ item.id }}" id="exclude-{{ item.id }}" value="EXCLUDE">
                                        <label class="form-check-label" for="exclude-{{ item.id }}">Exclude</label>
                                    </div>
                                    {% else %}
                                    <span class="text-danger">Cannot assess due to AI error</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="text-center mt-4 mb-5">
                <button type="submit" class="btn btn-primary" id="calculate-metrics-btn">Calculate Metrics & Compare</button>
            </div>
        </form>

    {% else %}
        <div class="alert alert-warning">
            No test items found to display. Please return to the screening page and try again.
        </div>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // For local storage-based results, prepare to submit the test items with the form
    {% if from_local_storage and not session_id %}
    const assessmentForm = document.getElementById('assessment-form');
    const localTestItemsField = document.getElementById('local-test-items-data');
    
    if (assessmentForm && localTestItemsField) {
        // Save the test items data as JSON in the hidden field
        const testItemsData = {{ test_items|tojson }};
        localTestItemsField.value = JSON.stringify(testItemsData);
        
        // Override the form submission to handle local data
        assessmentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Collect user decisions
            const userDecisions = [];
            const testItems = {{ test_items|tojson }};
            
            testItems.forEach(item => {
                const radioName = `decision-${item.id}`;
                const selectedRadio = document.querySelector(`input[name="${radioName}"]:checked`);
                
                if (selectedRadio) {
                    userDecisions.push({
                        id: item.id,
                        ai_decision: item.ai_decision,
                        human_decision: selectedRadio.value,
                        title: item.title
                    });
                }
            });
            
            // If no decisions made, alert user
            if (userDecisions.length === 0) {
                alert('Please make at least one decision before calculating metrics.');
                return;
            }
            
            // Store the collected data in localStorage for the metrics page
            localStorage.setItem('local_assessment_data', JSON.stringify({
                test_items: testItems,
                user_decisions: userDecisions,
                timestamp: new Date().toISOString()
            }));
            
            // Redirect to a special local metrics calculation page
            window.location.href = '{{ url_for("calculate_metrics_route") }}?from_local=true';
        });
    }
    {% endif %}
});
</script>
{% endblock %}