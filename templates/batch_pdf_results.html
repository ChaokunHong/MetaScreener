{% extends "base.html" %}

{% block title %}Batch PDF Screening Results - {{ batch_info.filename if batch_info else 'Batch' }} {% endblock %}

{% block extra_head %}
<style>
    .table th, .table td {
        vertical-align: middle; 
        font-size: 0.9rem;
    }
    /* Styling for the Filename column (2nd child in the table row) */
    .table td:nth-child(2),
    .table th:nth-child(2) {
        max-width: 300px; /* Adjust as needed */
        word-wrap: break-word; /* Allows breaking long words */
        white-space: normal; /* Ensures text wraps normally */
        overflow-wrap: break-word; /* More robust word breaking */
    }

    .reasoning-text { 
        font-size: 0.85rem; 
        color: #555; 
        max-width: 350px; /* Adjust as needed */
        white-space: pre-wrap; /* Keep for reasoning to preserve formatting from LLM */
        word-break: break-word;
        overflow-wrap: break-word;
    }
    .decision-INCLUDE { color: green; font-weight: bold; }
    .decision-EXCLUDE { color: red; font-weight: bold; }
    .decision-MAYBE { color: orange; font-weight: bold; }
    .decision-ERROR, .decision-TEXT_EXTRACT_ERROR, .decision-PROMPT_ERROR, .decision-PROCESSING_ERROR, .decision-WORKER_ERROR, .decision-API_ERROR, .decision-WORKER_THREAD_ERROR, .decision-FILE_PROCESSING_ERROR {
        color: purple; font-weight: bold;
    }
    .table-responsive {max-height: 70vh; overflow-y: auto;}
    .table thead th { position: sticky; top: 0; background-color: #343a40; color: white; z-index: 1;}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ batch_info.filename if batch_info else 'Batch PDF Screening Results' }}</h1>
        <a href="{{ url_for('full_text_screening_page') }}" class="btn btn-secondary btn-sm">Back to Full-Text Screening</a>
    </div>

    {% if batch_info and batch_info.results %}
        <div class="row mb-3">
            <div class="col-md-8">
                <p class="mb-1">
                    Screened {{ batch_info.results|length }} PDF file(s).
                    {% if batch_info.filter_applied and batch_info.filter_applied != 'all uploaded files' %}
                        <br><small class="text-muted">Filter applied: {{ batch_info.filter_applied }}</small>
                    {% endif %}
                </p>
            </div>
            <div class="col-md-4">
                {# --- NEW: Decision Statistics Summary --- #}
                {% if decision_counts %}
                <h6>Summary:</h6>
                <ul class="list-unstyled list-inline" style="font-size: 0.9em;">
                    {% for decision, count in decision_counts.items() %}
                        {% if count > 0 %}
                            <li class="list-inline-item">
                                <span class="decision-{{ decision }}">{{ decision.replace('_',' ') }}:</span> {{ count }}
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
                {% endif %}
                {# --- END NEW: Decision Statistics Summary --- #}
            </div>
        </div>
        
        <!-- NEW: Download Section for Batch PDF Results -->
        <div class="mt-3 mb-3 d-flex align-items-center">
            <label for="batchDownloadFormat" class="mr-2 mb-0">Download format:</label>
            <select id="batchDownloadFormat" class="form-control form-control-sm mr-2" style="width: 150px;">
                <option value="csv">CSV</option>
                <option value="xlsx">Excel (.xlsx)</option>
                <option value="json">JSON</option>
            </select>
            <button id="batchDownloadButton" class="btn btn-primary btn-sm">Download Batch Results</button>
            <!-- Hidden input to store batch_id passed from backend -->
            <input type="hidden" id="batch-id-holder" value="{{ batch_id if batch_id else '' }}">
       </div>
        <!-- END NEW Download Section -->

        <div class="table-responsive mt-3">
            <table class="table table-striped table-bordered table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>#</th>
                        <th>Filename</th>
                        <th>Decision</th>
                        <th>Reasoning</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in batch_info.results %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ result.title_for_display if result.title_for_display else result.filename }}</td>
                        <td><span class="decision-{{ result.decision }}">{{ result.decision }}</span></td>
                        <td><span class="reasoning-text">{{ result.reasoning }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-warning mt-3">
            No results found for this batch (ID: {{ batch_id }}), or the results have expired.
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const batchDownloadButton = document.getElementById('batchDownloadButton');
    const batchDownloadFormatSelect = document.getElementById('batchDownloadFormat');
    const batchIdHolder = document.getElementById('batch-id-holder');

    if (batchDownloadButton && batchDownloadFormatSelect && batchIdHolder) {
        batchDownloadButton.addEventListener('click', function() {
            const format = batchDownloadFormatSelect.value;
            const batchId = batchIdHolder.value;

            if (!batchId) {
                alert('Error: Cannot generate download link (missing batch screening ID).');
                return;
            }
            if (!format) {
                 alert('Please select a download format.');
                 return;
            }

            // Construct the download URL
            // Ensure a unique endpoint name for this new download route
            let baseUrl = "{{ url_for('download_batch_pdf_results_placeholder', batch_session_id='__BATCH_ID__', format='__FORMAT__') }}";
            let downloadUrl = baseUrl.replace('__BATCH_ID__', batchId).replace('__FORMAT__', format);

            // Initiate download by navigating to the URL
            window.location.href = downloadUrl;
        });
    }
});
</script>
{% endblock %} 