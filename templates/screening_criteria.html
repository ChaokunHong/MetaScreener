{% extends "base.html" %}

{% block title %}Screening Criteria - AI Literature Screening Assistant{% endblock %}

{% block extra_head %}
<style>
    /* Basic/Advanced Toggle Styles */
    .mode-toggle label { margin-right: 15px; font-weight: normal; cursor: pointer; }
    .mode-toggle input[type="radio"] { margin-right: 5px; }
    /* Hide advanced sections by default */
    .advanced-settings { display: none; }
    /* Styling for prompt setting textareas */
    .prompt-textarea { 
        font-family: monospace; 
        font-size: 0.85rem; 
        min-height: 100px; 
        background-color: #e9ecef; 
        border: 1px solid #ced4da;
    }
    .advanced-warning {
        font-size: 0.9em;
        color: #dc3545; /* Bootstrap danger color */
        border-left: 3px solid #dc3545;
        padding-left: 10px;
        margin-top: 15px;
    }
    /* Keep other styles from base if needed, or add specific ones */
    .criteria-section { margin-bottom: 0; border-radius:0; border-left:0; border-right:0; border-top:0; } /* Remove individual section borders for accordion items */
    .criteria-section:first-of-type { border-top: 1px solid rgba(0,0,0,.125); }
    .card-header {
        padding: .75rem 1.25rem;
        background-color: #f7f7f9; /* Lighter header for accordion */
    }
    .card-header .btn-link {
        font-size: 1.1rem; /* Match .pico-label more closely */
        font-weight: bold;
        text-decoration: none;
        color: #333;
        width: 100%;
        text-align: left;
        padding: 0;
    }
    .card-header .btn-link:hover {
        text-decoration: none;
    }
    .card-header .btn-link:focus {
        box-shadow: none;
    }
    .card .card-body {
        padding-top: 1rem; /* Add some padding to the body of the card */
    }
    .pico-label { /* Styles for this class might be mostly handled by btn-link now */
        display: inline; /* If still used within button */
    }
    /* Ensure textareas still have some bottom margin */
    .criteria-subsection textarea { margin-bottom: 1rem; }
    .criteria-subsection:last-child textarea { margin-bottom: 0.5rem; }
</style>
{% endblock %}

{% block content %}
<div class="section-card">
    <h2>Screening Criteria & AI Settings</h2>
    
    <!-- Mode Toggle -->
    <div class="form-group mode-toggle">
        <label>
            <input type="radio" name="criteria_mode" value="basic" checked> Basic Mode (Recommended)
        </label>
        <label>
            <input type="radio" name="criteria_mode" value="advanced"> Advanced Mode
        </label>
        <p class="text-muted small">Basic mode provides guided input. Advanced mode allows customizing PICOT structure detail and AI prompt instructions (use with caution).</p>
    </div>
    <hr>

    <!-- AI Best Practices Tips (Always Visible) -->
    <div class="best-practices">
        <h5>Tips for Effective Criteria:</h5>
        <ul>
            <li><strong>Be Specific:</strong> Use precise terms (e.g., "patients aged 18-65" instead of "adults").</li>
            <li><strong>Be Clear:</strong> Use bullet points or short phrases. Define ambiguous terms if necessary.</li>
            <li><strong>Focus on Abstract:</strong> Write criteria based on information typically found in an abstract.</li>
            <li><strong>Be Consistent:</strong> Avoid contradictory statements between inclusion and exclusion fields.</li>
        </ul>
    </div>

    <form method="POST" action="{{ url_for('set_criteria') }}">
        
        <h3 class="mt-4">PICOT Criteria</h3>
        <div class="accordion" id="picotAccordion">
            {# MODIFIED Macro for Include/Exclude/Maybe within an Accordion structure #}
            {% macro criteria_accordion_item(field_prefix, pico_element, pico_desc, parent_id, is_first=false) %}
            <div class="card">
                <div class="card-header" id="heading{{ field_prefix.upper() }}">
                    <h2 class="mb-0">
                        <button class="btn btn-link btn-block text-left {% if not is_first %}collapsed{% endif %}" type="button" data-toggle="collapse" data-target="#collapse{{ field_prefix.upper() }}" aria-expanded="{{ 'true' if is_first else 'false' }}" aria-controls="collapse{{ field_prefix.upper() }}">
                            {{ pico_element }} - {{ pico_desc }}
                        </button>
                    </h2>
                </div>
                <div id="collapse{{ field_prefix.upper() }}" class="collapse {% if is_first %}show{% endif %}" aria-labelledby="heading{{ field_prefix.upper() }}" data-parent="#{{ parent_id }}">
                    <div class="card-body criteria-section">
                        <div class="criteria-subsection">
                            <label for="{{ field_prefix }}_include">What characteristics related to {{ pico_desc.lower() }} *must* be present to INCLUDE?</label>
                            <textarea name="{{ field_prefix }}_include" id="{{ field_prefix }}_include" class="form-control" rows="2" 
                                      placeholder="e.g., For Population: patients over 65...">{{ criteria[field_prefix+'_include'] if criteria and criteria[field_prefix+'_include'] else '' }}</textarea>
                        </div>
                         <div class="criteria-subsection">
                            <label for="{{ field_prefix }}_exclude">What characteristics related to {{ pico_desc.lower() }} *must NOT* be present (i.e., lead to EXCLUDE)?</label>
                            <textarea name="{{ field_prefix }}_exclude" id="{{ field_prefix }}_exclude" class="form-control" rows="2" 
                                      placeholder="e.g., For Population: pediatric patients...">{{ criteria[field_prefix+'_exclude'] if criteria and criteria[field_prefix+'_exclude'] else '' }}</textarea>
                        </div>
                         <div class="criteria-subsection">
                            <label for="{{ field_prefix }}_maybe">What missing or unclear details about {{ pico_desc.lower() }} in the abstract would lead to a 'MAYBE' decision?</label>
                            <textarea name="{{ field_prefix }}_maybe" id="{{ field_prefix }}_maybe" class="form-control" rows="2" 
                                      placeholder="e.g., For Population: specific age range unclear...">{{ criteria[field_prefix+'_maybe'] if criteria and criteria[field_prefix+'_maybe'] else '' }}</textarea>
                            <small class="form-text text-muted">Focus on information needed for a clear decision that might be missing in the abstract.</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endmacro %}

            {{ criteria_accordion_item('p', 'P', 'Population/Patient/Problem', parent_id='picotAccordion', is_first=true) }}
            {{ criteria_accordion_item('i', 'I', 'Intervention', parent_id='picotAccordion') }}
            {{ criteria_accordion_item('c', 'C', 'Comparison', parent_id='picotAccordion') }}
            {{ criteria_accordion_item('o', 'O', 'Outcome', parent_id='picotAccordion') }}
            {{ criteria_accordion_item('t', 'T', 'Time / Study Type', parent_id='picotAccordion') }}

            {# --- Other Criteria as an Accordion Item --- #}
            <div class="card">
                <div class="card-header" id="headingOther">
                    <h2 class="mb-0">
                        <button class="btn btn-link btn-block text-left collapsed" type="button" data-toggle="collapse" data-target="#collapseOther" aria-expanded="false" aria-controls="collapseOther">
                            Other General Criteria
                        </button>
                    </h2>
                </div>
                <div id="collapseOther" class="collapse" aria-labelledby="headingOther" data-parent="#picotAccordion">
                    <div class="card-body criteria-section">
                        <div class="form-group criteria-subsection">
                             <label for="other_inclusion">Other Specific Inclusion Criteria:</label>
                             <textarea name="other_inclusion" id="other_inclusion" class="form-control" rows="3" placeholder="List any other essential criteria for inclusion not covered by PICOT.">{{ criteria.other_inclusion if criteria and criteria.other_inclusion else '' }}</textarea>
                        </div>
                         <div class="form-group criteria-subsection">
                             <label for="other_exclusion">Other Specific Exclusion Criteria:</label>
                             <textarea name="other_exclusion" id="other_exclusion" class="form-control" rows="3" placeholder="List any other specific criteria for exclusion not covered by PICOT.">{{ criteria.other_exclusion if criteria and criteria.other_exclusion else '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div> {# End Accordion #}
        
        {# --- Advanced AI Prompt Settings Section --- #}
        <div class="advanced-settings mt-4">
            <hr>
            <h3>Advanced AI Prompt Settings</h3>
             <p class="text-muted">Modify how the AI is instructed. Changes can significantly impact performance and reliability.</p>
            
            <div class="form-group">
                <label for="ai_system_prompt">AI System Prompt / Role:</label>
                <textarea name="ai_system_prompt" id="ai_system_prompt" class="form-control prompt-textarea" rows="4">{{ criteria.ai_system_prompt if criteria and criteria.ai_system_prompt else config_defaults.DEFAULT_SYSTEM_PROMPT }}</textarea> {# Assuming defaults passed from backend #}
                 <small class="form-text text-muted">Define the overall role or persona for the AI assistant (e.g., "You are an AI assistant for medical literature screening...").</small>
            </div>

            <div class="form-group">
                <label for="ai_output_format_instructions">AI Output Format Instructions:</label>
                <textarea name="ai_output_format_instructions" id="ai_output_format_instructions" class="form-control prompt-textarea" rows="5">{{ criteria.ai_output_format_instructions if criteria and criteria.ai_output_format_instructions else config_defaults.DEFAULT_OUTPUT_INSTRUCTIONS }}</textarea> {# Assuming defaults passed #}
                <small class="form-text text-muted">Instruct the AI on how exactly to format its response (e.g., the LABEL: and Justification: structure). Use {abstract} and {criteria} placeholders where needed within the main prompt structure this instruction is part of.</small>
            </div>
            
             <div class="advanced-warning">
                <strong>Warning:</strong> Modifying these prompts incorrectly can lead to unpredictable AI behavior, poor screening results, or errors. Proceed with caution and test thoroughly after changes.
            </div>
        </div>
        
        {# --- Buttons --- #}
        <div class="mt-4">
            <button type="submit" class="btn btn-success btn-sm">Save Criteria & Settings</button>
            <a href="{{ url_for('reset_criteria') }}" class="btn btn-warning btn-sm">Reset to Defaults</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modeRadios = document.querySelectorAll('input[name="criteria_mode"]');
    const advancedSettingsDiv = document.querySelector('.advanced-settings');

    function toggleAdvancedSettings() {
        if (document.querySelector('input[name="criteria_mode"]:checked').value === 'advanced') {
            advancedSettingsDiv.style.display = 'block';
        } else {
            advancedSettingsDiv.style.display = 'none';
        }
    }

    modeRadios.forEach(radio => {
        radio.addEventListener('change', toggleAdvancedSettings);
    });

    // Initial check in case the page loads with advanced selected (e.g., after validation error)
    toggleAdvancedSettings(); 
});
</script>
{% endblock %} 