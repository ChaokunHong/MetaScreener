{% extends "base.html" %}

{% block title %}Screening Criteria - AI Literature Screening Assistant{% endblock %}

{% block extra_head %}
<style>
    /* Basic/Advanced Toggle Styles */
    .mode-toggle label { margin-right: 15px; font-weight: normal; cursor: pointer; }
    .mode-toggle input[type="radio"] { margin-right: 5px; }
    /* Hide advanced sections by default */
    .advanced-settings { display: none; }
    /* Styling for prompt setting textareas */
    .prompt-textarea { 
        font-family: monospace; 
        font-size: 0.85rem; 
        min-height: 100px; 
        background-color: #e9ecef; 
        border: 1px solid #ced4da;
    }
    .advanced-warning {
        font-size: 0.9em;
        color: #dc3545; /* Bootstrap danger color */
        border-left: 3px solid #dc3545;
        padding-left: 10px;
        margin-top: 15px;
    }
    /* Consistent card styling */
    .criteria-section { 
        margin-bottom: 0; 
        border-radius: 0; 
        border-left: 0; 
        border-right: 0; 
        border-top: 0; 
    } 
    .criteria-section:first-of-type { border-top: 1px solid rgba(0,0,0,.125); }
    
    /* Card header styling */
    .card-header {
        padding: .75rem 1.25rem;
        background-color: rgba(123, 44, 191, 0.05); /* Light purple header for accordion */
        border-bottom: 1px solid rgba(123, 44, 191, 0.1);
    }
    .card-header .btn-link {
        font-size: 1.1rem;
        font-weight: bold;
        text-decoration: none;
        color: #333;
        width: 100%;
        text-align: left;
        padding: 0;
    }
    .card-header .btn-link:hover {
        text-decoration: none;
        color: #007bff;
    }
    .card-header .btn-link:focus {
        box-shadow: none;
    }
    .card .card-body {
        padding: 1.25rem;
    }
    
    /* Textarea and form field styles */
    .criteria-subsection textarea { 
        margin-bottom: 1.25rem; 
        border-color: #ced4da;
    }
    .criteria-subsection:last-child textarea { 
        margin-bottom: 0.75rem; 
    }
    .textarea-is-placeholder {
        color: #999;
    }
    
    /* Section styling */
    .section-container {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .section-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #495057;
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 0.5rem;
    }
    
    /* Buttons styling - using site variables for consistent branding */
    .btn {
        border-radius: 6px;
        font-weight: 500;
        padding: 0.375rem 0.75rem;
        transition: all 0.2s ease;
    }
    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    .btn-primary:hover {
        background-color: var(--hover-color);
        border-color: var(--hover-color);
        transform: translateY(-1px);
    }
    .btn-success {
        background-color: var(--success-color);
        border-color: var(--success-color);
    }
    .btn-success:hover {
        background-color: #057857;
        border-color: #057857;
        transform: translateY(-1px);
    }
    .btn-info {
        background-color: var(--info-color);
        border-color: var(--info-color);
    }
    .btn-info:hover {
        background-color: #2563eb;
        border-color: #2563eb;
        transform: translateY(-1px);
    }
    .btn-warning {
        background-color: var(--warning-color);
        border-color: var(--warning-color);
        color: #212529;
    }
    .btn-warning:hover {
        background-color: #c77700;
        border-color: #c77700;
        color: #212529;
        transform: translateY(-1px);
    }
    .btn-danger {
        background-color: var(--danger-color);
        border-color: var(--danger-color);
    }
    .btn-danger:hover {
        background-color: #b91c1c;
        border-color: #b91c1c;
        transform: translateY(-1px);
    }
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    .btn-lg {
        padding: 0.5rem 1rem;
        font-size: 1.1rem;
    }
    
    /* Help buttons and popovers */
    .help-button {
        padding: 0;
        color: #6c757d;
        font-size: 1.1rem;
        margin-left: 10px;
        cursor: pointer;
        transition: color 0.2s;
    }
    .help-button:hover {
        color: #007bff;
        text-decoration: none;
    }
    .popover {
        max-width: 500px;
        white-space: pre-wrap;
        font-size: 0.9rem;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    .popover-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: bold;
        color: #495057;
        padding: 0.75rem 1rem;
    }
    .popover-body {
        padding: 1rem;
        line-height: 1.5;
        color: #212529;
        background-color: #fff;
    }
    
    /* Subsection styles */
    .criteria-subsection {
        margin-bottom: 1.5rem;
    }
    .criteria-subsection:last-child {
        margin-bottom: 0.5rem;
    }
    
    /* Best practices box */
    .best-practices {
        background-color: rgba(155, 93, 229, 0.05);
        border-left: 4px solid var(--primary-color);
        padding: 1rem;
        margin: 1.5rem 0;
        border-radius: 0 8px 8px 0;
    }
    .best-practices h5 {
        color: var(--primary-color);
        margin-bottom: 0.75rem;
    }
    .best-practices ul {
        margin-bottom: 0;
    }
    .best-practices li {
        margin-bottom: 0.5rem;
    }
    .best-practices li:last-child {
        margin-bottom: 0;
    }
    
    /* Framework selection area */
    .framework-selection-container {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1.5rem;
    }
    
    /* Action buttons area */
    .action-buttons-container {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e9ecef;
    }
    
    /* Enhanced action buttons */
    .btn-action {
        font-weight: 600;
        letter-spacing: 0.5px;
        border-radius: 6px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        font-size: 0.95rem;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 8px rgba(0,123,255,0.3) !important;
    }
    
    .btn-action-secondary {
        font-weight: 500;
        border-radius: 6px;
        transition: all 0.3s ease;
        font-size: 0.85rem;
    }
    
    .btn-action-secondary:hover {
        background-color: rgba(220,53,69,0.1);
    }
    
    @media (max-width: 767.98px) {
        .btn-action, .btn-action-secondary {
            display: block;
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="section-card">
    <h2 class="mb-4">Screening Criteria & AI Settings</h2>
    
    <!-- Mode Toggle -->
    <div class="form-group mode-toggle mb-4">
        <label class="mr-3">
            <input type="radio" name="criteria_mode" value="basic" checked> Basic Mode (Recommended)
        </label>
        <label>
            <input type="radio" name="criteria_mode" value="advanced"> Advanced Mode
        </label>
        <p class="text-muted small mt-2 mb-0">Basic mode provides guided input. Advanced mode allows customizing criteria structure and AI prompt instructions (use with caution).</p>
    </div>
    <hr class="mb-4">

    <!-- Framework Selection -->
    <div class="framework-selection-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <label for="framework_select" class="mb-0"><strong>Choose Criteria Framework:</strong></label>
            <button type="button" class="btn btn-link help-button" data-toggle="popover" data-placement="right" data-trigger="click" title="Framework Selection Guide" data-content="<strong>PICOT</strong>: Standard for clinical intervention studies. Use for treatment efficacy evaluations.<br><br><strong>PICOS</strong>: Extension of PICOT with emphasis on study design. Ideal for systematic reviews.<br><br><strong>PECO</strong>: For epidemiological/exposure studies examining risk factors without interventions.<br><br><strong>PICOC</strong>: Adds context consideration. Appropriate when setting is important to study relevance.<br><br><strong>SPIDER</strong>: Designed for qualitative research. Use when exploring experiences, views, or social phenomena.<br><br><strong>ECLIPSE</strong>: For health service/management questions. Focuses on service delivery rather than clinical outcomes.<br><br><strong>CLIP</strong>: For rehabilitation/therapy studies. Emphasizes client characteristics and professional roles.<br><br><strong>BeHEMoTh</strong>: For theory-based interventions. Use when examining behavior change models or theoretical frameworks.">
                <i class="fas fa-question-circle"></i>
            </button>
        </div>
        <select id="framework_select" name="framework_id" class="form-control" onchange="onFrameworkChange(this.value)">
            {% if supported_frameworks is defined %}
                {% for fw_id, fw_conf in supported_frameworks.items() %}
                    <option value="{{ fw_id }}" {% if fw_id == current_framework_id %}selected{% endif %}>{{ fw_conf.display_name }}</option>
                {% endfor %}
            {% endif %}
        </select>
    </div>

    <!-- AI Best Practices Tips (Always Visible) -->
    <div class="best-practices">
        <h5><i class="fas fa-lightbulb mr-2"></i>Tips for Effective Criteria:</h5>
        <ul class="pl-3">
            <li><strong>Be Specific:</strong> Use precise terms (e.g., "patients aged 18-65" instead of "adults").</li>
            <li><strong>Be Clear:</strong> Use bullet points or short phrases. Define ambiguous terms if necessary.</li>
            <li><strong>Focus on Abstract:</strong> Write criteria based on information typically found in an abstract.</li>
            <li><strong>Be Consistent:</strong> Avoid contradictory statements between inclusion and exclusion fields.</li>
        </ul>
    </div>

    <form method="POST" action="{{ url_for('set_criteria') }}" id="criteriaForm">
        <!-- Saved Criteria Management -->
        <div class="section-container">
            <div class="section-title">Manage Saved Criteria Sets</div>
            <div class="row align-items-end">
                <div class="col-md-8">
                    <div class="form-group mb-md-0">
                        <label for="saved_criteria_select" class="sr-only">Load Saved Criteria:</label>
                        <div class="input-group">
                            <select id="saved_criteria_select" class="form-control" title="Select a saved criteria set to load or manage">
                                <option value="">-- Select a saved criteria set --</option>
                            </select>
                            <div class="input-group-append">
                                <button type="button" id="load_criteria_button" class="btn btn-info">Load</button>
                                <button type="button" id="update_loaded_local_set_button" class="btn btn-success" style="display:none;">Update</button>
                                <button type="button" id="delete_criteria_button" class="btn btn-danger" style="display:none;">Delete</button>
                            </div>
                        </div>
                        <small id="loaded_set_name_display" class="form-text text-muted mt-2" style="display:none;">Form currently shows: <strong></strong> (unsaved changes unless updated/applied)</small>
                    </div>
                </div>
                <div class="col-md-4 text-md-right mt-3 mt-md-0">
                     <button type="button" id="save_criteria_as_button" class="btn btn-success"><i class="fas fa-save mr-1"></i>Save as New Set</button>
                </div>
            </div>
        </div>
        
        <!-- Criteria Sections -->
        <div class="section-container">
            <h3 class="mb-4">{% if supported_frameworks is defined and current_framework_id in supported_frameworks %}{{ supported_frameworks[current_framework_id].display_name }}{% else %}Screening{% endif %} Criteria</h3>

            {# Macro for generating include/exclude/maybe accordions dynamically #}
            {% macro criteria_accordion_item(field_prefix, element_label, element_desc, parent_id, is_first=false) %}
            <div class="card mb-3">
                <div class="card-header" id="heading{{ field_prefix | upper }}">
                    <h2 class="mb-0">
                        <button class="btn btn-link btn-block text-left {% if not is_first %}collapsed{% endif %}" type="button" data-toggle="collapse" data-target="#collapse{{ field_prefix | upper }}" aria-expanded="{{ 'true' if is_first else 'false' }}" aria-controls="collapse{{ field_prefix | upper }}">
                            {{ element_label }} - {{ element_desc }}
                        </button>
                    </h2>
                </div>
                <div id="collapse{{ field_prefix | upper }}" class="collapse {% if is_first %}show{% endif %}" aria-labelledby="heading{{ field_prefix | upper }}" data-parent="#{{ parent_id }}">
                    <div class="card-body criteria-section">
                        <div class="criteria-subsection">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label for="{{ field_prefix }}_include" class="mb-0">What characteristics related to {{ element_desc.lower() }} <em>must</em> be present to INCLUDE?</label>
                                <button type="button" class="btn btn-link help-button" data-toggle="popover" data-trigger="click" data-placement="right" title="Include Criteria Examples & Tips" data-content="{{ default_framework_criteria.get(field_prefix ~ '_include', '') | replace('"', '&quot;') | replace('\n', '<br>') | safe }}">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                            </div>
                            <textarea name="{{ field_prefix }}_include" id="{{ field_prefix }}_include" class="form-control" rows="3">{{ criteria.get(field_prefix ~ '_include', '') }}</textarea>
                        </div>
                        <div class="criteria-subsection">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label for="{{ field_prefix }}_exclude" class="mb-0">What characteristics related to {{ element_desc.lower() }} <em>must NOT</em> be present (EXCLUDE)?</label>
                                <button type="button" class="btn btn-link help-button" data-toggle="popover" data-trigger="click" data-placement="right" title="Exclude Criteria Examples & Tips" data-content="{{ default_framework_criteria.get(field_prefix ~ '_exclude', '') | replace('"', '&quot;') | replace('\n', '<br>') | safe }}">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                            </div>
                            <textarea name="{{ field_prefix }}_exclude" id="{{ field_prefix }}_exclude" class="form-control" rows="3">{{ criteria.get(field_prefix ~ '_exclude', '') }}</textarea>
                        </div>
                        <div class="criteria-subsection">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label for="{{ field_prefix }}_maybe" class="mb-0">What missing or unclear details about {{ element_desc.lower() }} would lead to a 'MAYBE' decision?</label>
                                <button type="button" class="btn btn-link help-button" data-toggle="popover" data-trigger="click" data-placement="right" title="Maybe Criteria Examples & Tips" data-content="{{ default_framework_criteria.get(field_prefix ~ '_maybe', '') | replace('"', '&quot;') | replace('\n', '<br>') | safe }}">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                            </div>
                            <textarea name="{{ field_prefix }}_maybe" id="{{ field_prefix }}_maybe" class="form-control" rows="3">{{ criteria.get(field_prefix ~ '_maybe', '') }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
            {% endmacro %}

            <div class="accordion" id="criteriaAccordion">
                {% if supported_frameworks is defined and current_framework_id in supported_frameworks %}
                    {% for element in supported_frameworks[current_framework_id]['elements'] %}
                        {% if element.id != 'other' %}
                            {{ criteria_accordion_item(element.id, element.id|upper, element.name, parent_id='criteriaAccordion', is_first=loop.first) }}
                        {% endif %}
                    {% endfor %}
                {% endif %}
                
                <!-- Other General Criteria -->
                <div class="card mb-3">
                    <div class="card-header" id="headingOther">
                        <h2 class="mb-0">
                            <button class="btn btn-link btn-block text-left collapsed" type="button" data-toggle="collapse" data-target="#collapseOther" aria-expanded="false" aria-controls="collapseOther">
                                Other General Criteria
                            </button>
                        </h2>
                    </div>
                    <div id="collapseOther" class="collapse" aria-labelledby="headingOther" data-parent="#criteriaAccordion">
                        <div class="card-body criteria-section">
                            <div class="form-group criteria-subsection">
                                <label for="other_inclusion" class="mb-2">Other Specific Inclusion Criteria:</label>
                                <textarea name="other_inclusion" id="other_inclusion" class="form-control" rows="3" placeholder="List any other essential criteria for inclusion not covered by the selected framework.">{{ criteria.other_inclusion if criteria and criteria.other_inclusion else '' }}</textarea>
                            </div>
                            <div class="form-group criteria-subsection">
                                <label for="other_exclusion" class="mb-2">Other Specific Exclusion Criteria:</label>
                                <textarea name="other_exclusion" id="other_exclusion" class="form-control" rows="3" placeholder="List any other specific criteria for exclusion not covered by the selected framework.">{{ criteria.other_exclusion if criteria and criteria.other_exclusion else '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Advanced AI Prompt Settings Section -->
        <div class="advanced-settings section-container">
            <div class="section-title">Advanced AI Prompt Settings</div>
            <p class="text-muted mb-4">Modify how the AI is instructed. Changes can significantly impact performance and reliability.</p>
            
            <div class="form-group">
                <label for="ai_system_prompt" class="mb-2">AI System Prompt / Role:</label>
                <textarea name="ai_system_prompt" id="ai_system_prompt" class="form-control prompt-textarea criteria-field-for-placeholder" rows="4">{{ criteria.ai_system_prompt if criteria and criteria.ai_system_prompt else config_defaults.DEFAULT_SYSTEM_PROMPT }}</textarea>
                <small class="form-text text-muted">Define the overall role or persona for the AI assistant.</small>
            </div>

            <div class="form-group">
                <label for="ai_output_format_instructions" class="mb-2">AI Output Format Instructions:</label>
                <textarea name="ai_output_format_instructions" id="ai_output_format_instructions" class="form-control prompt-textarea criteria-field-for-placeholder" rows="5">{{ criteria.ai_output_format_instructions if criteria and criteria.ai_output_format_instructions else config_defaults.DEFAULT_OUTPUT_INSTRUCTIONS }}</textarea>
                <small class="form-text text-muted">Instruct the AI on its response format. Use {abstract} placeholder.</small>
            </div>
            
            <div class="advanced-warning mt-4">
                <strong>Warning:</strong> Modifying these prompts incorrectly can lead to unpredictable AI behavior, poor screening results, or errors. Proceed with caution and test thoroughly after changes.
            </div>
        </div>
        
        <!-- Main Action Buttons -->
        <div class="action-buttons-container">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="d-flex flex-column flex-md-row justify-content-center">
                        <button type="submit" class="btn btn-primary" name="submit_action" value="save_and_apply">
                            <i class="fas fa-check-circle mr-2"></i>Apply Criteria for Screening
                        </button>
                        <a href="{{ url_for('reset_criteria') }}" class="btn btn-outline-danger mt-3 mt-md-0 ml-md-3">
                            <i class="fas fa-undo mr-1"></i>Reset to Defaults
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
const CRITERIA_SETS_KEY = 'metaScreenerCriteriaSets';
let currentlyLoadedSetName = null; 
let formDirty = false; 

function onFrameworkChange(newFw){
    if(!newFw) return;
    // Reload page with selected framework param
    const url = new URL(window.location.href);
    url.searchParams.set('framework_id', newFw);
    window.location.href = url.toString();
}

// Prepare dynamic prefixes list from server-side
const elementPrefixes = {% if element_prefixes is defined %}{{ element_prefixes | tojson }}{% else %}[]{% endif %};
function getAllCriteriaFieldIds() {
    const suffixes = ['include','exclude','maybe'];
    let ids = [];
    elementPrefixes.forEach(p => suffixes.forEach(s => ids.push(`${p}_${s}`)));
    ids.push('other_inclusion','other_exclusion','ai_system_prompt','ai_output_format_instructions');
    return ids;
}

const allCriteriaFields = getAllCriteriaFieldIds().map(id => document.getElementById(id)).filter(el => el);

function setFormDirty(isDirty) {
    formDirty = isDirty;
    updateButtonStates(); 
}

allCriteriaFields.forEach(field => {
    if(field) {
        field.addEventListener('input', () => {
            setFormDirty(true);
        });
    }
});

function updateButtonStates() {
    const select = document.getElementById('saved_criteria_select');
    const updateButton = document.getElementById('update_loaded_local_set_button');
    const deleteButton = document.getElementById('delete_criteria_button');
    const loadedSetNameDisplay = document.getElementById('loaded_set_name_display');
    
    if (!select || !updateButton || !deleteButton || !loadedSetNameDisplay) return;

    const selectedValueInDropdown = select.value;
    const loadedSetNameDisplayStrong = loadedSetNameDisplay.querySelector('strong');

    if (currentlyLoadedSetName && loadedSetNameDisplayStrong) {
        loadedSetNameDisplay.style.display = 'inline';
        loadedSetNameDisplayStrong.textContent = currentlyLoadedSetName;
        updateButton.style.display = 'inline-block';
        updateButton.disabled = !formDirty; 
        deleteButton.style.display = (selectedValueInDropdown === currentlyLoadedSetName) ? 'inline-block' : 'none';
    } else {
        loadedSetNameDisplay.style.display = 'none';
        updateButton.style.display = 'none';
        updateButton.disabled = true;
        deleteButton.style.display = selectedValueInDropdown ? 'inline-block' : 'none';
    }
}

function populateSavedCriteriaDropdown() {
    const select = document.getElementById('saved_criteria_select');
    if(!select) return;
    const criteriaSets = JSON.parse(localStorage.getItem(CRITERIA_SETS_KEY) || '{}');
    const currentSelectedValueInDropdown = select.value;
    select.innerHTML = '<option value="">-- Select a saved criteria set --</option>';
    for (const name in criteriaSets) {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        if (name === currentSelectedValueInDropdown && criteriaSets[name]) {
             option.selected = true;
        }
        select.appendChild(option);
    }
    if (currentlyLoadedSetName && criteriaSets[currentlyLoadedSetName]){
        select.value = currentlyLoadedSetName;
    }
    updateButtonStates(); 
}

function saveCriteriaToLocalStorage(setName, showOverwriteConfirm = true) {
    let criteriaSets = JSON.parse(localStorage.getItem(CRITERIA_SETS_KEY) || '{}');
    if (showOverwriteConfirm && criteriaSets[setName]) {
        if (!confirm(`A local criteria set named '${setName}' already exists. Overwrite it?`)) {
            return false;
        }
    }
    const currentCriteria = {};
    getAllCriteriaFieldIds().forEach(id => {
        const element = document.getElementById(id);
        if (element) currentCriteria[id] = element.value;
    });
    criteriaSets[setName] = currentCriteria;
    localStorage.setItem(CRITERIA_SETS_KEY, JSON.stringify(criteriaSets));
    return true;
}

document.addEventListener('DOMContentLoaded', function() {
    const saveBtn = document.getElementById('save_criteria_as_button');
    if(saveBtn) {
        saveBtn.addEventListener('click', function() {
            const setName = prompt("Enter a name for this local criteria set (new or to overwrite):");
            if (!setName || setName.trim() === '') {
                alert("Criteria set name cannot be empty.");
                return;
            }
            const trimmedSetName = setName.trim();
            if (saveCriteriaToLocalStorage(trimmedSetName)) {
                alert(`Criteria set '${trimmedSetName}' saved to local storage!`);
                currentlyLoadedSetName = trimmedSetName;
                setFormDirty(false);
                populateSavedCriteriaDropdown(); 
                updateButtonStates(); 
            }
        });
    }

    const loadBtn = document.getElementById('load_criteria_button');
    if(loadBtn) {
        loadBtn.addEventListener('click', function() {
            const select = document.getElementById('saved_criteria_select');
            if(!select) return;
            const setName = select.value;
            if (!setName) { alert("Please select a criteria set to load."); return; }
            const criteriaSets = JSON.parse(localStorage.getItem(CRITERIA_SETS_KEY) || '{}');
            const selectedCriteria = criteriaSets[setName];
            if (selectedCriteria) {
                getAllCriteriaFieldIds().forEach(id => {
                    const element = document.getElementById(id);
                    if (element && selectedCriteria[id] !== undefined) {
                        element.value = selectedCriteria[id];
                    }
                });
                currentlyLoadedSetName = setName;
                setFormDirty(false); 
                updateButtonStates();
                alert(`Criteria set '${setName}' loaded into the form. If you wish to use these for screening, click 'Apply Criteria for Screening'.`);
            } else { alert("Error: Could not find the selected criteria set."); }
        });
    }

    const updateLoadedBtn = document.getElementById('update_loaded_local_set_button');
    if(updateLoadedBtn) {
        updateLoadedBtn.addEventListener('click', function(){
            if (!currentlyLoadedSetName) {
                alert("Error: No criteria set is currently active in the form to update.");
                return;
            }
            if (saveCriteriaToLocalStorage(currentlyLoadedSetName, false)) { 
                alert(`Locally saved criteria set '${currentlyLoadedSetName}' updated successfully!`);
                setFormDirty(false); 
                updateButtonStates(); 
            } else {
                alert("Error: Failed to update the local criteria set."); 
            }
        });
    }

    const deleteBtn = document.getElementById('delete_criteria_button');
    if(deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            const select = document.getElementById('saved_criteria_select');
            if(!select) return;
            const setName = select.value;
            if (!setName) { alert("Please select a criteria set to delete from the dropdown."); return; }
            if (confirm(`Are you sure you want to delete the locally saved criteria set '${setName}'? This cannot be undone.`)) {
                let criteriaSets = JSON.parse(localStorage.getItem(CRITERIA_SETS_KEY) || '{}');
                delete criteriaSets[setName];
                localStorage.setItem(CRITERIA_SETS_KEY, JSON.stringify(criteriaSets));
                alert(`Criteria set '${setName}' deleted successfully!`);
                if (currentlyLoadedSetName === setName) { 
                    currentlyLoadedSetName = null;
                    setFormDirty(true); 
                }
                populateSavedCriteriaDropdown(); 
            }
        });
    }

    const modeRadios = document.querySelectorAll('input[name="criteria_mode"]');
    const advancedSettingsDiv = document.querySelector('.advanced-settings');

    function toggleAdvancedSettings() {
        if(document.querySelector('input[name="criteria_mode"]:checked') && advancedSettingsDiv){
            if (document.querySelector('input[name="criteria_mode"]:checked').value === 'advanced') {
                advancedSettingsDiv.style.display = 'block';
            } else {
                advancedSettingsDiv.style.display = 'none';
            }
        }
    }
    if(modeRadios.length > 0 && advancedSettingsDiv){
        modeRadios.forEach(radio => radio.addEventListener('change', toggleAdvancedSettings));
        toggleAdvancedSettings(); 
    }

    populateSavedCriteriaDropdown();

    if (typeof $ !== 'undefined' && typeof $.fn.popover !== 'undefined') {
        try {
            $('[data-toggle="popover"]').popover({
                html: true,        
                sanitize: false,   
                trigger: 'click',  
                container: 'body'
            });

            $(document).on('click', function (e) {
                let isPopoverClick = $(e.target).closest('[data-toggle="popover"]').length > 0;
                let isInsidePopover = $(e.target).closest('.popover.show').length > 0;

                if (!isPopoverClick && !isInsidePopover) {
                    $('[data-toggle="popover"]').popover('hide');
                }
            });
            
            $('[data-toggle="popover"]').on('show.bs.popover', function () {
                $('[data-toggle="popover"]').not(this).popover('hide');
            });
        } catch (popoverError) {
            console.error("Error during Popover initialization:", popoverError);
        }
    } else {
        console.error("jQuery or Bootstrap Popover not loaded");
    }
});
</script>
{% endblock %} 