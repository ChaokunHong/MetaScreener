{% extends "base.html" %}

{% block title %}Screening Criteria - AI Literature Screening Assistant{% endblock %}

{% block extra_head %}
<style>
    /* Basic/Advanced Toggle Styles */
    .mode-toggle label { margin-right: 15px; font-weight: normal; cursor: pointer; }
    .mode-toggle input[type="radio"] { margin-right: 5px; }
    /* Hide advanced sections by default */
    .advanced-settings { display: none; }
    /* Styling for prompt setting textareas */
    .prompt-textarea { 
        font-family: monospace; 
        font-size: 0.85rem; 
        min-height: 100px; 
        background-color: #e9ecef; 
        border: 1px solid #ced4da;
    }
    .advanced-warning {
        font-size: 0.9em;
        color: #dc3545; /* Bootstrap danger color */
        border-left: 3px solid #dc3545;
        padding-left: 10px;
        margin-top: 15px;
    }
    /* Keep other styles from base if needed, or add specific ones */
    .criteria-section { margin-bottom: 0; border-radius:0; border-left:0; border-right:0; border-top:0; } /* Remove individual section borders for accordion items */
    .criteria-section:first-of-type { border-top: 1px solid rgba(0,0,0,.125); }
    .card-header {
        padding: .75rem 1.25rem;
        background-color: #f7f7f9; /* Lighter header for accordion */
    }
    .card-header .btn-link {
        font-size: 1.1rem; /* Match .pico-label more closely */
        font-weight: bold;
        text-decoration: none;
        color: #333;
        width: 100%;
        text-align: left;
        padding: 0;
    }
    .card-header .btn-link:hover {
        text-decoration: none;
    }
    .card-header .btn-link:focus {
        box-shadow: none;
    }
    .card .card-body {
        padding-top: 1rem; /* Add some padding to the body of the card */
    }
    .pico-label { /* Styles for this class might be mostly handled by btn-link now */
        display: inline; /* If still used within button */
    }
    /* Ensure textareas still have some bottom margin */
    .criteria-subsection textarea { margin-bottom: 1rem; }
    .criteria-subsection:last-child textarea { margin-bottom: 0.5rem; }
    .textarea-is-placeholder {
        color: #999; /* Lighter grey for placeholder text */
        /* font-style: italic; /* Optional: make placeholder italic */
    }
    /* Added styles for help buttons and popovers */
    .help-button {
        padding: 0;
        color: #6c757d;
        font-size: 1.1rem;
        margin-left: 10px;
        cursor: pointer;
    }
    .help-button:hover {
        color: #007bff;
        text-decoration: none;
    }
    .popover {
        max-width: 500px;
        white-space: pre-wrap;
        font-size: 0.9rem;
    }
    .popover-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: bold;
        color: #495057;
    }
    .popover-body {
        padding: 12px;
        line-height: 1.5;
        color: #212529;
        background-color: #fff;
    }
    .criteria-subsection {
        margin-bottom: 1.5rem;
    }
    .criteria-subsection:last-child {
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="section-card">
    <h2>Screening Criteria & AI Settings</h2>
    
    <!-- Mode Toggle -->
    <div class="form-group mode-toggle">
        <label>
            <input type="radio" name="criteria_mode" value="basic" checked> Basic Mode (Recommended)
        </label>
        <label>
            <input type="radio" name="criteria_mode" value="advanced"> Advanced Mode
        </label>
        <p class="text-muted small">Basic mode provides guided input. Advanced mode allows customizing PICOT structure detail and AI prompt instructions (use with caution).</p>
    </div>
    <hr>

    <!-- AI Best Practices Tips (Always Visible) -->
    <div class="best-practices">
        <h5>Tips for Effective Criteria:</h5>
        <ul>
            <li><strong>Be Specific:</strong> Use precise terms (e.g., "patients aged 18-65" instead of "adults").</li>
            <li><strong>Be Clear:</strong> Use bullet points or short phrases. Define ambiguous terms if necessary.</li>
            <li><strong>Focus on Abstract:</strong> Write criteria based on information typically found in an abstract.</li>
            <li><strong>Be Consistent:</strong> Avoid contradictory statements between inclusion and exclusion fields.</li>
        </ul>
    </div>

    <form method="POST" action="{{ url_for('set_criteria') }}" id="criteriaForm">
        <div class="row mt-3 mb-4 align-items-end">
            <div class="col-md-7">
                <h5>Manage Locally Saved Criteria Sets</h5>
                <div class="form-group">
                    <label for="saved_criteria_select" class="sr-only">Load Saved Criteria:</label>
                    <div class="input-group input-group-sm">
                        <select id="saved_criteria_select" class="form-control form-control-sm" title="Select a saved criteria set to load or manage">
                            <option value="">-- Select a set --</option>
                        </select>
                        <div class="input-group-append">
                            <button type="button" id="load_criteria_button" class="btn btn-info btn-sm">Load to Form</button>
                            <button type="button" id="update_loaded_local_set_button" class="btn btn-outline-success btn-sm" style="display:none;">Update Loaded Local Set</button>
                            <button type="button" id="delete_criteria_button" class="btn btn-outline-danger btn-sm" style="display:none;">Delete Selected Local Set</button>
                        </div>
                    </div>
                    <small id="loaded_set_name_display" class="form-text text-muted" style="display:none;">Form currently shows: <strong></strong> (unsaved local changes unless updated/applied)</small>
                </div>
            </div>
            <div class="col-md-5 text-md-right">
                 <button type="button" id="save_criteria_as_button" class="btn btn-success btn-sm">Save Form as New Local Set...</button>
            </div>
        </div>
        <hr>
        <h3 class="mt-4">PICOT Criteria</h3>
        <div class="accordion" id="picotAccordion">
            {# MODIFIED Macro for Include/Exclude/Maybe within an Accordion structure #}
            {% macro criteria_accordion_item(field_prefix, pico_element, pico_desc, parent_id, is_first=false) %}
            <div class="card">
                <div class="card-header" id="heading{{ field_prefix.upper() }}">
                    <h2 class="mb-0">
                        <button class="btn btn-link btn-block text-left {% if not is_first %}collapsed{% endif %}" type="button" data-toggle="collapse" data-target="#collapse{{ field_prefix.upper() }}" aria-expanded="{{ 'true' if is_first else 'false' }}" aria-controls="collapse{{ field_prefix.upper() }}">
                            {{ pico_element }} - {{ pico_desc }}
                        </button>
                    </h2>
                </div>
                <div id="collapse{{ field_prefix.upper() }}" class="collapse {% if is_first %}show{% endif %}" aria-labelledby="heading{{ field_prefix.upper() }}" data-parent="#{{ parent_id }}">
                    <div class="card-body criteria-section">
                        <div class="criteria-subsection">
                            <div class="d-flex justify-content-between align-items-center">
                                <label for="{{ field_prefix }}_include">What characteristics related to {{ pico_desc.lower() }} *must* be present to INCLUDE?</label>
                                <button type="button" class="btn btn-link help-button" 
                                        data-toggle="popover" 
                                        data-trigger="click" 
                                        data-placement="right" 
                                        title="Include Criteria Examples & Tips" 
                                        data-content="{{ config_defaults.DEFAULT_PICOT_CRITERIA[field_prefix ~ '_include'] | replace('"', '&quot;') | replace('\n', '<br>') | safe }}">
                                    <i class="fas fa-question-circle"></i></button>
                            </div>
                            <textarea name="{{ field_prefix }}_include" id="{{ field_prefix }}_include" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="criteria-subsection">
                            <div class="d-flex justify-content-between align-items-center">
                                <label for="{{ field_prefix }}_exclude">What characteristics related to {{ pico_desc.lower() }} *must NOT* be present (i.e., lead to EXCLUDE)?</label>
                                <button type="button" class="btn btn-link help-button" 
                                        data-toggle="popover" 
                                        data-trigger="click" 
                                        data-placement="right" 
                                        title="Exclude Criteria Examples & Tips" 
                                        data-content="{{ config_defaults.DEFAULT_PICOT_CRITERIA[field_prefix ~ '_exclude'] | replace('"', '&quot;') | replace('\n', '<br>') | safe }}">
                                    <i class="fas fa-question-circle"></i></button>
                            </div>
                            <textarea name="{{ field_prefix }}_exclude" id="{{ field_prefix }}_exclude" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="criteria-subsection"> {# This is the _maybe subsection #}
                            <div class="d-flex justify-content-between align-items-center">
                                <label for="{{ field_prefix }}_maybe">What missing or unclear details about {{ pico_desc.lower() }} in the abstract would lead to a 'MAYBE' decision?</label>
                                <button type="button" class="btn btn-link help-button" 
                                        data-toggle="popover" 
                                        data-trigger="click" 
                                        data-placement="right" 
                                        title="Maybe Criteria Examples & Tips" 
                                        data-content="{{ config_defaults.DEFAULT_PICOT_CRITERIA[field_prefix ~ '_maybe'] | replace('"', '&quot;') | replace('\n', '<br>') | safe }}">
                                    <i class="fas fa-question-circle"></i></button>
                            </div>
                            <textarea name="{{ field_prefix }}_maybe" id="{{ field_prefix }}_maybe" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            {% endmacro %}

            {{ criteria_accordion_item('p', 'P', 'Population/Patient/Problem', parent_id='picotAccordion', is_first=true) }}
            {{ criteria_accordion_item('i', 'I', 'Intervention', parent_id='picotAccordion') }}
            {{ criteria_accordion_item('c', 'C', 'Comparison', parent_id='picotAccordion') }}
            {{ criteria_accordion_item('o', 'O', 'Outcome', parent_id='picotAccordion') }}
            {{ criteria_accordion_item('t', 'T', 'Time / Study Type', parent_id='picotAccordion') }}

            {# --- Other Criteria as an Accordion Item --- #}
            <div class="card">
                <div class="card-header" id="headingOther">
                    <h2 class="mb-0">
                        <button class="btn btn-link btn-block text-left collapsed" type="button" data-toggle="collapse" data-target="#collapseOther" aria-expanded="false" aria-controls="collapseOther">
                            Other General Criteria
                        </button>
                    </h2>
                </div>
                <div id="collapseOther" class="collapse" aria-labelledby="headingOther" data-parent="#picotAccordion">
                    <div class="card-body criteria-section">
                        <div class="form-group criteria-subsection">
                             <label for="other_inclusion">Other Specific Inclusion Criteria:</label>
                             <textarea name="other_inclusion" id="other_inclusion" class="form-control" rows="3" placeholder="List any other essential criteria for inclusion not covered by PICOT.">{{ criteria.other_inclusion if criteria and criteria.other_inclusion else '' }}</textarea>
                        </div>
                         <div class="form-group criteria-subsection">
                             <label for="other_exclusion">Other Specific Exclusion Criteria:</label>
                             <textarea name="other_exclusion" id="other_exclusion" class="form-control" rows="3" placeholder="List any other specific criteria for exclusion not covered by PICOT.">{{ criteria.other_exclusion if criteria and criteria.other_exclusion else '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div> {# End Accordion #}
        
        {# --- Advanced AI Prompt Settings Section --- #}
        <div class="advanced-settings mt-4">
            <hr>
            <h3>Advanced AI Prompt Settings</h3>
             <p class="text-muted">Modify how the AI is instructed. Changes can significantly impact performance and reliability.</p>
            
            <div class="form-group">
                <label for="ai_system_prompt">AI System Prompt / Role:</label>
                <textarea name="ai_system_prompt" id="ai_system_prompt" class="form-control prompt-textarea criteria-field-for-placeholder" rows="4">{{ criteria.ai_system_prompt if criteria and criteria.ai_system_prompt else config_defaults.DEFAULT_SYSTEM_PROMPT }}</textarea>
                 <small class="form-text text-muted">Define the overall role or persona for the AI assistant.</small>
            </div>

            <div class="form-group">
                <label for="ai_output_format_instructions">AI Output Format Instructions:</label>
                <textarea name="ai_output_format_instructions" id="ai_output_format_instructions" class="form-control prompt-textarea criteria-field-for-placeholder" rows="5">{{ criteria.ai_output_format_instructions if criteria and criteria.ai_output_format_instructions else config_defaults.DEFAULT_OUTPUT_INSTRUCTIONS }}</textarea>
                <small class="form-text text-muted">Instruct the AI on its response format. Use {abstract} placeholder.</small>
            </div>
            
             <div class="advanced-warning">
                <strong>Warning:</strong> Modifying these prompts incorrectly can lead to unpredictable AI behavior, poor screening results, or errors. Proceed with caution and test thoroughly after changes.
            </div>
        </div>
        
        {# --- Main Action Buttons --- #}
        <div class="mt-4">
            <button type="submit" class="btn btn-primary btn-lg" name="submit_action" value="save_and_apply">Apply Criteria for Screening</button>
            <a href="{{ url_for('reset_criteria') }}" class="btn btn-warning btn-sm ml-2">Reset to Server Defaults</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
const CRITERIA_SETS_KEY = 'metaScreenerCriteriaSets';
let currentlyLoadedSetName = null; 
let formDirty = false; 

function getAllCriteriaFieldIds() {
    const prefixes = ['p', 'i', 'c', 'o', 't'];
    const suffixes = ['include', 'exclude', 'maybe'];
    let ids = [];
    prefixes.forEach(p => suffixes.forEach(s => ids.push(`${p}_${s}`)));
    ids.push('other_inclusion', 'other_exclusion', 'ai_system_prompt', 'ai_output_format_instructions');
    return ids;
}

const allCriteriaFields = getAllCriteriaFieldIds().map(id => document.getElementById(id)).filter(el => el);

function setFormDirty(isDirty) {
    formDirty = isDirty;
    updateButtonStates(); 
}

allCriteriaFields.forEach(field => {
    if(field) {
        field.addEventListener('input', () => {
            setFormDirty(true);
        });
    }
});

function updateButtonStates() {
    const select = document.getElementById('saved_criteria_select');
    const updateButton = document.getElementById('update_loaded_local_set_button');
    const deleteButton = document.getElementById('delete_criteria_button');
    const loadedSetNameDisplayStrong = document.getElementById('loaded_set_name_display').querySelector('strong');
    const loadedSetNameDisplaySmall = document.getElementById('loaded_set_name_display');
    
    if (!select || !updateButton || !deleteButton || !loadedSetNameDisplayStrong || !loadedSetNameDisplaySmall) return;

    const selectedValueInDropdown = select.value;

    if (currentlyLoadedSetName) {
        loadedSetNameDisplaySmall.style.display = 'inline';
        loadedSetNameDisplayStrong.textContent = currentlyLoadedSetName;
        updateButton.style.display = 'inline-block';
        updateButton.disabled = !formDirty; 
        deleteButton.style.display = (selectedValueInDropdown === currentlyLoadedSetName) ? 'inline-block' : 'none';
    } else {
        loadedSetNameDisplaySmall.style.display = 'none';
        updateButton.style.display = 'none';
        updateButton.disabled = true;
        deleteButton.style.display = selectedValueInDropdown ? 'inline-block' : 'none';
    }
}

function populateSavedCriteriaDropdown() {
    const select = document.getElementById('saved_criteria_select');
    if(!select) return;
    const criteriaSets = JSON.parse(localStorage.getItem(CRITERIA_SETS_KEY) || '{}');
    const currentSelectedValueInDropdown = select.value;
    select.innerHTML = '<option value="">-- Select a local set --</option>';
    for (const name in criteriaSets) {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        if (name === currentSelectedValueInDropdown && criteriaSets[name]) {
             option.selected = true;
        }
        select.appendChild(option);
    }
    if (currentlyLoadedSetName && criteriaSets[currentlyLoadedSetName]){
        select.value = currentlyLoadedSetName;
    }
    updateButtonStates(); 
}

function saveCriteriaToLocalStorage(setName, showOverwriteConfirm = true) {
    let criteriaSets = JSON.parse(localStorage.getItem(CRITERIA_SETS_KEY) || '{}');
    if (showOverwriteConfirm && criteriaSets[setName]) {
        if (!confirm(`A local criteria set named '${setName}' already exists. Overwrite it?`)) {
            return false;
        }
    }
    const currentCriteria = {};
    getAllCriteriaFieldIds().forEach(id => {
        const element = document.getElementById(id);
        if (element) currentCriteria[id] = element.value;
    });
    criteriaSets[setName] = currentCriteria;
    localStorage.setItem(CRITERIA_SETS_KEY, JSON.stringify(criteriaSets));
    return true;
}

const saveBtn = document.getElementById('save_criteria_as_button');
if(saveBtn) {
    saveBtn.addEventListener('click', function() {
        const setName = prompt("Enter a name for this local criteria set (new or to overwrite):");
        if (!setName || setName.trim() === '') {
            alert("Criteria set name cannot be empty.");
            return;
        }
        const trimmedSetName = setName.trim();
        if (saveCriteriaToLocalStorage(trimmedSetName)) {
            alert(`Criteria set '${trimmedSetName}' saved to local storage!`);
            currentlyLoadedSetName = trimmedSetName;
            setFormDirty(false);
            populateSavedCriteriaDropdown(); 
            updateButtonStates(); 
        }
    });
}

const loadBtn = document.getElementById('load_criteria_button');
if(loadBtn) {
    loadBtn.addEventListener('click', function() {
        const select = document.getElementById('saved_criteria_select');
        if(!select) return;
        const setName = select.value;
        if (!setName) { alert("Please select a criteria set to load."); return; }
        const criteriaSets = JSON.parse(localStorage.getItem(CRITERIA_SETS_KEY) || '{}');
        const selectedCriteria = criteriaSets[setName];
        if (selectedCriteria) {
            getAllCriteriaFieldIds().forEach(id => {
                const element = document.getElementById(id);
                if (element && selectedCriteria[id] !== undefined) {
                    element.value = selectedCriteria[id];
                }
            });
            currentlyLoadedSetName = setName;
            setFormDirty(false); 
            updateButtonStates();
            alert(`Criteria set '${setName}' loaded into the form. If you wish to use these for screening, click 'Apply Criteria for Screening'.`);
        } else { alert("Error: Could not find the selected criteria set."); }
    });
}

const updateLoadedBtn = document.getElementById('update_loaded_local_set_button');
if(updateLoadedBtn) {
    updateLoadedBtn.addEventListener('click', function(){
        if (!currentlyLoadedSetName) {
            alert("Error: No criteria set is currently active in the form to update.");
            return;
        }
        if (saveCriteriaToLocalStorage(currentlyLoadedSetName, false)) { 
            alert(`Locally saved criteria set '${currentlyLoadedSetName}' updated successfully!`);
            setFormDirty(false); 
            updateButtonStates(); 
        } else {
            alert("Error: Failed to update the local criteria set."); 
        }
    });
}

const deleteBtn = document.getElementById('delete_criteria_button');
if(deleteBtn) {
    deleteBtn.addEventListener('click', function() {
        const select = document.getElementById('saved_criteria_select');
        if(!select) return;
        const setName = select.value;
        if (!setName) { alert("Please select a criteria set to delete from the dropdown."); return; }
        if (confirm(`Are you sure you want to delete the locally saved criteria set '${setName}'? This cannot be undone.`)) {
            let criteriaSets = JSON.parse(localStorage.getItem(CRITERIA_SETS_KEY) || '{}');
            delete criteriaSets[setName];
            localStorage.setItem(CRITERIA_SETS_KEY, JSON.stringify(criteriaSets));
            alert(`Criteria set '${setName}' deleted successfully!`);
            if (currentlyLoadedSetName === setName) { 
                currentlyLoadedSetName = null;
                setFormDirty(true); 
            }
            populateSavedCriteriaDropdown(); 
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const modeRadios = document.querySelectorAll('input[name="criteria_mode"]');
    const advancedSettingsDiv = document.querySelector('.advanced-settings');

    function toggleAdvancedSettings() {
        if(document.querySelector('input[name="criteria_mode"]:checked') && advancedSettingsDiv){
            if (document.querySelector('input[name="criteria_mode"]:checked').value === 'advanced') {
                advancedSettingsDiv.style.display = 'block';
            } else {
                advancedSettingsDiv.style.display = 'none';
            }
        }
    }
    if(modeRadios.length > 0 && advancedSettingsDiv){
        modeRadios.forEach(radio => radio.addEventListener('change', toggleAdvancedSettings));
        toggleAdvancedSettings(); 
    }

    populateSavedCriteriaDropdown();

    if (typeof $ !== 'undefined' && typeof $.fn.popover !== 'undefined') {
        try {
            $('[data-toggle="popover"]').popover({
                html: true,        
                sanitize: false,   
                trigger: 'click',  
                container: 'body', 
                template: '<div class="popover" role="tooltip"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>'
            });

            $(document).on('click', function (e) {
                let isPopoverClick = $(e.target).closest('[data-toggle="popover"]').length > 0;
                let isInsidePopover = $(e.target).closest('.popover.show').length > 0;

                if (!isPopoverClick && !isInsidePopover) {
                    $('[data-toggle="popover"]').popover('hide');
                }
            });
            
            $('[data-toggle="popover"]').on('show.bs.popover', function () {
                $('[data-toggle="popover"]').not(this).popover('hide');
            });
            console.log("Popovers initialized (or attempted to initialize) successfully.");

        } catch (popoverError) {
            console.error("Error during Popover initialization or event binding:", popoverError);
        }
    } else {
        console.error("jQuery or Bootstrap Popover not loaded, popovers will not work.");
    }
});

</script>
{% endblock %} 