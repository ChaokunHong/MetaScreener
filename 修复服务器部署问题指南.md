# 修复MetaScreener服务器部署问题指南

根据错误日志分析，您的应用程序在服务器上出现了两个主要问题：

## 1. 模板变量错误

Jinja2模板引擎显示错误：`'supported_frameworks' is undefined`。这是因为在渲染模板时，某些必需的变量未正确传递给模板引擎。

**已修复**：本地文件已经修改，添加了检测变量是否存在的条件，防止未定义变量错误。

## 2. 虚拟环境问题

出现错误：`Failed to locate executable /home/ubuntu/MetaScreener/venv/bin/gunicorn: No such file or directory`

这表明服务器上的虚拟环境已损坏或gunicorn可执行文件丢失。

### 修复虚拟环境的步骤

请在服务器上通过SSH执行以下命令：

```bash
# 连接到服务器
ssh ubuntu@your-server-ip

# 进入项目目录
cd /home/ubuntu/MetaScreener

# 备份当前的虚拟环境（如果有）
if [ -d "venv" ]; then
    mv venv venv_backup
fi

# 创建新的虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 安装所需的依赖项
pip install -r requirements.txt

# 确保gunicorn已安装
pip install gunicorn

# 重启服务
sudo systemctl restart metascreener.service

# 检查服务状态
sudo systemctl status metascreener.service
```

### 如果问题仍然存在

检查systemd服务配置文件是否正确：

```bash
# 查看服务配置
sudo cat /etc/systemd/system/metascreener.service

# 确保ExecStart路径正确指向虚拟环境中的gunicorn
# 应该类似：ExecStart=/home/ubuntu/MetaScreener/venv/bin/gunicorn app:app -b 127.0.0.1:5000
```

如果需要修改服务配置：

```bash
sudo nano /etc/systemd/system/metascreener.service

# 修改后重新加载服务配置
sudo systemctl daemon-reload
sudo systemctl restart metascreener.service
```

## 3. 检查应用日志以获取更多详细信息

如果服务启动但网站仍然无法访问，可以查看nginx配置和日志：

```bash
# 检查nginx配置
sudo nginx -t

# 查看nginx错误日志
sudo tail -n 100 /var/log/nginx/error.log

# 重启nginx
sudo systemctl restart nginx
```

## 4. 数据库或文件权限问题

如果应用程序启动但仍有功能问题，可能是文件权限或数据库配置问题：

```bash
# 检查项目目录的权限
sudo chown -R ubuntu:ubuntu /home/ubuntu/MetaScreener
sudo chmod -R 755 /home/ubuntu/MetaScreener

# 如果使用数据库，检查数据库连接配置
```

## 5. 确认python包版本

如果部署的环境与开发环境不同，可能需要确保兼容性：

```bash
# 激活虚拟环境
source /home/ubuntu/MetaScreener/venv/bin/activate

# 安装特定版本的包（如果需要）
pip install jinja2==3.1.6
pip install flask==2.0.1
```

通过以上步骤，您的应用程序应该能够在服务器上正常运行。如果仍有问题，请提供更详细的错误日志以便进一步诊断。 